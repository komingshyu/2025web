<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª”æ¡ˆæ—¥æœŸæ•´ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .step-indicator {
            display: flex;
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 10px;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active::after {
            background: #667eea;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: #667eea;
        }

        .step.completed .step-number {
            background: #28a745;
        }

        .step-title {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .step.active .step-title,
        .step.completed .step-title {
            color: #495057;
            font-weight: 600;
        }

        .content {
            padding: 30px;
        }

        .folder-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .folder-card {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
            position: relative;
        }

        .folder-card:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateY(-2px);
        }

        .folder-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f3ff 0%, #e8ecff 100%);
            border-style: solid;
        }

        .folder-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .folder-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .folder-path {
            font-size: 0.85rem;
            color: #6c757d;
            word-break: break-all;
        }

        .folder-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .date-option-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .date-option-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }

        .date-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .date-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .date-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f3ff 0%, #e8ecff 100%);
        }

        .date-option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .date-option-icon {
            font-size: 1.5rem;
        }

        .date-option-name {
            font-weight: 600;
            color: #495057;
        }

        .date-option-desc {
            font-size: 0.85rem;
            color: #6c757d;
            margin-left: 35px;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .date-option.selected .radio-custom {
            border-color: #667eea;
            background: #667eea;
        }

        .radio-custom::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .date-option.selected .radio-custom::after {
            opacity: 1;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }

        .file-preview {
            margin-top: 30px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .preview-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }

        .file-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f1f3f5;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 500;
            color: #495057;
        }

        .file-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .file-date-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .date-type-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .operation-type {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 20px;
            display: inline-block;
        }

        .progress-section {
            display: none;
            margin: 30px 0;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #495057;
        }

        .log-section {
            margin-top: 30px;
            display: none;
        }

        .log-section.active {
            display: block;
        }

        .log-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #17a2b8;
        }

        .log-move {
            color: #ff9800;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .processing {
            animation: pulse 1s infinite;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.info {
            border-left: 4px solid #17a2b8;
        }

        .info-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .info-note-icon {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .info-note-text {
            color: #856404;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .performance-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .performance-info.show {
            display: block;
        }

        .performance-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1976d2;
        }

        .performance-info-text {
            color: #0d47a1;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ æª”æ¡ˆæ—¥æœŸæ•´ç†å·¥å…·</h1>
            <p>è‡ªå‹•å°‡æª”æ¡ˆä¾ç…§å»ºç«‹æ—¥æœŸæˆ–ä¿®æ”¹æ—¥æœŸåˆ†é¡åˆ°å°æ‡‰çš„è³‡æ–™å¤¾</p>
        </header>

        <main class="main-card">
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">é¸æ“‡è¨­å®š</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">é è¦½æª”æ¡ˆ</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">åŸ·è¡Œæ•´ç†</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-title">å®Œæˆ</div>
                </div>
            </div>

            <div class="content">
                <!-- æ­¥é©Ÿ 1: é¸æ“‡è¨­å®š -->
                <div id="step1-content">
                    <div class="folder-selection">
                        <div class="folder-card" id="source-folder" onclick="selectSourceFolder()">
                            <div class="folder-icon">ğŸ“‚</div>
                            <div class="folder-name">ä¾†æºè³‡æ–™å¤¾</div>
                            <div class="folder-path" id="source-path">é»æ“Šé¸æ“‡è¦æ•´ç†çš„è³‡æ–™å¤¾</div>
                        </div>
                        <div class="folder-card" id="target-folder" onclick="selectTargetFolder()">
                            <div class="folder-icon">ğŸ“</div>
                            <div class="folder-name">ç›®æ¨™è³‡æ–™å¤¾</div>
                            <div class="folder-path" id="target-path">é»æ“Šé¸æ“‡æ•´ç†å¾Œå­˜æ”¾ä½ç½®</div>
                            <div class="folder-badge" id="same-folder-badge" style="display: none;">åŒè³‡æ–™å¤¾</div>
                        </div>
                    </div>

                    <div class="performance-info" id="performance-info">
                        <div class="performance-info-header">
                            <span>âš¡</span>
                            <span>æ•ˆèƒ½å„ªåŒ–æ¨¡å¼</span>
                        </div>
                        <div class="performance-info-text">
                            æª¢æ¸¬åˆ°ä¾†æºå’Œç›®æ¨™ç‚ºåŒä¸€è³‡æ–™å¤¾ï¼Œå°‡ä½¿ç”¨ç§»å‹•æ¨¡å¼ï¼ˆæ›´å¿«é€Ÿã€ç¯€çœç©ºé–“ï¼‰
                        </div>
                    </div>

                    <div class="date-option-section">
                        <div class="date-option-title">é¸æ“‡åˆ†é¡ä¾æ“š</div>
                        <div class="date-options">
                            <div class="date-option" id="option-modified" onclick="selectDateType('modified')">
                                <div class="date-option-header">
                                    <div class="radio-custom"></div>
                                    <div class="date-option-icon">ğŸ“</div>
                                    <div class="date-option-name">ä¿®æ”¹æ—¥æœŸ</div>
                                </div>
                                <div class="date-option-desc">æ ¹æ“šæª”æ¡ˆæœ€å¾Œä¿®æ”¹æ™‚é–“åˆ†é¡</div>
                            </div>
                            <div class="date-option" id="option-created" onclick="selectDateType('created')">
                                <div class="date-option-header">
                                    <div class="radio-custom"></div>
                                    <div class="date-option-icon">ğŸ¯</div>
                                    <div class="date-option-name">å»ºç«‹æ—¥æœŸ</div>
                                </div>
                                <div class="date-option-desc">æ ¹æ“šæª”æ¡ˆå»ºç«‹æ™‚é–“åˆ†é¡</div>
                            </div>
                        </div>
                        <div class="info-note">
                            <div class="info-note-icon">â„¹ï¸</div>
                            <div class="info-note-text">
                                <strong>æ³¨æ„ï¼š</strong>ç”±æ–¼ç€è¦½å™¨é™åˆ¶ï¼Œå»ºç«‹æ—¥æœŸå¯èƒ½ä¸å¤ æº–ç¢ºã€‚å»ºè­°ä½¿ç”¨ä¿®æ”¹æ—¥æœŸä»¥ç²å¾—æ›´å¥½çš„æ•ˆæœã€‚
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="scan-btn" onclick="scanFiles()" disabled>
                            <span>ğŸ”</span> æƒææª”æ¡ˆ
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 2: é è¦½æª”æ¡ˆ -->
                <div id="step2-content" style="display: none;">
                    <div class="file-preview">
                        <div class="preview-header">
                            <div class="preview-title">
                                æª”æ¡ˆé è¦½
                                <span class="date-type-badge" id="date-type-badge">ä¿®æ”¹æ—¥æœŸ</span>
                            </div>
                            <div class="file-count" id="file-count">0 å€‹æª”æ¡ˆ</div>
                        </div>
                        <div class="file-list" id="file-list"></div>
                        <div class="operation-type" id="operation-type"></div>
                    </div>

                    <div class="stats-grid" id="stats-grid"></div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="goBackToStep1()">
                            <span>â¬…ï¸</span> é‡æ–°é¸æ“‡
                        </button>
                        <button class="btn btn-success" onclick="organizeFiles()">
                            <span>ğŸš€</span> é–‹å§‹æ•´ç†
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 3: åŸ·è¡Œæ•´ç† -->
                <div id="step3-content" style="display: none;">
                    <div class="progress-section active">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar">0%</div>
                        </div>
                        <div class="progress-text" id="progress-text">æº–å‚™æ•´ç†æª”æ¡ˆ...</div>
                    </div>

                    <div class="log-section active">
                        <div class="preview-header">
                            <div class="preview-title">æ“ä½œæ—¥èªŒ</div>
                        </div>
                        <div class="log-container" id="log-container"></div>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 4: å®Œæˆ -->
                <div id="step4-content" style="display: none;">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">âœ…</div>
                        <h2 style="color: #28a745; margin-bottom: 15px;">æ•´ç†å®Œæˆï¼</h2>
                        <p style="color: #6c757d; margin-bottom: 30px;">æ‰€æœ‰æª”æ¡ˆå·²ä¾ç…§<span id="final-date-type">ä¿®æ”¹æ—¥æœŸ</span>æˆåŠŸåˆ†é¡</p>
                        
                        <div class="stats-grid" id="final-stats"></div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="resetAll()">
                                <span>ğŸ”„</span> æ•´ç†å…¶ä»–è³‡æ–™å¤¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <script>
        let sourceDirHandle = null;
        let targetDirHandle = null;
        let fileList = [];
        let currentStep = 1;
        let selectedDateType = 'modified'; // 'modified' or 'created'
        let isSameFolder = false;

        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        if (!window.showDirectoryPicker) {
            showToast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ­¤åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chromeã€Edge æˆ–å…¶ä»–æ”¯æ´ File System Access API çš„ç€è¦½å™¨', 'error');
            document.getElementById('scan-btn').innerHTML = 'ä¸æ”¯æ´çš„ç€è¦½å™¨';
            document.getElementById('scan-btn').disabled = true;
        }

        // é è¨­é¸æ“‡ä¿®æ”¹æ—¥æœŸ
        selectDateType('modified');

        function selectDateType(type) {
            selectedDateType = type;
            
            // æ›´æ–°UI
            document.querySelectorAll('.date-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(`option-${type}`).classList.add('selected');
            
            showToast(`å·²é¸æ“‡${type === 'modified' ? 'ä¿®æ”¹æ—¥æœŸ' : 'å»ºç«‹æ—¥æœŸ'}ä½œç‚ºåˆ†é¡ä¾æ“š`, 'info');
        }

        async function selectSourceFolder() {
            try {
                sourceDirHandle = await window.showDirectoryPicker();
                document.getElementById('source-path').textContent = sourceDirHandle.name;
                document.getElementById('source-folder').classList.add('selected');
                checkSameFolder();
                checkCanScan();
                showToast('å·²é¸æ“‡ä¾†æºè³‡æ–™å¤¾', 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('é¸æ“‡è³‡æ–™å¤¾å¤±æ•—', 'error');
                }
            }
        }

        async function selectTargetFolder() {
            try {
                targetDirHandle = await window.showDirectoryPicker();
                document.getElementById('target-path').textContent = targetDirHandle.name;
                document.getElementById('target-folder').classList.add('selected');
                checkSameFolder();
                checkCanScan();
                showToast('å·²é¸æ“‡ç›®æ¨™è³‡æ–™å¤¾', 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('é¸æ“‡è³‡æ–™å¤¾å¤±æ•—', 'error');
                }
            }
        }

        function checkSameFolder() {
            if (sourceDirHandle && targetDirHandle) {
                // æª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€å€‹è³‡æ–™å¤¾
                isSameFolder = sourceDirHandle.isSameEntry && sourceDirHandle.isSameEntry(targetDirHandle);
                
                if (isSameFolder) {
                    document.getElementById('same-folder-badge').style.display = 'block';
                    document.getElementById('performance-info').classList.add('show');
                    showToast('æª¢æ¸¬åˆ°åŒä¸€è³‡æ–™å¤¾ï¼Œå°‡ä½¿ç”¨ç§»å‹•æ¨¡å¼', 'info');
                } else {
                    document.getElementById('same-folder-badge').style.display = 'none';
                    document.getElementById('performance-info').classList.remove('show');
                }
            }
        }

        function checkCanScan() {
            const scanBtn = document.getElementById('scan-btn');
            if (sourceDirHandle) {
                scanBtn.disabled = false;
                // å¦‚æœæ²’æœ‰é¸æ“‡ç›®æ¨™è³‡æ–™å¤¾ï¼Œé è¨­ä½¿ç”¨ä¾†æºè³‡æ–™å¤¾
                if (!targetDirHandle) {
                    targetDirHandle = sourceDirHandle;
                    document.getElementById('target-path').textContent = sourceDirHandle.name + ' (é è¨­)';
                    document.getElementById('target-folder').classList.add('selected');
                    checkSameFolder();
                }
            }
        }

        async function scanFiles() {
            if (!sourceDirHandle) return;

            updateStep(2);
            document.getElementById('step1-content').style.display = 'none';
            document.getElementById('step2-content').style.display = 'block';

            fileList = [];
            await scanDirectory(sourceDirHandle, '');
            
            displayFileList();
            displayStats();
        }

        async function scanDirectory(dirHandle, path) {
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    
                    // ç²å–ä¿®æ”¹æ—¥æœŸ
                    const modifiedDate = new Date(file.lastModified);
                    const modifiedDateStr = formatDate(modifiedDate);
                    
                    // å˜—è©¦ç²å–å»ºç«‹æ—¥æœŸï¼ˆå¯èƒ½ä¸æº–ç¢ºï¼‰
                    let createdDate = modifiedDate;
                    let createdDateStr = modifiedDateStr;
                    
                    fileList.push({
                        name: file.name,
                        path: path,
                        size: file.size,
                        modifiedDate: modifiedDate,
                        modifiedDateStr: modifiedDateStr,
                        createdDate: createdDate,
                        createdDateStr: createdDateStr,
                        handle: entry
                    });
                } else if (entry.kind === 'directory') {
                    await scanDirectory(entry, path + entry.name + '/');
                }
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function displayFileList() {
            const fileCount = document.getElementById('file-count');
            const fileListEl = document.getElementById('file-list');
            const dateTypeBadge = document.getElementById('date-type-badge');
            const operationType = document.getElementById('operation-type');
            
            fileCount.textContent = `${fileList.length} å€‹æª”æ¡ˆ`;
            dateTypeBadge.textContent = selectedDateType === 'modified' ? 'ä¿®æ”¹æ—¥æœŸ' : 'å»ºç«‹æ—¥æœŸ';
            
            if (isSameFolder) {
                operationType.textContent = 'ğŸš€ ç§»å‹•æ¨¡å¼ï¼ˆå¿«é€Ÿæ•´ç†ï¼‰';
                operationType.style.background = '#e8f5e9';
                operationType.style.color = '#2e7d32';
            } else {
                operationType.textContent = 'ğŸ“‹ è¤‡è£½æ¨¡å¼ï¼ˆè·¨è³‡æ–™å¤¾æ•´ç†ï¼‰';
                operationType.style.background = '#fff3e0';
                operationType.style.color = '#e65100';
            }
            
            // æ ¹æ“šé¸æ“‡çš„æ—¥æœŸé¡å‹æ’åº
            fileList.sort((a, b) => {
                const dateA = selectedDateType === 'modified' ? a.modifiedDate : a.createdDate;
                const dateB = selectedDateType === 'modified' ? b.modifiedDate : b.createdDate;
                return dateB - dateA;
            });
            
            fileListEl.innerHTML = fileList.map(file => {
                const date = selectedDateType === 'modified' ? file.modifiedDate : file.createdDate;
                const dateStr = selectedDateType === 'modified' ? file.modifiedDateStr : file.createdDateStr;
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">${getFileIcon(file.name)}</div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta">${formatFileSize(file.size)} â€¢ ${file.path || 'æ ¹ç›®éŒ„'}</div>
                            </div>
                        </div>
                        <div class="file-date-badge">${dateStr}</div>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ',
                'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'txt': 'ğŸ“„',
                'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦',
                'js': 'ğŸ’»', 'html': 'ğŸŒ', 'css': 'ğŸ¨',
            };
            return iconMap[ext] || 'ğŸ“„';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function displayStats() {
            const stats = {};
            fileList.forEach(file => {
                const dateStr = selectedDateType === 'modified' ? file.modifiedDateStr : file.createdDateStr;
                stats[dateStr] = (stats[dateStr] || 0) + 1;
            });

            const sortedDates = Object.keys(stats).sort();
            const statsGrid = document.getElementById('stats-grid');
            
            statsGrid.innerHTML = sortedDates.slice(0, 6).map(date => `
                <div class="stat-card">
                    <div class="stat-value">${stats[date]}</div>
                    <div class="stat-label">${date}</div>
                </div>
            `).join('');
        }

        async function organizeFiles() {
            updateStep(3);
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('step3-content').style.display = 'block';

            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const logContainer = document.getElementById('log-container');

            const dateTypeName = selectedDateType === 'modified' ? 'ä¿®æ”¹æ—¥æœŸ' : 'å»ºç«‹æ—¥æœŸ';
            const operationMode = isSameFolder ? 'ç§»å‹•æ¨¡å¼' : 'è¤‡è£½æ¨¡å¼';
            addLog(`é–‹å§‹ä¾ç…§${dateTypeName}æ•´ç†æª”æ¡ˆ (${operationMode})...`, 'info');
            
            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedFiles = {};
            fileList.forEach(file => {
                const dateStr = selectedDateType === 'modified' ? file.modifiedDateStr : file.createdDateStr;
                if (!groupedFiles[dateStr]) {
                    groupedFiles[dateStr] = [];
                }
                groupedFiles[dateStr].push(file);
            });

            let processed = 0;
            const total = fileList.length;

            for (const [date, files] of Object.entries(groupedFiles)) {
                try {
                    // å‰µå»ºæ—¥æœŸè³‡æ–™å¤¾
                    const dateDirHandle = await targetDirHandle.getDirectoryHandle(date, { create: true });
                    addLog(`å»ºç«‹è³‡æ–™å¤¾: ${date}`, 'success');

                    // è™•ç†æª”æ¡ˆ
                    for (const file of files) {
                        try {
                            const sourcePath = file.path ? file.path.split('/') : [];
                            let currentSourceDir = sourceDirHandle;
                            
                            // å°èˆªåˆ°æºæª”æ¡ˆæ‰€åœ¨ç›®éŒ„
                            for (const dir of sourcePath) {
                                if (dir) {
                                    currentSourceDir = await currentSourceDir.getDirectoryHandle(dir);
                                }
                            }

                            const fileHandle = await currentSourceDir.getFileHandle(file.name);
                            const fileData = await fileHandle.getFile();
                            
                            if (isSameFolder) {
                                // ç§»å‹•æ¨¡å¼ï¼šåœ¨åŒä¸€è³‡æ–™å¤¾å…§ç§»å‹•
                                addLog(`ç§»å‹•: ${file.name} â†’ ${date}/`, 'move');
                                
                                // å…ˆå¯«å…¥åˆ°æ–°ä½ç½®
                                const writeFileHandle = await dateDirHandle.getFileHandle(file.name, { create: true });
                                const writable = await writeFileHandle.createWritable();
                                await writable.write(fileData);
                                await writable.close();
                                
                                // åˆªé™¤åŸæª”æ¡ˆ
                                await currentSourceDir.removeEntry(file.name);
                            } else {
                                // è¤‡è£½æ¨¡å¼ï¼šè·¨è³‡æ–™å¤¾è¤‡è£½
                                addLog(`è¤‡è£½: ${file.name} â†’ ${date}/`, 'success');
                                
                                const writeFileHandle = await dateDirHandle.getFileHandle(file.name, { create: true });
                                const writable = await writeFileHandle.createWritable();
                                await writable.write(fileData);
                                await writable.close();
                            }

                            processed++;
                            const progress = Math.round((processed / total) * 100);
                            progressBar.style.width = progress + '%';
                            progressBar.textContent = progress + '%';
                            progressText.textContent = `å·²è™•ç† ${processed} / ${total} å€‹æª”æ¡ˆ`;

                        } catch (err) {
                            addLog(`éŒ¯èª¤: ç„¡æ³•è™•ç† ${file.name} - ${err.message}`, 'error');
                        }
                    }
                } catch (err) {
                    addLog(`éŒ¯èª¤: ç„¡æ³•å»ºç«‹è³‡æ–™å¤¾ ${date} - ${err.message}`, 'error');
                }
            }

            // å®Œæˆæ•´ç†
            setTimeout(() => {
                updateStep(4);
                document.getElementById('step3-content').style.display = 'none';
                document.getElementById('step4-content').style.display = 'block';
                
                document.getElementById('final-date-type').textContent = dateTypeName;
                displayFinalStats();
                showToast('æª”æ¡ˆæ•´ç†å®Œæˆï¼', 'success');
            }, 1000);
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function displayFinalStats() {
            const stats = {};
            fileList.forEach(file => {
                const dateStr = selectedDateType === 'modified' ? file.modifiedDateStr : file.createdDateStr;
                stats[dateStr] = (stats[dateStr] || 0) + 1;
            });

            const finalStats = document.getElementById('final-stats');
            const operationText = isSameFolder ? 'ç§»å‹•' : 'è¤‡è£½';
            
            finalStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${fileList.length}</div>
                    <div class="stat-label">ç¸½æª”æ¡ˆæ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Object.keys(stats).length}</div>
                    <div class="stat-label">å»ºç«‹è³‡æ–™å¤¾</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${operationText}</div>
                    <div class="stat-label">æ“ä½œæ¨¡å¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatFileSize(fileList.reduce((sum, f) => sum + f.size, 0))}</div>
                    <div class="stat-label">ç¸½æª”æ¡ˆå¤§å°</div>
                </div>
            `;
        }

        function goBackToStep1() {
            updateStep(1);
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('step1-content').style.display = 'block';
        }

        function updateStep(step) {
            currentStep = step;
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (i === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            }
        }

        function resetAll() {
            sourceDirHandle = null;
            targetDirHandle = null;
            fileList = [];
            currentStep = 1;
            selectedDateType = 'modified';
            isSameFolder = false;
            
            document.getElementById('source-path').textContent = 'é»æ“Šé¸æ“‡è¦æ•´ç†çš„è³‡æ–™å¤¾';
            document.getElementById('target-path').textContent = 'é»æ“Šé¸æ“‡æ•´ç†å¾Œå­˜æ”¾ä½ç½®';
            document.getElementById('source-folder').classList.remove('selected');
            document.getElementById('target-folder').classList.remove('selected');
            document.getElementById('same-folder-badge').style.display = 'none';
            document.getElementById('performance-info').classList.remove('show');
            document.getElementById('scan-btn').disabled = true;
            
            // é‡ç½®æ—¥æœŸé¸æ“‡
            selectDateType('modified');
            
            document.getElementById('step4-content').style.display = 'none';
            document.getElementById('step1-content').style.display = 'block';
            
            updateStep(1);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>