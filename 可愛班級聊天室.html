<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯æ„›ç­ç´šèŠå¤©å®¤</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 100%);
            padding: 15px 20px;
            text-align: center;
            color: #fff;
            position: relative;
            z-index: 10;
        }
        
        .header h1 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 5px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 80px);
            padding: 20px;
        }
        
        .login-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ff6b8b;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ffc0cb;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #ff6b8b;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b8b, #ff9a9e);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            z-index: 10;
        }
        
        .chat-header h2 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 20px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-right: 250px; /* ç‚ºå³å´åœ¨ç·šåå–®ç•™å‡ºç©ºé–“ */
        }
        
        .class-info {
            text-align: center;
            padding: 10px;
            color: #ff6b8b;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 5;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            margin-bottom: 80px; /* ç‚ºåº•éƒ¨è¼¸å…¥æ¡†ç•™å‡ºç©ºé–“ */
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .other-message {
            align-self: flex-start;
            background-color: #e3f2fd;
            border-bottom-left-radius: 5px;
        }
        
        .self-message {
            align-self: flex-end;
            background-color: #f8bbd0;
            border-bottom-right-radius: 5px;
        }
        
        .message-info {
            font-size: 0.8rem;
            color: #757575;
            margin-bottom: 5px;
        }
        
        .message-content {
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .input-container {
            padding: 15px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 250px; /* ç‚ºå³å´åœ¨ç·šåå–®ç•™å‡ºç©ºé–“ */
            z-index: 20;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ffc0cb;
            border-radius: 25px;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.3s;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #ff6b8b;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
        }
        
        .send-btn {
            background: linear-gradient(45deg, #ff6b8b, #ff9a9e);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .online-list {
            width: 250px;
            background-color: rgba(255, 255, 255, 0.8);
            border-left: 1px solid #e0e0e0;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 180px; /* èª¿æ•´ç‚º180px */
            bottom: 0;
            z-index: 15;
        }
        
        .online-list h3 {
            color: #ff6b8b;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
        }
        
        .online-user {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .online-user:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .online-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f8bbd0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 18px;
        }
        
        .online-user-info {
            flex: 1;
        }
        
        .online-user-name {
            font-weight: bold;
            color: #333;
        }
        
        .online-user-role {
            font-size: 0.8rem;
            color: #757575;
        }
        
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
            margin-left: 5px;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .logout-btn:hover {
            transform: scale(1.05);
        }
        
        .connection-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 100;
            display: none;
        }
        
        .connection-status h3 {
            color: #ff6b8b;
            margin-bottom: 10px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.8rem;
        }
        
        .connection-status p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .reconnect-btn {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reconnect-btn:hover {
            transform: scale(1.05);
        }
        
        .decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.3));
            z-index: -1;
        }
        
        .decoration-1 {
            top: -30px;
            left: -30px;
            width: 120px;
            height: 120px;
        }
        
        .decoration-2 {
            bottom: -40px;
            right: -40px;
            width: 150px;
            height: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="decoration decoration-1"></div>
            <div class="decoration decoration-2"></div>
            <h1>ğŸ¾ å¯æ„›ç­ç´šèŠå¤©å®¤ ğŸ¾</h1>
            <p>è€å¸«èˆ‡å­¸ç”Ÿçš„æºé€šæ©‹æ¨‘</p>
        </div>
        
        <div id="loginContainer" class="login-container">
            <div class="login-form">
                <h2 id="loginTitle">è«‹é¸æ“‡ç™»å…¥æ–¹å¼</h2>
                
                <div id="roleSelection" style="margin-bottom: 30px;">
                    <button class="btn" onclick="showTeacherLogin()">è€å¸«ç™»å…¥</button>
                    <button class="btn" onclick="showStudentLogin()" style="margin-left: 15px;">å­¸ç”Ÿç™»å…¥</button>
                </div>
                
                <div id="teacherLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="teacherUsername">å¸³è™Ÿ</label>
                        <input type="text" id="teacherUsername" placeholder="è«‹è¼¸å…¥è€å¸«å¸³è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label for="teacherPassword">å¯†ç¢¼</label>
                        <input type="password" id="teacherPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="classCode">ç­ç´šä»£ç¢¼</label>
                        <input type="text" id="classCode" placeholder="è«‹è¼¸å…¥ç­ç´šä»£ç¢¼">
                    </div>
                    <button class="btn" onclick="teacherLogin()">ç™»å…¥</button>
                    <button class="btn" onclick="backToRoleSelection()" style="margin-left: 15px; background: linear-gradient(45deg, #a1c4fd, #c2e9fb);">è¿”å›</button>
                </div>
                
                <div id="studentLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="studentName">å§“å</label>
                        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥ä½ çš„å§“å">
                    </div>
                    <div class="form-group">
                        <label for="studentClassCode">ç­ç´šä»£ç¢¼</label>
                        <input type="text" id="studentClassCode" placeholder="è«‹è¼¸å…¥ç­ç´šä»£ç¢¼">
                    </div>
                    <button class="btn" onclick="studentLogin()">ç™»å…¥</button>
                    <button class="btn" onclick="backToRoleSelection()" style="margin-left: 15px; background: linear-gradient(45deg, #a1c4fd, #c2e9fb);">è¿”å›</button>
                </div>
            </div>
        </div>
        
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <h2 id="chatTitle">ç­ç´šèŠå¤©å®¤</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                    <div>
                        <div id="userName">ç”¨æˆ¶</div>
                        <div id="userRole">è§’è‰²</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="chat-area">
                    <div class="class-info" id="classInfo">
                        ç­ç´š: <span id="displayClassCode"></span>
                        <span class="online-indicator"></span> ç·šä¸Š
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        <!-- è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
                
                <div class="online-list">
                    <h3>ğŸ‘¥ åœ¨ç·šåå–®</h3>
                    <div id="onlineUsersList">
                        <!-- åœ¨ç·šç”¨æˆ¶å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">ğŸ“¤</button>
            </div>
        </div>
        
        <div id="connectionStatus" class="connection-status">
            <h3>ğŸŒ é€£æ¥ç‹€æ…‹</h3>
            <p id="connectionMessage">ç¶²è·¯é€£æ¥ä¸­æ–·ï¼Œè«‹ç¨å¾Œé‡é€£...</p>
            <button class="reconnect-btn" onclick="reconnect()">é‡æ–°é€£æ¥</button>
        </div>
    </div>

    <script>
        // æª¢æŸ¥ localStorage ä¸­çš„ç™»å‡ºç‹€æ…‹
        const wasLoggingOut = localStorage.getItem('isLoggingOut') === 'true';
        if (wasLoggingOut) {
            // æ¸…é™¤ localStorage ä¸­çš„ç™»å‡ºæ¨™è¨˜
            localStorage.removeItem('isLoggingOut');
        }
        
        // MQTT è¨­ç½®
        const brokerUrl = 'wss://test.mosquitto.org:8081/mqtt'; // ä½¿ç”¨å…¬å…±MQTT Broker
        let client;
        let currentUser = '';
        let currentRole = '';
        let currentClassCode = '';
        let onlineUsers = new Map(); // å­˜å„²åœ¨ç·šç”¨æˆ¶
        let displayedSystemMessages = new Set(); // è¨˜éŒ„å·²é¡¯ç¤ºçš„ç³»çµ±è¨Šæ¯
        let heartbeatInterval; // å¿ƒè·³å®šæ™‚å™¨
        let updateOnlineListInterval; // æ›´æ–°åœ¨ç·šåå–®å®šæ™‚å™¨
        let reconnectAttempts = 0; // é‡é€£å˜—è©¦æ¬¡æ•¸
        let isReconnecting = false; // æ˜¯å¦æ­£åœ¨é‡é€£
        let isLoggingOut = false; // æ˜¯å¦æ­£åœ¨ç™»å‡º
        
        // é è¨­æ•™å¸«å¯†ç¢¼çš„SHA256å“ˆå¸Œå€¼ï¼ˆå¯†ç¢¼ï¼š1234ï¼‰
        const teacherPasswordHash = '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4';
        
        // é¡¯ç¤ºè€å¸«ç™»å…¥è¡¨å–®
        function showTeacherLogin() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('teacherLoginForm').style.display = 'block';
            document.getElementById('loginTitle').textContent = 'è€å¸«ç™»å…¥';
        }
        
        // é¡¯ç¤ºå­¸ç”Ÿç™»å…¥è¡¨å–®
        function showStudentLogin() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('loginTitle').textContent = 'å­¸ç”Ÿç™»å…¥';
        }
        
        // è¿”å›è§’è‰²é¸æ“‡
        function backToRoleSelection() {
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('teacherLoginForm').style.display = 'none';
            document.getElementById('studentLoginForm').style.display = 'none';
            document.getElementById('loginTitle').textContent = 'è«‹é¸æ“‡ç™»å…¥æ–¹å¼';
        }
        
        // è€å¸«ç™»å…¥
        function teacherLogin() {
            const username = document.getElementById('teacherUsername').value;
            const password = document.getElementById('teacherPassword').value;
            const classCode = document.getElementById('classCode').value;
            
            if (!username || !password || !classCode) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }
            
            // ä½¿ç”¨SHA256åŠ å¯†å¯†ç¢¼
            const passwordHash = CryptoJS.SHA256(password).toString();
            
            // ç°¡å–®é©—è­‰ (å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰é€£æ¥å¾Œç«¯é©—è­‰)
            if (username === 'teacher' && passwordHash === teacherPasswordHash) {
                currentUser = username;
                currentRole = 'teacher';
                currentClassCode = classCode;
                connectToMQTT();
            } else {
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            }
        }
        
        // å­¸ç”Ÿç™»å…¥
        function studentLogin() {
            const name = document.getElementById('studentName').value;
            const classCode = document.getElementById('studentClassCode').value;
            
            if (!name || !classCode) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }
            
            currentUser = name;
            currentRole = 'student';
            currentClassCode = classCode;
            connectToMQTT();
        }
        
        // é€£æ¥åˆ°MQTT Broker
        function connectToMQTT() {
            try {
                // è¨­ç½®willæ¶ˆæ¯ï¼Œç”¨æ–¼ç•°å¸¸æ–·é–‹æ™‚é€šçŸ¥
                const options = {
                    will: {
                        topic: `classroom/${currentClassCode}/status`,
                        payload: JSON.stringify({
                            sender: currentUser,
                            role: currentRole,
                            type: 'leave',
                            content: `${currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'} ${currentUser} é›¢é–‹äº†èŠå¤©å®¤`,
                            timestamp: new Date().toISOString()
                        }),
                        qos: 1,
                        retain: false
                    },
                    clean: true,
                    reconnectPeriod: 3000, // 3ç§’å¾Œè‡ªå‹•é‡é€£
                    connectTimeout: 30000 // 30ç§’é€£æ¥è¶…æ™‚
                };
                
                client = mqtt.connect(brokerUrl, options);
                
                client.on('connect', function() {
                    console.log('MQTT é€£æ¥æˆåŠŸ');
                    reconnectAttempts = 0;
                    isReconnecting = false;
                    
                    // éš±è—é€£æ¥ç‹€æ…‹æç¤º
                    document.getElementById('connectionStatus').style.display = 'none';
                    
                    // è¨‚é–±ç­ç´šä¸»é¡Œ
                    const classTopic = `classroom/${currentClassCode}`;
                    const statusTopic = `classroom/${currentClassCode}/status`;
                    const heartbeatTopic = `classroom/${currentClassCode}/heartbeat`;
                    
                    client.subscribe(classTopic, function(err) {
                        if (!err) {
                            console.log(`è¨‚é–±ç­ç´šä¸»é¡Œ: ${classTopic}`);
                        }
                    });
                    
                    client.subscribe(statusTopic, function(err) {
                        if (!err) {
                            console.log(`è¨‚é–±ç‹€æ…‹ä¸»é¡Œ: ${statusTopic}`);
                        }
                    });
                    
                    client.subscribe(heartbeatTopic, function(err) {
                        if (!err) {
                            console.log(`è¨‚é–±å¿ƒè·³ä¸»é¡Œ: ${heartbeatTopic}`);
                        }
                    });
                    
                    // å¦‚æœæ˜¯é¦–æ¬¡é€£æ¥ï¼Œé¡¯ç¤ºèŠå¤©å®¤
                    if (document.getElementById('chatContainer').style.display !== 'flex') {
                        // é¡¯ç¤ºèŠå¤©å®¤
                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('chatContainer').style.display = 'flex';
                        
                        // è¨­ç½®ç”¨æˆ¶ä¿¡æ¯
                        document.getElementById('userName').textContent = currentUser;
                        document.getElementById('userRole').textContent = currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ';
                        document.getElementById('displayClassCode').textContent = currentClassCode;
                        document.getElementById('userAvatar').textContent = currentRole === 'teacher' ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ“';
                        
                        // è¨­ç½®èŠå¤©æ¨™é¡Œ
                        document.getElementById('chatTitle').textContent = currentRole === 'teacher' ? 
                            `${currentClassCode} ç­ç´šèŠå¤©å®¤` : `${currentClassCode} ç­ç´šèŠå¤©å®¤`;
                    }
                    
                    // å¦‚æœæ˜¯é‡é€£ï¼Œç™¼é€é‡æ–°åŠ å…¥è¨Šæ¯
                    if (reconnectAttempts > 0) {
                        const reconnectMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'reconnect',
                            content: `${currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'} ${currentUser} é‡æ–°åŠ å…¥äº†èŠå¤©å®¤`,
                            timestamp: new Date().toISOString()
                        };
                        
                        client.publish(classTopic, JSON.stringify(reconnectMessage));
                    } else {
                        // é¦–æ¬¡é€£æ¥ï¼Œç™¼é€åŠ å…¥é€šçŸ¥
                        const joinMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'join',
                            content: `${currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'} ${currentUser} åŠ å…¥äº†èŠå¤©å®¤`,
                            timestamp: new Date().toISOString()
                        };
                        
                        client.publish(classTopic, JSON.stringify(joinMessage));
                    }
                    
                    // ç™¼é€ç‹€æ…‹æ›´æ–°
                    const statusMessage = {
                        sender: currentUser,
                        role: currentRole,
                        type: 'join',
                        timestamp: new Date().toISOString()
                    };
                    
                    client.publish(statusTopic, JSON.stringify(statusMessage));
                    
                    // å°‡è‡ªå·±åŠ å…¥åœ¨ç·šåˆ—è¡¨
                    onlineUsers.set(currentUser, {
                        name: currentUser,
                        role: currentRole,
                        lastActive: new Date().getTime()
                    });
                    updateOnlineUsersList();
                    
                    // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
                    startHeartbeat();
                    
                    // å•Ÿå‹•åœ¨ç·šåå–®æ›´æ–°æ©Ÿåˆ¶
                    startOnlineListUpdate();
                });
                
                client.on('message', function(topic, message) {
                    const msgData = JSON.parse(message.toString());
                    
                    if (topic.includes('/status')) {
                        // è™•ç†ç‹€æ…‹æ›´æ–°
                        handleStatusUpdate(msgData);
                    } else if (topic.includes('/heartbeat')) {
                        // è™•ç†å¿ƒè·³
                        handleHeartbeat(msgData);
                    } else {
                        // è™•ç†èŠå¤©è¨Šæ¯
                        displayMessage(msgData);
                    }
                });
                
                client.on('error', function(err) {
                    console.error('MQTT é€£æ¥éŒ¯èª¤:', err);
                });
                
                client.on('close', function() {
                    console.log('MQTT é€£æ¥é—œé–‰');
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸ç™»å‡º
                    const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
                    if (!isReconnecting && !isNormalLogout) {
                        handleDisconnect();
                    }
                });
                
                client.on('offline', function() {
                    console.log('MQTT é€£æ¥é›¢ç·š');
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸ç™»å‡º
                    const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
                    if (!isReconnecting && !isNormalLogout) {
                        handleDisconnect();
                    }
                });
                
                client.on('reconnect', function() {
                    console.log('MQTT æ­£åœ¨é‡é€£...');
                    isReconnecting = true;
                    reconnectAttempts++;
                });
                
                // è™•ç†é é¢é—œé–‰äº‹ä»¶
                window.addEventListener('beforeunload', function() {
                    if (client && client.connected && !isLoggingOut) {
                        const statusTopic = `classroom/${currentClassCode}/status`;
                        const leaveMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'leave',
                            timestamp: new Date().toISOString()
                        };
                        client.publish(statusTopic, JSON.stringify(leaveMessage));
                    }
                });
                
            } catch (error) {
                console.error('MQTT åˆå§‹åŒ–éŒ¯èª¤:', error);
                alert('ç„¡æ³•é€£æ¥åˆ°èŠå¤©æœå‹™å™¨');
            }
        }
        
        // è™•ç†æ–·é€£
        function handleDisconnect() {
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸ç™»å‡º
            const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
            if (isNormalLogout) {
                return;
            }
            
            // æ¸…é™¤å®šæ™‚å™¨
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            if (updateOnlineListInterval) {
                clearInterval(updateOnlineListInterval);
            }
            
            // é¡¯ç¤ºæ–·é€£è¨Šæ¯
            const disconnectMessage = {
                sender: currentUser,
                role: currentRole,
                type: 'disconnect',
                content: `${currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'} ${currentUser} å› ç¶²è·¯å•é¡Œå·²é›¢é–‹`,
                timestamp: new Date().toISOString()
            };
            
            displayMessage(disconnectMessage);
            
            // å¾åœ¨ç·šåå–®ä¸­ç§»é™¤è‡ªå·±
            onlineUsers.delete(currentUser);
            updateOnlineUsersList();
            
            // é¡¯ç¤ºé€£æ¥ç‹€æ…‹æç¤º
            document.getElementById('connectionStatus').style.display = 'block';
            document.getElementById('connectionMessage').textContent = 'ç¶²è·¯é€£æ¥ä¸­æ–·ï¼Œè«‹ç¨å¾Œé‡é€£...';
        }
        
        // æ‰‹å‹•é‡é€£
        function reconnect() {
            document.getElementById('connectionMessage').textContent = 'æ­£åœ¨é‡æ–°é€£æ¥...';
            document.getElementById('connectionStatus').style.display = 'block';
            
            if (client) {
                client.reconnect();
            } else {
                connectToMQTT();
            }
        }
        
        // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
        function startHeartbeat() {
            // æ¯10ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³
            heartbeatInterval = setInterval(function() {
                if (client && client.connected) {
                    const heartbeatTopic = `classroom/${currentClassCode}/heartbeat`;
                    const heartbeatMessage = {
                        sender: currentUser,
                        role: currentRole,
                        timestamp: new Date().toISOString()
                    };
                    client.publish(heartbeatTopic, JSON.stringify(heartbeatMessage));
                    
                    // æ›´æ–°è‡ªå·±çš„æœ€å¾Œæ´»å‹•æ™‚é–“
                    if (onlineUsers.has(currentUser)) {
                        const user = onlineUsers.get(currentUser);
                        user.lastActive = new Date().getTime();
                        onlineUsers.set(currentUser, user);
                    }
                }
            }, 10000);
        }
        
        // å•Ÿå‹•åœ¨ç·šåå–®æ›´æ–°æ©Ÿåˆ¶
        function startOnlineListUpdate() {
            // æ¯10ç§’æ›´æ–°ä¸€æ¬¡åœ¨ç·šåå–®
            updateOnlineListInterval = setInterval(function() {
                const now = new Date().getTime();
                const timeout = 20000; // 20ç§’æ²’æœ‰å¿ƒè·³è¦–ç‚ºé›¢ç·š
                
                // ç§»é™¤è¶…æ™‚çš„ç”¨æˆ¶
                for (const [username, user] of onlineUsers.entries()) {
                    if (now - user.lastActive > timeout) {
                        onlineUsers.delete(username);
                    }
                }
                
                updateOnlineUsersList();
            }, 10000);
        }
        
        // è™•ç†å¿ƒè·³
        function handleHeartbeat(msgData) {
            if (onlineUsers.has(msgData.sender)) {
                const user = onlineUsers.get(msgData.sender);
                user.lastActive = new Date().getTime();
                onlineUsers.set(msgData.sender, user);
            } else {
                // å¦‚æœç”¨æˆ¶ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæ·»åŠ ä»–
                onlineUsers.set(msgData.sender, {
                    name: msgData.sender,
                    role: msgData.role,
                    lastActive: new Date().getTime()
                });
            }
        }
        
        // è™•ç†ç‹€æ…‹æ›´æ–°
        function handleStatusUpdate(msgData) {
            if (msgData.type === 'join') {
                // ç”¨æˆ¶åŠ å…¥
                onlineUsers.set(msgData.sender, {
                    name: msgData.sender,
                    role: msgData.role,
                    lastActive: new Date().getTime()
                });
            } else if (msgData.type === 'leave') {
                // ç”¨æˆ¶é›¢é–‹
                onlineUsers.delete(msgData.sender);
            }
            updateOnlineUsersList();
        }
        
        // æ›´æ–°åœ¨ç·šç”¨æˆ¶åˆ—è¡¨
        function updateOnlineUsersList() {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '';
            
            // æŒ‰è§’è‰²æ’åºï¼ˆè€å¸«åœ¨å‰ï¼‰
            const sortedUsers = Array.from(onlineUsers.values()).sort((a, b) => {
                if (a.role === 'teacher' && b.role !== 'teacher') return -1;
                if (a.role !== 'teacher' && b.role === 'teacher') return 1;
                return 0;
            });
            
            sortedUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'online-user';
                
                const avatar = user.role === 'teacher' ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ“';
                const roleText = user.role === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ';
                
                userElement.innerHTML = `
                    <div class="online-user-avatar">${avatar}</div>
                    <div class="online-user-info">
                        <div class="online-user-name">${user.name}</div>
                        <div class="online-user-role">${roleText}</div>
                    </div>
                    <span class="online-indicator"></span>
                `;
                
                onlineUsersList.appendChild(userElement);
            });
            
            // å¦‚æœæ²’æœ‰åœ¨ç·šç”¨æˆ¶
            if (sortedUsers.length === 0) {
                onlineUsersList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ç›®å‰æ²’æœ‰åœ¨ç·šç”¨æˆ¶</div>';
            }
        }
        
        // ç™¼é€è¨Šæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const classTopic = `classroom/${currentClassCode}`;
            const message = {
                sender: currentUser,
                role: currentRole,
                type: 'message',
                content: content,
                timestamp: new Date().toISOString()
            };
            
            client.publish(classTopic, JSON.stringify(message));
            messageInput.value = '';
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function displayMessage(msgData) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            
            // è¨­ç½®è¨Šæ¯é¡å‹
            if (msgData.type === 'join' || msgData.type === 'leave' || msgData.type === 'disconnect' || msgData.type === 'reconnect') {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¡¯ç¤ºéé€™å€‹ç³»çµ±è¨Šæ¯
                const messageKey = `${msgData.type}-${msgData.sender}-${msgData.timestamp}`;
                if (displayedSystemMessages.has(messageKey)) {
                    return; // å·²ç¶“é¡¯ç¤ºéï¼Œä¸å†é‡è¤‡é¡¯ç¤º
                }
                
                // è¨˜éŒ„å·²é¡¯ç¤ºçš„ç³»çµ±è¨Šæ¯
                displayedSystemMessages.add(messageKey);
                
                messageElement.className = 'message system-message';
                messageElement.style.textAlign = 'center';
                messageElement.style.backgroundColor = '#e1f5fe';
                messageElement.style.margin = '10px auto';
                messageElement.style.maxWidth = '70%';
                
                // æ ¹æ“šè¨Šæ¯é¡å‹è¨­ç½®ä¸åŒçš„èƒŒæ™¯è‰²
                if (msgData.type === 'disconnect') {
                    messageElement.style.backgroundColor = '#ffebee'; // æ–·é€£ç”¨æ·¡ç´…è‰²
                } else if (msgData.type === 'reconnect') {
                    messageElement.style.backgroundColor = '#e8f5e9'; // é‡é€£ç”¨æ·¡ç¶ è‰²
                }
                
                messageElement.innerHTML = `<div class="message-content">${msgData.content}</div>`;
            } else {
                // æ ¹æ“šç™¼é€è€…æ˜¯å¦ç‚ºæœ¬äººä¾†æ±ºå®šè¨Šæ¯ä½ç½®
                if (msgData.sender === currentUser) {
                    messageElement.className = 'message self-message';
                } else {
                    messageElement.className = 'message other-message';
                }
                
                // æ ¼å¼åŒ–æ™‚é–“
                const timestamp = new Date(msgData.timestamp);
                const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-info">${msgData.sender} (${msgData.role === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'}) - ${timeString}</div>
                    <div class="message-content">${msgData.content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ç™»å‡º
        function logout() {
            // è¨­ç½®ç™»å‡ºæ¨™èªŒåˆ° localStorage
            localStorage.setItem('isLoggingOut', 'true');
            
            // è¨­ç½®ç™»å‡ºæ¨™èªŒ
            isLoggingOut = true;
            
            // æ¸…é™¤å®šæ™‚å™¨
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            if (updateOnlineListInterval) {
                clearInterval(updateOnlineListInterval);
            }
            
            // ç«‹å³éš±è—é€£æ¥ç‹€æ…‹æç¤ºï¼ˆé˜²æ­¢ç™»å‡ºå¾Œé¡¯ç¤ºï¼‰
            document.getElementById('connectionStatus').style.display = 'none';
            
            if (client && client.connected) {
                const classTopic = `classroom/${currentClassCode}`;
                const statusTopic = `classroom/${currentClassCode}/status`;
                
                const leaveMessage = {
                    sender: currentUser,
                    role: currentRole,
                    type: 'leave',
                    content: `${currentRole === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ'} ${currentUser} é›¢é–‹äº†èŠå¤©å®¤`,
                    timestamp: new Date().toISOString()
                };
                
                client.publish(classTopic, JSON.stringify(leaveMessage));
                client.publish(statusTopic, JSON.stringify({
                    sender: currentUser,
                    role: currentRole,
                    type: 'leave',
                    timestamp: new Date().toISOString()
                }));
                
                // æ­£å¸¸æ–·é–‹é€£æ¥ï¼Œä¸è§¸ç™¼willæ¶ˆæ¯
                client.end();
            }
            
            // é‡ç½®é é¢
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('messagesContainer').innerHTML = '';
            backToRoleSelection();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('teacherUsername').value = '';
            document.getElementById('teacherPassword').value = '';
            document.getElementById('classCode').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClassCode').value = '';
            
            // æ¸…ç©ºåœ¨ç·šç”¨æˆ¶åˆ—è¡¨å’Œå·²é¡¯ç¤ºçš„ç³»çµ±è¨Šæ¯
            onlineUsers.clear();
            displayedSystemMessages.clear();
            document.getElementById('onlineUsersList').innerHTML = '';
            
            // é‡ç½®é€£æ¥ç‹€æ…‹
            reconnectAttempts = 0;
            isReconnecting = false;
            isLoggingOut = false;
            
            // æ¸…é™¤ localStorage ä¸­çš„ç™»å‡ºæ¨™è¨˜
            localStorage.removeItem('isLoggingOut');
        }
        
        // ç›£è½Enteréµç™¼é€è¨Šæ¯
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>