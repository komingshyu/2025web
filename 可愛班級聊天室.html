<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可愛班級聊天室</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 100%);
            padding: 15px 20px;
            text-align: center;
            color: #fff;
            position: relative;
            z-index: 10;
        }
        
        .header h1 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 5px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 80px);
            padding: 20px;
        }
        
        .login-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ff6b8b;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ffc0cb;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #ff6b8b;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b8b, #ff9a9e);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            z-index: 10;
        }
        
        .chat-header h2 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 20px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-right: 250px; /* 為右側在線名單留出空間 */
        }
        
        .class-info {
            text-align: center;
            padding: 10px;
            color: #ff6b8b;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 5;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            margin-bottom: 80px; /* 為底部輸入框留出空間 */
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .other-message {
            align-self: flex-start;
            background-color: #e3f2fd;
            border-bottom-left-radius: 5px;
        }
        
        .self-message {
            align-self: flex-end;
            background-color: #f8bbd0;
            border-bottom-right-radius: 5px;
        }
        
        .message-info {
            font-size: 0.8rem;
            color: #757575;
            margin-bottom: 5px;
        }
        
        .message-content {
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .input-container {
            padding: 15px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 250px; /* 為右側在線名單留出空間 */
            z-index: 20;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ffc0cb;
            border-radius: 25px;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.3s;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #ff6b8b;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
        }
        
        .send-btn {
            background: linear-gradient(45deg, #ff6b8b, #ff9a9e);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .online-list {
            width: 250px;
            background-color: rgba(255, 255, 255, 0.8);
            border-left: 1px solid #e0e0e0;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 180px; /* 調整為180px */
            bottom: 0;
            z-index: 15;
        }
        
        .online-list h3 {
            color: #ff6b8b;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
        }
        
        .online-user {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .online-user:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .online-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f8bbd0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 18px;
        }
        
        .online-user-info {
            flex: 1;
        }
        
        .online-user-name {
            font-weight: bold;
            color: #333;
        }
        
        .online-user-role {
            font-size: 0.8rem;
            color: #757575;
        }
        
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
            margin-left: 5px;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .logout-btn:hover {
            transform: scale(1.05);
        }
        
        .connection-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 100;
            display: none;
        }
        
        .connection-status h3 {
            color: #ff6b8b;
            margin-bottom: 10px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.8rem;
        }
        
        .connection-status p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .reconnect-btn {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reconnect-btn:hover {
            transform: scale(1.05);
        }
        
        .decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.3));
            z-index: -1;
        }
        
        .decoration-1 {
            top: -30px;
            left: -30px;
            width: 120px;
            height: 120px;
        }
        
        .decoration-2 {
            bottom: -40px;
            right: -40px;
            width: 150px;
            height: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="decoration decoration-1"></div>
            <div class="decoration decoration-2"></div>
            <h1>🐾 可愛班級聊天室 🐾</h1>
            <p>老師與學生的溝通橋樑</p>
        </div>
        
        <div id="loginContainer" class="login-container">
            <div class="login-form">
                <h2 id="loginTitle">請選擇登入方式</h2>
                
                <div id="roleSelection" style="margin-bottom: 30px;">
                    <button class="btn" onclick="showTeacherLogin()">老師登入</button>
                    <button class="btn" onclick="showStudentLogin()" style="margin-left: 15px;">學生登入</button>
                </div>
                
                <div id="teacherLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="teacherUsername">帳號</label>
                        <input type="text" id="teacherUsername" placeholder="請輸入老師帳號">
                    </div>
                    <div class="form-group">
                        <label for="teacherPassword">密碼</label>
                        <input type="password" id="teacherPassword" placeholder="請輸入密碼">
                    </div>
                    <div class="form-group">
                        <label for="classCode">班級代碼</label>
                        <input type="text" id="classCode" placeholder="請輸入班級代碼">
                    </div>
                    <button class="btn" onclick="teacherLogin()">登入</button>
                    <button class="btn" onclick="backToRoleSelection()" style="margin-left: 15px; background: linear-gradient(45deg, #a1c4fd, #c2e9fb);">返回</button>
                </div>
                
                <div id="studentLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="studentName">姓名</label>
                        <input type="text" id="studentName" placeholder="請輸入你的姓名">
                    </div>
                    <div class="form-group">
                        <label for="studentClassCode">班級代碼</label>
                        <input type="text" id="studentClassCode" placeholder="請輸入班級代碼">
                    </div>
                    <button class="btn" onclick="studentLogin()">登入</button>
                    <button class="btn" onclick="backToRoleSelection()" style="margin-left: 15px; background: linear-gradient(45deg, #a1c4fd, #c2e9fb);">返回</button>
                </div>
            </div>
        </div>
        
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <h2 id="chatTitle">班級聊天室</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">👤</div>
                    <div>
                        <div id="userName">用戶</div>
                        <div id="userRole">角色</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">登出</button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="chat-area">
                    <div class="class-info" id="classInfo">
                        班級: <span id="displayClassCode"></span>
                        <span class="online-indicator"></span> 線上
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        <!-- 訊息將顯示在這裡 -->
                    </div>
                </div>
                
                <div class="online-list">
                    <h3>👥 在線名單</h3>
                    <div id="onlineUsersList">
                        <!-- 在線用戶將顯示在這裡 -->
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="輸入訊息...">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">📤</button>
            </div>
        </div>
        
        <div id="connectionStatus" class="connection-status">
            <h3>🌐 連接狀態</h3>
            <p id="connectionMessage">網路連接中斷，請稍後重連...</p>
            <button class="reconnect-btn" onclick="reconnect()">重新連接</button>
        </div>
    </div>

    <script>
        // 檢查 localStorage 中的登出狀態
        const wasLoggingOut = localStorage.getItem('isLoggingOut') === 'true';
        if (wasLoggingOut) {
            // 清除 localStorage 中的登出標記
            localStorage.removeItem('isLoggingOut');
        }
        
        // MQTT 設置
        const brokerUrl = 'wss://test.mosquitto.org:8081/mqtt'; // 使用公共MQTT Broker
        let client;
        let currentUser = '';
        let currentRole = '';
        let currentClassCode = '';
        let onlineUsers = new Map(); // 存儲在線用戶
        let displayedSystemMessages = new Set(); // 記錄已顯示的系統訊息
        let heartbeatInterval; // 心跳定時器
        let updateOnlineListInterval; // 更新在線名單定時器
        let reconnectAttempts = 0; // 重連嘗試次數
        let isReconnecting = false; // 是否正在重連
        let isLoggingOut = false; // 是否正在登出
        
        // 預設教師密碼的SHA256哈希值（密碼：1234）
        const teacherPasswordHash = '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4';
        
        // 顯示老師登入表單
        function showTeacherLogin() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('teacherLoginForm').style.display = 'block';
            document.getElementById('loginTitle').textContent = '老師登入';
        }
        
        // 顯示學生登入表單
        function showStudentLogin() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('loginTitle').textContent = '學生登入';
        }
        
        // 返回角色選擇
        function backToRoleSelection() {
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('teacherLoginForm').style.display = 'none';
            document.getElementById('studentLoginForm').style.display = 'none';
            document.getElementById('loginTitle').textContent = '請選擇登入方式';
        }
        
        // 老師登入
        function teacherLogin() {
            const username = document.getElementById('teacherUsername').value;
            const password = document.getElementById('teacherPassword').value;
            const classCode = document.getElementById('classCode').value;
            
            if (!username || !password || !classCode) {
                alert('請填寫所有欄位');
                return;
            }
            
            // 使用SHA256加密密碼
            const passwordHash = CryptoJS.SHA256(password).toString();
            
            // 簡單驗證 (實際應用中應連接後端驗證)
            if (username === 'teacher' && passwordHash === teacherPasswordHash) {
                currentUser = username;
                currentRole = 'teacher';
                currentClassCode = classCode;
                connectToMQTT();
            } else {
                alert('帳號或密碼錯誤');
            }
        }
        
        // 學生登入
        function studentLogin() {
            const name = document.getElementById('studentName').value;
            const classCode = document.getElementById('studentClassCode').value;
            
            if (!name || !classCode) {
                alert('請填寫所有欄位');
                return;
            }
            
            currentUser = name;
            currentRole = 'student';
            currentClassCode = classCode;
            connectToMQTT();
        }
        
        // 連接到MQTT Broker
        function connectToMQTT() {
            try {
                // 設置will消息，用於異常斷開時通知
                const options = {
                    will: {
                        topic: `classroom/${currentClassCode}/status`,
                        payload: JSON.stringify({
                            sender: currentUser,
                            role: currentRole,
                            type: 'leave',
                            content: `${currentRole === 'teacher' ? '老師' : '學生'} ${currentUser} 離開了聊天室`,
                            timestamp: new Date().toISOString()
                        }),
                        qos: 1,
                        retain: false
                    },
                    clean: true,
                    reconnectPeriod: 3000, // 3秒後自動重連
                    connectTimeout: 30000 // 30秒連接超時
                };
                
                client = mqtt.connect(brokerUrl, options);
                
                client.on('connect', function() {
                    console.log('MQTT 連接成功');
                    reconnectAttempts = 0;
                    isReconnecting = false;
                    
                    // 隱藏連接狀態提示
                    document.getElementById('connectionStatus').style.display = 'none';
                    
                    // 訂閱班級主題
                    const classTopic = `classroom/${currentClassCode}`;
                    const statusTopic = `classroom/${currentClassCode}/status`;
                    const heartbeatTopic = `classroom/${currentClassCode}/heartbeat`;
                    
                    client.subscribe(classTopic, function(err) {
                        if (!err) {
                            console.log(`訂閱班級主題: ${classTopic}`);
                        }
                    });
                    
                    client.subscribe(statusTopic, function(err) {
                        if (!err) {
                            console.log(`訂閱狀態主題: ${statusTopic}`);
                        }
                    });
                    
                    client.subscribe(heartbeatTopic, function(err) {
                        if (!err) {
                            console.log(`訂閱心跳主題: ${heartbeatTopic}`);
                        }
                    });
                    
                    // 如果是首次連接，顯示聊天室
                    if (document.getElementById('chatContainer').style.display !== 'flex') {
                        // 顯示聊天室
                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('chatContainer').style.display = 'flex';
                        
                        // 設置用戶信息
                        document.getElementById('userName').textContent = currentUser;
                        document.getElementById('userRole').textContent = currentRole === 'teacher' ? '老師' : '學生';
                        document.getElementById('displayClassCode').textContent = currentClassCode;
                        document.getElementById('userAvatar').textContent = currentRole === 'teacher' ? '👩‍🏫' : '👨‍🎓';
                        
                        // 設置聊天標題
                        document.getElementById('chatTitle').textContent = currentRole === 'teacher' ? 
                            `${currentClassCode} 班級聊天室` : `${currentClassCode} 班級聊天室`;
                    }
                    
                    // 如果是重連，發送重新加入訊息
                    if (reconnectAttempts > 0) {
                        const reconnectMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'reconnect',
                            content: `${currentRole === 'teacher' ? '老師' : '學生'} ${currentUser} 重新加入了聊天室`,
                            timestamp: new Date().toISOString()
                        };
                        
                        client.publish(classTopic, JSON.stringify(reconnectMessage));
                    } else {
                        // 首次連接，發送加入通知
                        const joinMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'join',
                            content: `${currentRole === 'teacher' ? '老師' : '學生'} ${currentUser} 加入了聊天室`,
                            timestamp: new Date().toISOString()
                        };
                        
                        client.publish(classTopic, JSON.stringify(joinMessage));
                    }
                    
                    // 發送狀態更新
                    const statusMessage = {
                        sender: currentUser,
                        role: currentRole,
                        type: 'join',
                        timestamp: new Date().toISOString()
                    };
                    
                    client.publish(statusTopic, JSON.stringify(statusMessage));
                    
                    // 將自己加入在線列表
                    onlineUsers.set(currentUser, {
                        name: currentUser,
                        role: currentRole,
                        lastActive: new Date().getTime()
                    });
                    updateOnlineUsersList();
                    
                    // 啟動心跳機制
                    startHeartbeat();
                    
                    // 啟動在線名單更新機制
                    startOnlineListUpdate();
                });
                
                client.on('message', function(topic, message) {
                    const msgData = JSON.parse(message.toString());
                    
                    if (topic.includes('/status')) {
                        // 處理狀態更新
                        handleStatusUpdate(msgData);
                    } else if (topic.includes('/heartbeat')) {
                        // 處理心跳
                        handleHeartbeat(msgData);
                    } else {
                        // 處理聊天訊息
                        displayMessage(msgData);
                    }
                });
                
                client.on('error', function(err) {
                    console.error('MQTT 連接錯誤:', err);
                });
                
                client.on('close', function() {
                    console.log('MQTT 連接關閉');
                    // 檢查是否是正常登出
                    const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
                    if (!isReconnecting && !isNormalLogout) {
                        handleDisconnect();
                    }
                });
                
                client.on('offline', function() {
                    console.log('MQTT 連接離線');
                    // 檢查是否是正常登出
                    const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
                    if (!isReconnecting && !isNormalLogout) {
                        handleDisconnect();
                    }
                });
                
                client.on('reconnect', function() {
                    console.log('MQTT 正在重連...');
                    isReconnecting = true;
                    reconnectAttempts++;
                });
                
                // 處理頁面關閉事件
                window.addEventListener('beforeunload', function() {
                    if (client && client.connected && !isLoggingOut) {
                        const statusTopic = `classroom/${currentClassCode}/status`;
                        const leaveMessage = {
                            sender: currentUser,
                            role: currentRole,
                            type: 'leave',
                            timestamp: new Date().toISOString()
                        };
                        client.publish(statusTopic, JSON.stringify(leaveMessage));
                    }
                });
                
            } catch (error) {
                console.error('MQTT 初始化錯誤:', error);
                alert('無法連接到聊天服務器');
            }
        }
        
        // 處理斷連
        function handleDisconnect() {
            // 檢查是否是正常登出
            const isNormalLogout = localStorage.getItem('isLoggingOut') === 'true';
            if (isNormalLogout) {
                return;
            }
            
            // 清除定時器
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            if (updateOnlineListInterval) {
                clearInterval(updateOnlineListInterval);
            }
            
            // 顯示斷連訊息
            const disconnectMessage = {
                sender: currentUser,
                role: currentRole,
                type: 'disconnect',
                content: `${currentRole === 'teacher' ? '老師' : '學生'} ${currentUser} 因網路問題已離開`,
                timestamp: new Date().toISOString()
            };
            
            displayMessage(disconnectMessage);
            
            // 從在線名單中移除自己
            onlineUsers.delete(currentUser);
            updateOnlineUsersList();
            
            // 顯示連接狀態提示
            document.getElementById('connectionStatus').style.display = 'block';
            document.getElementById('connectionMessage').textContent = '網路連接中斷，請稍後重連...';
        }
        
        // 手動重連
        function reconnect() {
            document.getElementById('connectionMessage').textContent = '正在重新連接...';
            document.getElementById('connectionStatus').style.display = 'block';
            
            if (client) {
                client.reconnect();
            } else {
                connectToMQTT();
            }
        }
        
        // 啟動心跳機制
        function startHeartbeat() {
            // 每10秒發送一次心跳
            heartbeatInterval = setInterval(function() {
                if (client && client.connected) {
                    const heartbeatTopic = `classroom/${currentClassCode}/heartbeat`;
                    const heartbeatMessage = {
                        sender: currentUser,
                        role: currentRole,
                        timestamp: new Date().toISOString()
                    };
                    client.publish(heartbeatTopic, JSON.stringify(heartbeatMessage));
                    
                    // 更新自己的最後活動時間
                    if (onlineUsers.has(currentUser)) {
                        const user = onlineUsers.get(currentUser);
                        user.lastActive = new Date().getTime();
                        onlineUsers.set(currentUser, user);
                    }
                }
            }, 10000);
        }
        
        // 啟動在線名單更新機制
        function startOnlineListUpdate() {
            // 每10秒更新一次在線名單
            updateOnlineListInterval = setInterval(function() {
                const now = new Date().getTime();
                const timeout = 20000; // 20秒沒有心跳視為離線
                
                // 移除超時的用戶
                for (const [username, user] of onlineUsers.entries()) {
                    if (now - user.lastActive > timeout) {
                        onlineUsers.delete(username);
                    }
                }
                
                updateOnlineUsersList();
            }, 10000);
        }
        
        // 處理心跳
        function handleHeartbeat(msgData) {
            if (onlineUsers.has(msgData.sender)) {
                const user = onlineUsers.get(msgData.sender);
                user.lastActive = new Date().getTime();
                onlineUsers.set(msgData.sender, user);
            } else {
                // 如果用戶不在列表中，添加他
                onlineUsers.set(msgData.sender, {
                    name: msgData.sender,
                    role: msgData.role,
                    lastActive: new Date().getTime()
                });
            }
        }
        
        // 處理狀態更新
        function handleStatusUpdate(msgData) {
            if (msgData.type === 'join') {
                // 用戶加入
                onlineUsers.set(msgData.sender, {
                    name: msgData.sender,
                    role: msgData.role,
                    lastActive: new Date().getTime()
                });
            } else if (msgData.type === 'leave') {
                // 用戶離開
                onlineUsers.delete(msgData.sender);
            }
            updateOnlineUsersList();
        }
        
        // 更新在線用戶列表
        function updateOnlineUsersList() {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '';
            
            // 按角色排序（老師在前）
            const sortedUsers = Array.from(onlineUsers.values()).sort((a, b) => {
                if (a.role === 'teacher' && b.role !== 'teacher') return -1;
                if (a.role !== 'teacher' && b.role === 'teacher') return 1;
                return 0;
            });
            
            sortedUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'online-user';
                
                const avatar = user.role === 'teacher' ? '👩‍🏫' : '👨‍🎓';
                const roleText = user.role === 'teacher' ? '老師' : '學生';
                
                userElement.innerHTML = `
                    <div class="online-user-avatar">${avatar}</div>
                    <div class="online-user-info">
                        <div class="online-user-name">${user.name}</div>
                        <div class="online-user-role">${roleText}</div>
                    </div>
                    <span class="online-indicator"></span>
                `;
                
                onlineUsersList.appendChild(userElement);
            });
            
            // 如果沒有在線用戶
            if (sortedUsers.length === 0) {
                onlineUsersList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">目前沒有在線用戶</div>';
            }
        }
        
        // 發送訊息
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const classTopic = `classroom/${currentClassCode}`;
            const message = {
                sender: currentUser,
                role: currentRole,
                type: 'message',
                content: content,
                timestamp: new Date().toISOString()
            };
            
            client.publish(classTopic, JSON.stringify(message));
            messageInput.value = '';
        }
        
        // 顯示訊息
        function displayMessage(msgData) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            
            // 設置訊息類型
            if (msgData.type === 'join' || msgData.type === 'leave' || msgData.type === 'disconnect' || msgData.type === 'reconnect') {
                // 檢查是否已經顯示過這個系統訊息
                const messageKey = `${msgData.type}-${msgData.sender}-${msgData.timestamp}`;
                if (displayedSystemMessages.has(messageKey)) {
                    return; // 已經顯示過，不再重複顯示
                }
                
                // 記錄已顯示的系統訊息
                displayedSystemMessages.add(messageKey);
                
                messageElement.className = 'message system-message';
                messageElement.style.textAlign = 'center';
                messageElement.style.backgroundColor = '#e1f5fe';
                messageElement.style.margin = '10px auto';
                messageElement.style.maxWidth = '70%';
                
                // 根據訊息類型設置不同的背景色
                if (msgData.type === 'disconnect') {
                    messageElement.style.backgroundColor = '#ffebee'; // 斷連用淡紅色
                } else if (msgData.type === 'reconnect') {
                    messageElement.style.backgroundColor = '#e8f5e9'; // 重連用淡綠色
                }
                
                messageElement.innerHTML = `<div class="message-content">${msgData.content}</div>`;
            } else {
                // 根據發送者是否為本人來決定訊息位置
                if (msgData.sender === currentUser) {
                    messageElement.className = 'message self-message';
                } else {
                    messageElement.className = 'message other-message';
                }
                
                // 格式化時間
                const timestamp = new Date(msgData.timestamp);
                const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-info">${msgData.sender} (${msgData.role === 'teacher' ? '老師' : '學生'}) - ${timeString}</div>
                    <div class="message-content">${msgData.content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 登出
        function logout() {
            // 設置登出標誌到 localStorage
            localStorage.setItem('isLoggingOut', 'true');
            
            // 設置登出標誌
            isLoggingOut = true;
            
            // 清除定時器
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            if (updateOnlineListInterval) {
                clearInterval(updateOnlineListInterval);
            }
            
            // 立即隱藏連接狀態提示（防止登出後顯示）
            document.getElementById('connectionStatus').style.display = 'none';
            
            if (client && client.connected) {
                const classTopic = `classroom/${currentClassCode}`;
                const statusTopic = `classroom/${currentClassCode}/status`;
                
                const leaveMessage = {
                    sender: currentUser,
                    role: currentRole,
                    type: 'leave',
                    content: `${currentRole === 'teacher' ? '老師' : '學生'} ${currentUser} 離開了聊天室`,
                    timestamp: new Date().toISOString()
                };
                
                client.publish(classTopic, JSON.stringify(leaveMessage));
                client.publish(statusTopic, JSON.stringify({
                    sender: currentUser,
                    role: currentRole,
                    type: 'leave',
                    timestamp: new Date().toISOString()
                }));
                
                // 正常斷開連接，不觸發will消息
                client.end();
            }
            
            // 重置頁面
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('messagesContainer').innerHTML = '';
            backToRoleSelection();
            
            // 清空表單
            document.getElementById('teacherUsername').value = '';
            document.getElementById('teacherPassword').value = '';
            document.getElementById('classCode').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClassCode').value = '';
            
            // 清空在線用戶列表和已顯示的系統訊息
            onlineUsers.clear();
            displayedSystemMessages.clear();
            document.getElementById('onlineUsersList').innerHTML = '';
            
            // 重置連接狀態
            reconnectAttempts = 0;
            isReconnecting = false;
            isLoggingOut = false;
            
            // 清除 localStorage 中的登出標記
            localStorage.removeItem('isLoggingOut');
        }
        
        // 監聽Enter鍵發送訊息
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>