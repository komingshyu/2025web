<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課表查詢系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 原有樣式保持不變 */
        * {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 200px;
            height: 40px;
        }
        
        .file-input-label {
            display: block;
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
            width: 200px;
        }
        
        .file-input-label:hover {
            background-color: #2980b9;
        }
        
        .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
            transition: border-color 0.3s;
        }
        
        .class-select:focus, .teacher-select:focus, .subject-select:focus, .day-select:focus, .period-select:focus, .swap-teacher-select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-btn, .export-btn, .download-btn, .toggle-btn, .print-btn, .close-json-btn, .swap-btn, .customize-btn {
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .search-btn {
            background-color: #2ecc71;
        }
        
        .search-btn:hover {
            background-color: #27ae60;
        }
        
        .export-btn {
            background-color: #9b59b6;
        }
        
        .export-btn:hover {
            background-color: #8e44ad;
        }
        
        .download-btn {
            background-color: #e67e22;
        }
        
        .download-btn:hover {
            background-color: #d35400;
        }
        
        .toggle-btn {
            background-color: #3498db;
        }
        
        .toggle-btn:hover {
            background-color: #2980b9;
        }
        
        .print-btn {
            background-color: #e74c3c;
        }
        
        .print-btn:hover {
            background-color: #c0392b;
        }
        
        .swap-btn {
            background-color: #f39c12;
            font-size: 14px;
            padding: 5px 10px;
            margin-top: 5px;
        }
        
        .swap-btn:hover {
            background-color: #e67e22;
        }
        
        .close-json-btn {
            background-color: #95a5a6;
            margin-left: 10px;
        }
        
        .close-json-btn:hover {
            background-color: #7f8c8d;
        }
        
        .customize-btn {
            background-color: #16a085;
        }
        
        .customize-btn:hover {
            background-color: #138d75;
        }
        
        .file-name {
            margin-left: 15px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .schedule-container {
            overflow-x: auto;
        }
        
        .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, 
        .period-table th, .period-table td, .swap-table th, .swap-table td,
        .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
            border: 2px solid #2c3e50;
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
        }
        
        .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            position: sticky;
            top: 0;
        }
        
        .schedule-table tr:nth-child(even), .subject-table tr:nth-child(even), 
        .period-table tr:nth-child(even), .swap-table tr:nth-child(even),
        .swap-result-table tr:nth-child(even), .class-swap-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .schedule-table tr:hover, .subject-table tr:hover, 
        .period-table tr:hover, .swap-table tr:hover,
        .swap-result-table tr:hover, .class-swap-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .time-slot {
            background-color: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            width: 80px;
        }
        
        .course-cell, .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
        }
        
        .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 4px;
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
        }
        
        .course-item:last-child, .subject-item:last-child, .period-item:last-child, .swap-item:last-child, .class-swap-item:last-child {
            margin-bottom: 0;
        }
        
        .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .teacher-name, .class-name {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .clickable {
            cursor: pointer;
            text-decoration: none;
            color: #3498db;
        }
        
        .clickable:hover {
            color: #2980b9;
        }
        
        .teacher-link {
            color: #27ae60; /* 深綠色 */
        }
        
        .teacher-link:hover {
            color: #229954; /* 深綠色的懸停顏色 */
        }
        
        .free-teacher {
            color: #d35400; /* 橘棕色 */
        }
        
        .available-slot {
            color: #27ae60;
            font-weight: bold;
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 3px solid #27ae60;
            padding: 6px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .empty-cell {
            color: #bdc3c7;
            font-style: italic;
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        
        .error {
            background-color: #ffecec;
            color: #e74c3c;
            border: 1px solid #f5aca6;
        }
        
        .success {
            background-color: #e8f8f5;
            color: #2ecc71;
            border: 1px solid #a9e8d3;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .json-display {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            position: relative;
        }
        
        .json-display pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9em;
        }
        
        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .json-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .subject-table th, .subject-table td, .period-table th, .period-table td,
        .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td,
        .class-swap-table th, .class-swap-table td {
            border: 2px solid #2c3e50;
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
        }
        
        .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .subject-table tr:nth-child(even), .period-table tr:nth-child(even),
        .swap-table tr:nth-child(even), .swap-result-table tr:nth-child(even), .class-swap-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .subject-table tr:hover, .period-table tr:hover,
        .swap-table tr:hover, .swap-result-table tr:hover, .class-swap-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .instructions h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .instructions h3 {
            color: #3498db;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .instructions ol, .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .instructions table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .instructions table th, .instructions table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .instructions table th {
            background-color: #f1f1f1;
        }
        
        .lunch-break {
            background-color: #fff9e6;
            color: #f39c12;
            font-weight: bold;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        
        .print-area {
            margin-top: 20px;
        }
        
        /* 新增樣式用於科目查詢的表格顯示 */
        .grade-header {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
        }
        
        .grade-separator {
            height: 20px;
            background-color: #f5f7fa;
        }
        
        .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }
        
        .subject-cell .class-name, .subject-cell .teacher-name, 
        .period-cell .class-name, .period-cell .teacher-name, 
        .period-cell .subject-name, .swap-cell .class-name, 
        .swap-cell .teacher-name, .swap-cell .subject-name,
        .class-swap-cell .class-name, .class-swap-cell .teacher-name, 
        .class-swap-cell .subject-name {
            display: block;
            margin: 5px 0;
        }
        
        .no-teacher-header {
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
            margin-top: 30px;
        }
        
        .swap-result-section {
            margin-top: 30px;
        }
        
        .swap-teacher-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .swap-teacher-info h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .swap-teacher-info p {
            margin-bottom: 5px;
        }
        
        .class-swap-section {
            margin-top: 30px;
        }
        
        .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        /* 空堂樣式 */
        .empty-slot {
            color: #bdc3c7;
            font-style: italic;
            font-size: 0.9em;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            background-color: #fafafa;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 功能選擇區域樣式 */
        .feature-selection {
            margin-bottom: 20px;
        }
        
        .feature-selection h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .feature-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .feature-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            transition: background-color 0.3s;
        }
        
        .feature-option:hover {
            background-color: #f1f1f1;
        }
        
        .feature-option input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .feature-option label {
            cursor: pointer;
            flex-grow: 1;
        }
        
        .feature-description {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .file-input-label, .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select, .search-btn, .export-btn, .download-btn, .toggle-btn, .print-btn, .close-json-btn {
                width: 100%;
            }
            
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.9rem;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 8px 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .json-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.8rem;
            }
            
            .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 6px 8px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
            
            .feature-options {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* 列印樣式優化 */
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                border-collapse: collapse !important;
                width: 100% !important;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                border: 2px solid #000 !important;
                padding: 8px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
                background-color: #2c3e50 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 1.1rem !important;
            }
            
            .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
                font-size: 1.8rem !important;
                font-weight: bold !important;
                margin-bottom: 20px !important;
                color: #000 !important;
            }
            
            .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
                border-left: 3px solid #3498db !important;
                background-color: rgba(52, 152, 219, 0.1) !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-bottom: 8px !important;
                page-break-inside: avoid;
            }
            
            .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
                font-weight: bold !important;
                color: #000 !important;
                margin-bottom: 4px !important;
            }
            
            .detail-name {
                color: #333 !important;
                font-size: 0.9em !important;
            }
            
            .lunch-break {
                background-color: #fff9e6 !important;
                color: #f39c12 !important;
                font-weight: bold !important;
            }
            
            .grade-header, .no-teacher-header {
                background-color: #3498db !important;
                color: white !important;
                font-weight: bold !important;
                text-align: center !important;
                padding: 10px !important;
                font-size: 1.2rem !important;
            }
            
            .no-teacher-header {
                background-color: #e74c3c !important;
            }
            
            .clickable {
                text-decoration: none !important;
            }
            
            .teacher-link {
                color: #27ae60 !important;
            }
            
            .free-teacher {
                color: #d35400 !important;
            }
            
            .available-slot {
                color: #27ae60 !important;
                font-weight: bold !important;
                background-color: rgba(39, 174, 96, 0.1) !important;
                border-left: 3px solid #27ae60 !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-top: 5px !important;
            }
            
            .empty-slot {
                color: #999 !important;
                font-style: italic !important;
                border: 1px dashed #ccc !important;
                background-color: #f9f9f9 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>教學組專用課表查詢系統V6.0</h1>
        
        <div class="input-section">
            <button id="toggle-instructions" class="toggle-btn">顯示使用說明</button>
        </div>
        
        <div class="input-section">
            <div class="file-input-wrapper">
                <input type="file" id="file-input" accept=".xlsx, .xls">
                <label for="file-input" class="file-input-label">選擇課表檔案</label>
            </div>
            <span id="file-name" class="file-name">未選擇檔案</span>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="class">班級課表查詢</button>
                <button class="tab-button" data-tab="teacher">教師課表查詢</button>
                <button class="tab-button" data-tab="subject">科目查詢</button>
                <button class="tab-button" data-tab="period">節次任課查詢</button>
                <button class="tab-button" data-tab="swap">同班無課教師查詢</button>
                <button class="tab-button" data-tab="weekly-subject">每週科目課表</button>
            </div>
            
            <div id="class-tab" class="tab-content active">
                <div class="input-section">
                    <select id="class-select" class="class-select">
                        <option value="">請選擇班級</option>
                    </select>
                    <button id="search-class-btn" class="search-btn">查詢班級課表</button>
                    <button id="print-class-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="teacher-tab" class="tab-content">
                <div class="input-section">
                    <select id="teacher-select" class="teacher-select">
                        <option value="">請選擇教師</option>
                    </select>
                    <button id="search-teacher-btn" class="search-btn">查詢教師課表</button>
                    <button id="print-teacher-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="subject-tab" class="tab-content">
                <div class="input-section">
                    <select id="subject-select" class="subject-select">
                        <option value="">請選擇科目</option>
                    </select>
                    <button id="search-subject-btn" class="search-btn">查詢科目任課教師</button>
                    <button id="print-subject-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="period-tab" class="tab-content">
                <div class="input-section">
                    <select id="day-select" class="day-select">
                        <option value="">請選擇星期</option>
                        <option value="1">星期一</option>
                        <option value="2">星期二</option>
                        <option value="3">星期三</option>
                        <option value="4">星期四</option>
                        <option value="5">星期五</option>
                    </select>
                    <select id="period-select" class="period-select">
                        <option value="">請選擇節次</option>
                        <option value="1">第1節</option>
                        <option value="2">第2節</option>
                        <option value="3">第3節</option>
                        <option value="4">第4節</option>
                        <option value="5">第5節</option>
                        <option value="6">第6節</option>
                        <option value="7">第7節</option>
                        <option value="8">第8節</option>
                    </select>
                    <button id="search-period-btn" class="search-btn">查詢節次任課</button>
                    <button id="print-period-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="swap-tab" class="tab-content">
                <div class="input-section">
                    <select id="swap-teacher-select" class="swap-teacher-select">
                        <option value="">請選擇教師</option>
                    </select>
                    <button id="search-swap-btn" class="search-btn">查詢教師課表</button>
                    <button id="print-swap-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="weekly-subject-tab" class="tab-content">
                <div class="input-section">
                    <select id="weekly-subject-select" class="subject-select">
                        <option value="">請選擇科目</option>
                    </select>
                    <button id="search-weekly-subject-btn" class="search-btn">查詢每週科目課表</button>
                    <button id="print-weekly-subject-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
        </div>
        
        <div class="input-section no-print">
            <button id="export-json-btn" class="export-btn">匯出JSON</button>
            <div class="export-options">
                <button id="download-combined-btn" class="download-btn">下載綜合查詢頁面</button>
                <button id="customize-download-btn" class="customize-btn">自訂查詢頁面</button>
            </div>
        </div>
        
        <div id="notification" class="notification"></div>
        
        <div id="json-display" class="json-display no-print">
            <div class="json-header">
                <div class="json-title">JSON資料</div>
                <button id="close-json-btn" class="close-json-btn">關閉</button>
            </div>
            <pre id="json-content"></pre>
        </div>
        
        <div class="print-area">
            <div id="schedule-header" class="schedule-header" style="display: none;"></div>
            <div id="subject-header" class="subject-header" style="display: none;"></div>
            <div id="period-header" class="period-header" style="display: none;"></div>
            <div id="swap-header" class="swap-header" style="display: none;"></div>
            <div id="swap-result-header" class="swap-result-header" style="display: none;"></div>
            <div id="class-swap-header" class="class-swap-header" style="display: none;"></div>
            <div id="weekly-subject-header" class="schedule-header" style="display: none;"></div>
            <div class="schedule-container">
                <table id="schedule-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <!-- 課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="subject-table" class="subject-table" style="display: none;">
                    <tbody id="subject-body">
                        <!-- 科目任課教師內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="period-table" class="period-table" style="display: none;">
                    <tbody id="period-body">
                        <!-- 節次任課內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="swap-table" class="swap-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="swap-body">
                        <!-- 調課查詢內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="swap-result-section" class="swap-result-section" style="display: none;">
                    <div id="swap-teacher-info" class="swap-teacher-info" style="display: none;">
                        <h3>調課資訊</h3>
                        <p><strong>教師：</strong><span id="swap-teacher-name"></span></p>
                        <p><strong>調課時間：</strong><span id="swap-time"></span></p>
                        <p><strong>班級：</strong><span id="swap-class"></span></p>
                        <p><strong>科目：</strong><span id="swap-subject"></span></p>
                    </div>
                    
                    <table id="swap-result-table" class="swap-result-table">
                        <thead>
                            <tr>
                                <th>教師</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="swap-result-body">
                            <!-- 調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="class-swap-section" class="class-swap-section" style="display: none;">
                    <table id="class-swap-table" class="class-swap-table">
                        <thead>
                            <tr>
                                <th>節次</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="class-swap-body">
                            <!-- 班級調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <table id="weekly-subject-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-subject-body">
                        <!-- 每週科目課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="no-data" class="no-data" style="display: none;">
                    請上傳課表檔案並進行查詢
                </div>
            </div>
        </div>
        
        <div class="legend no-print">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>表頭</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ecf0f1;"></div>
                <span>節次</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f9f9f9;"></div>
                <span>課程內容</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>班級連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>教師連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d35400;"></div>
                <span>無課務教師</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>有空堂</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff9e6;"></div>
                <span>午休分隔</span>
            </div>
        </div>
        
        <div class="footer no-print">
            本網頁程式 design by koming 2025
        </div>
    </div>

    <!-- 使用說明 Modal -->
    <div id="instructions-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="instructions">
                <h2>使用說明</h2>
                
                <h3>使用流程</h3>
                <ol>
                    <li>點擊「選擇課表檔案」按鈕，上傳課表Excel檔案</li>
                    <li>系統自動解析檔案並轉換為JSON格式</li>
                    <li>切換標籤頁選擇查詢類型：
                        <ul>
                            <li><strong>班級課表查詢</strong>：從下拉選單選擇班級代碼</li>
                            <li><strong>教師課表查詢</strong>：從下拉選單選擇教師姓名</li>
                            <li><strong>科目查詢</strong>：從下拉選單選擇科目名稱</li>
                            <li><strong>節次任課查詢</strong>：從下拉選單選擇星期和節次</li>
                            <li><strong>同班無課教師查詢</strong>：從下拉選單選擇教師姓名，點擊課表中的「調課」按鈕</li>
                            <li><strong>每週科目課表</strong>：從下拉選單選擇科目名稱，顯示一週該科目課表</li>
                        </ul>
                    </li>
                    <li>點擊「查詢」按鈕查看課表</li>
                    <li>點擊「匯出JSON」查看JSON資料</li>
                    <li>點擊「下載綜合查詢頁面」取得獨立HTML檔案</li>
                    <li>點擊「自訂查詢頁面」選擇需要的功能並生成對應的查詢頁面</li>
                </ol>
                
                <h3>同班無課教師查詢使用說明</h3>
                <ol>
                    <li>從下拉選單選擇要查詢的教師姓名</li>
                    <li>點擊「查詢教師課表」按鈕，顯示該教師的一周課表</li>
                    <li>課表中每個節次顯示班級、科目和「調課」按鈕</li>
                    <li>點擊某個節次的「調課」按鈕，系統會：
                        <ul>
                            <li>找出該教師所有無課務的節次（B陣列）</li>
                            <li>找出在同一班級中，B陣列節次有課務(任教該班)且在點擊的節次（A）無課務的教師</li>
                            <li>顯示該班級的課表，並在可調課教師的B陣列節次標示「有空堂」</li>
                        </ul>
                    </li>
                </ol>
                
                <h3>試算表格式說明</h3>
                <p>課表Excel檔案應包含以下欄位：</p>
                <table>
                    <thead>
                        <tr>
                            <th>欄位名稱</th>
                            <th>說明</th>
                            <th>範例</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>班級代碼</td>
                            <td>班級的唯一識別碼</td>
                            <td>101</td>
                        </tr>
                        <tr>
                            <td>班級名稱</td>
                            <td>班級的完整名稱（可選）</td>
                            <td>一年甲班</td>
                        </tr>
                        <tr>
                            <td>科目名稱</td>
                            <td>課程科目名稱</td>
                            <td>數學</td>
                        </tr>
                        <tr>
                            <td>教師名稱</td>
                            <td>授課教師姓名</td>
                            <td>張老師</td>
                        </tr>
                        <tr>
                            <td>星期</td>
                            <td>上課星期（1-5）</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>節次</td>
                            <td>上課節次（1-8）</td>
                            <td>2</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>範例資料</h3>
                <p>以下是課表檔案的範例資料：</p>
                <table>
                    <thead>
                        <tr>
                            <th>班級代碼</th>
                            <th>班級名稱</th>
                            <th>科目名稱</th>
                            <th>教師名稱</th>
                            <th>星期</th>
                            <th>節次</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>101</td>
                            <td>一年甲班</td>
                            <td>數學</td>
                            <td>張老師</td>
                            <td>1</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>101</td>
                            <td>一年甲班</td>
                            <td>國文</td>
                            <td>李老師</td>
                            <td>1</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>一年乙班</td>
                            <td>數學</td>
                            <td>張老師</td>
                            <td>1</td>
                            <td>3</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>一年乙班</td>
                            <td>英文</td>
                            <td>王老師</td>
                            <td>2</td>
                            <td>1</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 功能選擇 Modal -->
    <div id="feature-selection-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="feature-selection">
                <h3>選擇查詢功能</h3>
                <p>請勾選您需要的查詢功能，系統將根據您的選擇生成對應的查詢頁面。</p>
                
                <div class="feature-options">
                    <div class="feature-option">
                        <input type="checkbox" id="feature-class" value="class" checked>
                        <label for="feature-class">
                            <div>班級課表查詢</div>
                            <div class="feature-description">查詢各班級的完整週課表</div>
                        </label>
                    </div>
                    
                    <div class="feature-option">
                        <input type="checkbox" id="feature-teacher" value="teacher" checked>
                        <label for="feature-teacher">
                            <div>教師課表查詢</div>
                            <div class="feature-description">查詢各教師的完整週課表</div>
                        </label>
                    </div>
                    
                    <div class="feature-option">
                        <input type="checkbox" id="feature-subject" value="subject" checked>
                        <label for="feature-subject">
                            <div>科目查詢</div>
                            <div class="feature-description">查詢各科目的任課教師和班級</div>
                        </label>
                    </div>
                    
                    <div class="feature-option">
                        <input type="checkbox" id="feature-period" value="period" checked>
                        <label for="feature-period">
                            <div>節次任課查詢</div>
                            <div class="feature-description">查詢特定節次的任課教師和班級</div>
                        </label>
                    </div>
                    
                    <div class="feature-option">
                        <input type="checkbox" id="feature-swap" value="swap" checked>
                        <label for="feature-swap">
                            <div>同班無課教師查詢</div>
                            <div class="feature-description">查詢可調課的教師和時段</div>
                        </label>
                    </div>
                    
                    <div class="feature-option">
                        <input type="checkbox" id="feature-weekly-subject" value="weekly-subject" checked>
                        <label for="feature-weekly-subject">
                            <div>每週科目課表</div>
                            <div class="feature-description">查詢特定科目的一週課表</div>
                        </label>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="select-all-features" class="search-btn">全選</button>
                    <button id="deselect-all-features" class="export-btn">取消全選</button>
                    <button id="generate-custom-page" class="download-btn">生成自訂頁面</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');
            const classSelect = document.getElementById('class-select');
            const teacherSelect = document.getElementById('teacher-select');
            const subjectSelect = document.getElementById('subject-select');
            const daySelect = document.getElementById('day-select');
            const periodSelect = document.getElementById('period-select');
            const swapTeacherSelect = document.getElementById('swap-teacher-select');
            const weeklySubjectSelect = document.getElementById('weekly-subject-select');
            const searchClassBtn = document.getElementById('search-class-btn');
            const searchTeacherBtn = document.getElementById('search-teacher-btn');
            const searchSubjectBtn = document.getElementById('search-subject-btn');
            const searchPeriodBtn = document.getElementById('search-period-btn');
            const searchSwapBtn = document.getElementById('search-swap-btn');
            const searchWeeklySubjectBtn = document.getElementById('search-weekly-subject-btn');
            const printClassBtn = document.getElementById('print-class-btn');
            const printTeacherBtn = document.getElementById('print-teacher-btn');
            const printSubjectBtn = document.getElementById('print-subject-btn');
            const printPeriodBtn = document.getElementById('print-period-btn');
            const printSwapBtn = document.getElementById('print-swap-btn');
            const printWeeklySubjectBtn = document.getElementById('print-weekly-subject-btn');
            const exportJsonBtn = document.getElementById('export-json-btn');
            const downloadCombinedBtn = document.getElementById('download-combined-btn');
            const customizeDownloadBtn = document.getElementById('customize-download-btn');
            const toggleInstructionsBtn = document.getElementById('toggle-instructions');
            const closeJsonBtn = document.getElementById('close-json-btn');
            const scheduleHeader = document.getElementById('schedule-header');
            const subjectHeader = document.getElementById('subject-header');
            const periodHeader = document.getElementById('period-header');
            const swapHeader = document.getElementById('swap-header');
            const swapResultHeader = document.getElementById('swap-result-header');
            const classSwapHeader = document.getElementById('class-swap-header');
            const weeklySubjectHeader = document.getElementById('weekly-subject-header');
            const scheduleTable = document.getElementById('schedule-table');
            const subjectTable = document.getElementById('subject-table');
            const periodTable = document.getElementById('period-table');
            const swapTable = document.getElementById('swap-table');
            const swapResultTable = document.getElementById('swap-result-table');
            const classSwapTable = document.getElementById('class-swap-table');
            const weeklySubjectTable = document.getElementById('weekly-subject-table');
            const scheduleBody = document.getElementById('schedule-body');
            const subjectBody = document.getElementById('subject-body');
            const periodBody = document.getElementById('period-body');
            const swapBody = document.getElementById('swap-body');
            const swapResultBody = document.getElementById('swap-result-body');
            const classSwapBody = document.getElementById('class-swap-body');
            const weeklySubjectBody = document.getElementById('weekly-subject-body');
            const swapResultSection = document.getElementById('swap-result-section');
            const classSwapSection = document.getElementById('class-swap-section');
            const swapTeacherInfo = document.getElementById('swap-teacher-info');
            const swapTeacherName = document.getElementById('swap-teacher-name');
            const swapTime = document.getElementById('swap-time');
            const swapClass = document.getElementById('swap-class');
            const swapSubject = document.getElementById('swap-subject');
            const noData = document.getElementById('no-data');
            const notification = document.getElementById('notification');
            const jsonDisplay = document.getElementById('json-display');
            const jsonContent = document.getElementById('json-content');
            
            // 功能選擇相關元素
            const featureSelectionModal = document.getElementById('feature-selection-modal');
            const selectAllFeaturesBtn = document.getElementById('select-all-features');
            const deselectAllFeaturesBtn = document.getElementById('deselect-all-features');
            const generateCustomPageBtn = document.getElementById('generate-custom-page');
            
            // Modal 元素
            const modal = document.getElementById('instructions-modal');
            const closeBtn = document.querySelector('.close');
            
            // 標籤頁功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // 移除所有標籤的active類
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 為當前標籤添加active類
                    button.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // 使用說明 Modal 功能
            toggleInstructionsBtn.addEventListener('click', function() {
                modal.style.display = 'block';
            });
            
            // 點擊關閉按鈕關閉 Modal
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // 功能選擇 Modal 功能
            customizeDownloadBtn.addEventListener('click', function() {
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                featureSelectionModal.style.display = 'block';
            });
            
            // 全選功能
            selectAllFeaturesBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.feature-option input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            
            // 取消全選功能
            deselectAllFeaturesBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.feature-option input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            
            // 生成自訂頁面
            generateCustomPageBtn.addEventListener('click', function() {
                const selectedFeatures = [];
                const checkboxes = document.querySelectorAll('.feature-option input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    showNotification('請至少選擇一個功能', 'error');
                    return;
                }
                
                checkboxes.forEach(checkbox => {
                    selectedFeatures.push(checkbox.value);
                });
                
                const standaloneHtml = generateCustomStandaloneHtml(jsonData, selectedFeatures);
                downloadFile(standaloneHtml, 'custom-schedule-query.html', 'text/html');
                showNotification('自訂查詢頁面已下載', 'success');
                featureSelectionModal.style.display = 'none';
            });
            
            // 點擊 Modal 外部關閉 Modal
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
                if (event.target == featureSelectionModal) {
                    featureSelectionModal.style.display = 'none';
                }
            });
            
            // 關閉JSON顯示區域
            closeJsonBtn.addEventListener('click', function() {
                jsonDisplay.style.display = 'none';
            });
            
            let scheduleData = [];
            let jsonData = null;
            let currentQueryType = 'class';
            let currentSwapTeacher = null;
            
            // 監聽檔案選擇
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    fileName.textContent = file.name;
                    readExcelFile(file);
                } else {
                    fileName.textContent = '未選擇檔案';
                }
            });
            
            // 監聽班級查詢按鈕
            searchClassBtn.addEventListener('click', function() {
                const classCode = classSelect.value;
                if (!classCode) {
                    showNotification('請選擇班級', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'class';
                displaySchedule(classCode, 'class');
            });
            
            // 監聽教師查詢按鈕
            searchTeacherBtn.addEventListener('click', function() {
                const teacherName = teacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'teacher';
                displaySchedule(teacherName, 'teacher');
            });
            
            // 監聽科目查詢按鈕
            searchSubjectBtn.addEventListener('click', function() {
                const subjectName = subjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'subject';
                displaySubjectSchedule(subjectName);
            });
            
            // 監聽節次查詢按鈕
            searchPeriodBtn.addEventListener('click', function() {
                const day = daySelect.value;
                const period = periodSelect.value;
                
                if (!day) {
                    showNotification('請選擇星期', 'error');
                    return;
                }
                
                if (!period) {
                    showNotification('請選擇節次', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'period';
                displayPeriodSchedule(day, period);
            });
            
            // 監聽調課查詢按鈕
            searchSwapBtn.addEventListener('click', function() {
                const teacherName = swapTeacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'swap';
                currentSwapTeacher = teacherName;
                displaySwapSchedule(teacherName);
            });
            
            // 監聽每週科目課表查詢按鈕
            searchWeeklySubjectBtn.addEventListener('click', function() {
                const subjectName = weeklySubjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                if (!jsonData) {
                    showNotification('請先上傳課表檔案', 'error');
                    return;
                }
                
                currentQueryType = 'weekly-subject';
                displayWeeklySubjectSchedule(subjectName);
            });
            
            // 監聽班級課表列印按鈕
            printClassBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢班級課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽教師課表列印按鈕
            printTeacherBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢教師課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽科目課表列印按鈕
            printSubjectBtn.addEventListener('click', function() {
                if (subjectTable.style.display === 'none') {
                    showNotification('請先查詢科目課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽節次課表列印按鈕
            printPeriodBtn.addEventListener('click', function() {
                if (periodTable.style.display === 'none') {
                    showNotification('請先查詢節次課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽調課課表列印按鈕
            printSwapBtn.addEventListener('click', function() {
                if (swapTable.style.display === 'none' && swapResultTable.style.display === 'none' && classSwapTable.style.display === 'none') {
                    showNotification('請先查詢調課課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽每週科目課表列印按鈕
            printWeeklySubjectBtn.addEventListener('click', function() {
                if (weeklySubjectTable.style.display === 'none') {
                    showNotification('請先查詢每週科目課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽匯出JSON按鈕
            exportJsonBtn.addEventListener('click', function() {
                if (!jsonData) {
                    showNotification('沒有可匯出的資料', 'error');
                    return;
                }
                
                jsonContent.textContent = JSON.stringify(jsonData, null, 2);
                jsonDisplay.style.display = 'block';
                showNotification('JSON資料已匯出', 'success');
            });
            
            // 監聽下載綜合查詢頁面按鈕
            downloadCombinedBtn.addEventListener('click', function() {
                if (!jsonData) {
                    showNotification('請先上傳課表檔案並匯出JSON', 'error');
                    return;
                }
                
                const standaloneHtml = generateStandaloneHtml(jsonData);
                downloadFile(standaloneHtml, 'combined-schedule-query.html', 'text/html');
                showNotification('綜合查詢頁面已下載', 'success');
            });
            
            // 讀取Excel檔案
            function readExcelFile(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // 解析資料並轉換為JSON格式
                        scheduleData = parseScheduleData(excelData);
                        jsonData = convertToJson(scheduleData);
                        
                        // 填充班級、教師和科目下拉選單
                        populateClassSelect(jsonData.classes);
                        populateTeacherSelect(jsonData.teachers);
                        populateSubjectSelect(jsonData.subjects);
                        populateSwapTeacherSelect(jsonData.teachers);
                        
                        showNotification('課表檔案上傳成功', 'success');
                    } catch (error) {
                        console.error('讀取檔案錯誤:', error);
                        showNotification('讀取檔案失敗，請確認檔案格式', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // 解析課表資料
            function parseScheduleData(excelData) {
                const result = [];
                
                // 假設第一行是標題
                const headers = excelData[0];
                
                // 從第二行開始是資料
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    if (row.length < headers.length) continue;
                    
                    const item = {};
                    for (let j = 0; j < headers.length; j++) {
                        item[headers[j]] = row[j];
                    }
                    
                    result.push(item);
                }
                
                return result;
            }
            
            // 將資料轉換為JSON格式
            function convertToJson(data) {
                // 按班級分組
                const classes = {};
                // 按教師分組
                const teachers = {};
                // 按科目分組
                const subjects = {};
                
                data.forEach(item => {
                    const classCode = item['班級代碼'];
                    const className = item['班級名稱'] || classCode;
                    const teacherName = item['教師名稱'];
                    const subjectName = item['科目名稱'];
                    
                    if (classCode) {
                        if (!classes[classCode]) {
                            classes[classCode] = {
                                className: className,
                                schedule: Array(8).fill(null).map(() => Array(5).fill(null).map(() => []))
                            };
                        }
                        
                        const day = parseInt(item['星期']) - 1; // 星期1-5 轉為索引 0-4
                        const period = parseInt(item['節次']) - 1; // 節次1-8 轉為索引 0-7
                        
                        if (day >= 0 && day < 5 && period >= 0 && period < 8) {
                            // 檢查是否已有相同科目
                            const existingCourseIndex = classes[classCode].schedule[period][day].findIndex(
                                course => course.subject === subjectName
                            );
                            
                            if (existingCourseIndex !== -1) {
                                // 如果已有相同科目，則添加教師到現有課程
                                if (!classes[classCode].schedule[period][day][existingCourseIndex].teachers.includes(teacherName)) {
                                    classes[classCode].schedule[period][day][existingCourseIndex].teachers.push(teacherName);
                                }
                            } else {
                                // 如果沒有相同科目，則新增課程
                                classes[classCode].schedule[period][day].push({
                                    subject: subjectName,
                                    teachers: [teacherName]
                                });
                            }
                        }
                    }
                    
                    if (teacherName) {
                        if (!teachers[teacherName]) {
                            teachers[teacherName] = {
                                schedule: Array(8).fill(null).map(() => Array(5).fill(null).map(() => []))
                            };
                        }
                        
                        const day = parseInt(item['星期']) - 1; // 星期1-5 轉為索引 0-4
                        const period = parseInt(item['節次']) - 1; // 節次1-8 轉為索引 0-7
                        
                        if (day >= 0 && day < 5 && period >= 0 && period < 8) {
                            teachers[teacherName].schedule[period][day].push({
                                subject: subjectName,
                                class: classCode,
                                className: className
                            });
                        }
                    }
                    
                    if (subjectName) {
                        if (!subjects[subjectName]) {
                            subjects[subjectName] = [];
                        }
                        
                        // 添加科目到科目列表
                        subjects[subjectName].push({
                            class: classCode,
                            className: className,
                            teacher: teacherName
                        });
                    }
                });
                
                return {
                    classes,
                    teachers,
                    subjects
                };
            }
            
            // 填充班級下拉選單
            function populateClassSelect(classes) {
                // 清空選單
                classSelect.innerHTML = '<option value="">請選擇班級</option>';
                
                // 添加班級選項
                Object.keys(classes).sort().forEach(classCode => {
                    const option = document.createElement('option');
                    option.value = classCode;
                    option.textContent = `${classCode} - ${classes[classCode].className}`;
                    classSelect.appendChild(option);
                });
            }
            
            // 填充教師下拉選單
            function populateTeacherSelect(teachers) {
                // 清空選單
                teacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    teacherSelect.appendChild(option);
                });
            }
            
            // 填充調課教師下拉選單
            function populateSwapTeacherSelect(teachers) {
                // 清空選單
                swapTeacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    swapTeacherSelect.appendChild(option);
                });
            }
            
            // 填充科目下拉選單
            function populateSubjectSelect(subjects) {
                // 清空選單
                subjectSelect.innerHTML = '<option value="">請選擇科目</option>';
                weeklySubjectSelect.innerHTML = '<option value="">請選擇科目</option>';
                
                // 添加科目選項
                Object.keys(subjects).sort().forEach(subjectName => {
                    const option = document.createElement('option');
                    option.value = subjectName;
                    option.textContent = subjectName;
                    subjectSelect.appendChild(option.cloneNode(true));
                    weeklySubjectSelect.appendChild(option);
                });
            }
            
            // 顯示課表
            function displaySchedule(queryCode, type) {
                let scheduleData;
                let notFoundMessage;
                
                // 隱藏其他表格
                scheduleTable.style.display = 'table';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'block';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                if (type === 'class') {
                    if (!jsonData.classes[queryCode]) {
                        showNotification(`找不到班級 ${queryCode} 的課表資料`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = `找不到班級 ${queryCode} 的課表資料`;
                        return;
                    }
                    scheduleData = jsonData.classes[queryCode].schedule;
                    notFoundMessage = `找不到班級 ${queryCode} 的課表資料`;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = `${jsonData.classes[queryCode].className} 的班級課表`;
                } else {
                    if (!jsonData.teachers[queryCode]) {
                        showNotification(`找不到教師 ${queryCode} 的課表資料`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = `找不到教師 ${queryCode} 的課表資料`;
                        return;
                    }
                    scheduleData = jsonData.teachers[queryCode].schedule;
                    notFoundMessage = `找不到教師 ${queryCode} 的課表資料`;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = `${queryCode} 老師的課表`;
                }
                
                // 清空課表內容
                scheduleBody.innerHTML = '';
                
                // 生成課表HTML
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = `第${period + 1}節`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'course-item';
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'course-name';
                                subjectDiv.textContent = course.subject;
                                
                                if (type === 'class') {
                                    const teacherDiv = document.createElement('div');
                                    teacherDiv.className = 'teacher-name';
                                    
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            teacherDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        teacherDiv.appendChild(teacherSpan);
                                    });
                                    
                                    courseItem.appendChild(subjectDiv);
                                    courseItem.appendChild(teacherDiv);
                                } else {
                                    const classDiv = document.createElement('div');
                                    classDiv.className = 'class-name clickable';
                                    classDiv.textContent = course.className || course.class;
                                    classDiv.setAttribute('data-class', course.class);
                                    classDiv.addEventListener('click', function() {
                                        switchToClassSchedule(course.class);
                                    });
                                    
                                    courseItem.appendChild(subjectDiv);
                                    courseItem.appendChild(classDiv);
                                }
                                
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    scheduleBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        scheduleBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示課表
                noData.style.display = 'none';
                
                const successMessage = type === 'class' 
                    ? `班級 ${queryCode} 課表查詢成功` 
                    : `教師 ${queryCode} 課表查詢成功`;
                    
                showNotification(successMessage, 'success');
            }
            
            // 顯示科目課表
            function displaySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(`找不到科目 ${subjectName} 的任課資料`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = `找不到科目 ${subjectName} 的任課資料`;
                    return;
                }
                
                // 隱藏其他表格，顯示科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'table';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'block';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示科目標題（置中）
                subjectHeader.textContent = `${subjectName} 的所有班級的任課教師一覽表`;
                subjectHeader.style.textAlign = 'center';
                
                // 清空科目表內容
                subjectBody.innerHTML = '';
                
                // 獲取科目資料
                const subjectData = jsonData.subjects[subjectName];
                
                // 按班級代碼排序
                subjectData.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                subjectData.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = `${grade} 年級`;
                    gradeRow.appendChild(gradeCell);
                    subjectBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    subjectBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'subject-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teacher;
                                teacherDiv.setAttribute('data-teacher', item.teacher);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teacher);
                                });
                                
                                // 將班級和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        subjectBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        subjectBody.appendChild(separatorRow);
                    }
                });
                
                // 顯示科目表
                noData.style.display = 'none';
                
                showNotification(`科目 ${subjectName} 查詢成功`, 'success');
            }
            
            // 顯示節次課表
            function displayPeriodSchedule(day, period) {
                // 隱藏其他表格，顯示節次表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'table';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'block';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 顯示節次標題（置中）
                periodHeader.textContent = `${dayNames[day]} 第${period}節 教師任課一覽表`;
                periodHeader.style.textAlign = 'center';
                
                // 清空節次表內容
                periodBody.innerHTML = '';
                
                // 獲取所有班級
                const allClasses = Object.keys(jsonData.classes);
                
                // 收集該節次有課務的班級和教師
                const periodClasses = [];
                const busyTeachers = new Set();
                
                // 轉換為索引
                const dayIndex = parseInt(day) - 1;
                const periodIndex = parseInt(period) - 1;
                
                // 遍歷所有班級，找出該節次有課務的班級
                allClasses.forEach(classCode => {
                    const classData = jsonData.classes[classCode];
                    const courses = classData.schedule[periodIndex][dayIndex];
                    
                    if (courses.length > 0) {
                        courses.forEach(course => {
                            // 添加班級資料
                            periodClasses.push({
                                class: classCode,
                                className: classData.className,
                                teachers: course.teachers,
                                subject: course.subject
                            });
                            
                            // 添加教師到忙碌教師集合
                            course.teachers.forEach(teacher => {
                                busyTeachers.add(teacher);
                            });
                        });
                    }
                });
                
                // 按班級代碼排序
                periodClasses.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                periodClasses.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = `${grade} 年級`;
                    gradeRow.appendChild(gradeCell);
                    periodBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    periodBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'period-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建科目名稱元素
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = item.subject;
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teachers.join('、');
                                teacherDiv.setAttribute('data-teacher', item.teachers[0]);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teachers[0]);
                                });
                                
                                // 將班級、科目和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(subjectDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        periodBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        periodBody.appendChild(separatorRow);
                    }
                });
                
                // 創建無課務教師標題行
                const noTeacherRow = document.createElement('tr');
                const noTeacherCell = document.createElement('td');
                noTeacherCell.className = 'no-teacher-header';
                noTeacherCell.colSpan = 10;
                noTeacherCell.textContent = '本節無課務教師一覽表';
                noTeacherRow.appendChild(noTeacherCell);
                periodBody.appendChild(noTeacherRow);
                
                // 獲取所有教師
                const allTeachers = Object.keys(jsonData.teachers);
                
                // 找出無課務的教師
                const freeTeachers = allTeachers.filter(teacher => !busyTeachers.has(teacher));
                
                // 按教師姓名排序
                freeTeachers.sort();
                
                // 計算需要多少行來顯示所有教師（每行10個教師）
                const teacherRowsNeeded = Math.ceil(freeTeachers.length / 10);
                
                // 創建標題行
                const teacherHeaderRow = document.createElement('tr');
                for (let i = 0; i < 10; i++) {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = '教師';
                    teacherHeaderRow.appendChild(headerCell);
                }
                periodBody.appendChild(teacherHeaderRow);
                
                // 創建內容行
                for (let row = 0; row < teacherRowsNeeded; row++) {
                    const teacherContentRow = document.createElement('tr');
                    
                    // 為每個教師創建單元格
                    for (let col = 0; col < 10; col++) {
                        const index = row * 10 + col;
                        const cell = document.createElement('td');
                        cell.className = 'period-cell';
                        
                        if (index < freeTeachers.length) {
                            const teacher = freeTeachers[index];
                            
                            // 創建教師名稱元素
                            const teacherDiv = document.createElement('div');
                            teacherDiv.className = 'teacher-name clickable free-teacher';
                            teacherDiv.textContent = teacher;
                            teacherDiv.setAttribute('data-teacher', teacher);
                            teacherDiv.addEventListener('click', function() {
                                switchToTeacherSchedule(teacher);
                            });
                            
                            // 將教師添加到單元格
                            cell.appendChild(teacherDiv);
                        }
                        
                        teacherContentRow.appendChild(cell);
                    }
                    
                    periodBody.appendChild(teacherContentRow);
                }
                
                // 顯示節次表
                noData.style.display = 'none';
                
                showNotification(`${dayNames[day]} 第${period}節 查詢成功`, 'success');
            }
            
            // 顯示調課查詢課表
            function displaySwapSchedule(teacherName) {
                // 隱藏其他表格，顯示調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'table';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'block';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示調課標題（置中）
                swapHeader.textContent = `${teacherName} 老師的課表`;
                swapHeader.style.textAlign = 'center';
                
                // 清空調課表內容
                swapBody.innerHTML = '';
                
                if (!jsonData.teachers[teacherName]) {
                    showNotification(`找不到教師 ${teacherName} 的課表資料`, 'error');
                    swapTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = `找不到教師 ${teacherName} 的課表資料`;
                    return;
                }
                
                const scheduleData = jsonData.teachers[teacherName].schedule;
                
                // 生成調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = `第${period + 1}節`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'swap-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'swap-item';
                                
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = course.className || course.class;
                                classDiv.setAttribute('data-class', course.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(course.class);
                                });
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = course.subject;
                                
                                // 創建調課按鈕
                                const swapBtn = document.createElement('button');
                                swapBtn.className = 'swap-btn';
                                swapBtn.textContent = '調課';
                                swapBtn.setAttribute('data-teacher', teacherName);
                                swapBtn.setAttribute('data-day', day + 1);
                                swapBtn.setAttribute('data-period', period + 1);
                                swapBtn.setAttribute('data-class', course.class);
                                swapBtn.setAttribute('data-subject', course.subject);
                                swapBtn.addEventListener('click', function() {
                                    findAvailableTeachersForSwap(
                                        teacherName,
                                        day + 1,
                                        period + 1,
                                        course.class,
                                        course.subject
                                    );
                                });
                                
                                courseItem.appendChild(classDiv);
                                courseItem.appendChild(subjectDiv);
                                courseItem.appendChild(swapBtn);
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    swapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        swapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示調課表
                noData.style.display = 'none';
                
                showNotification(`教師 ${teacherName} 課表查詢成功`, 'success');
            }
            
            // 顯示每週科目課表
            function displayWeeklySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(`找不到科目 ${subjectName} 的任課資料`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = `找不到科目 ${subjectName} 的任課資料`;
                    return;
                }
                
                // 隱藏其他表格，顯示每週科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'table';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'block';
                
                // 顯示標題
                weeklySubjectHeader.textContent = `${subjectName} 每週課表`;
                weeklySubjectHeader.style.textAlign = 'center';
                
                // 清空內容
                weeklySubjectBody.innerHTML = '';
                
                // 收集資料
                const weeklyData = Array(8).fill(null).map(() => Array(5).fill(null).map(() => []));
                
                Object.keys(jsonData.classes).forEach(classCode => {
                    const classSchedule = jsonData.classes[classCode].schedule;
                    const className = jsonData.classes[classCode].className;
                    for (let p = 0; p < 8; p++) {
                        for (let d = 0; d < 5; d++) {
                            const courses = classSchedule[p][d];
                            courses.forEach(course => {
                                if (course.subject === subjectName) {
                                    course.teachers.forEach(teacher => {
                                        weeklyData[p][d].push({teacher, classCode, className});
                                    });
                                }
                            });
                        }
                    }
                });
                
                // 生成表格
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = `第${period + 1}節`;
                    row.appendChild(timeSlotCell);
                    
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const entries = weeklyData[period][day];
                        if (entries.length > 0) {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'course-item';
                            
                            // 修改這部分：每個教師和班級組合單獨一行顯示
                            entries.forEach((entry, index) => {
                                const entryDiv = document.createElement('div');
                                entryDiv.style.marginBottom = '2px'; // 添加一些間距
                                
                                const span = document.createElement('span');
                                span.textContent = `${entry.teacher}(${entry.className || entry.classCode})`;
                                span.className = 'clickable teacher-link';
                                span.setAttribute('data-teacher', entry.teacher);
                                span.addEventListener('click', () => switchToTeacherSchedule(entry.teacher));
                                
                                entryDiv.appendChild(span);
                                itemDiv.appendChild(entryDiv);
                            });
                            
                            cell.appendChild(itemDiv);
                        } else {
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    weeklySubjectBody.appendChild(row);
                    
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        weeklySubjectBody.appendChild(lunchRow);
                    }
                }
                
                noData.style.display = 'none';
                showNotification(`科目 ${subjectName} 每週課表查詢成功`, 'success');
            }
            
            // 尋找可調課的教師
            function findAvailableTeachersForSwap(teacherName, day, period, classCode, subject) {
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 隱藏其他表格，顯示班級調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'block';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'block';
                weeklySubjectHeader.style.display = 'none';
                
                // 設置班級調課表標題
                classSwapHeader.textContent = `${jsonData.classes[classCode].className} 可調課教師一覽表`;
                classSwapHeader.style.textAlign = 'center';
                
                // 清空班級調課表內容
                classSwapBody.innerHTML = '';
                
                // 確保教師課表存在
                if (!jsonData.teachers[teacherName] || !jsonData.teachers[teacherName].schedule) {
                    showNotification(`找不到教師 ${teacherName} 的課表資料`, 'error');
                    return;
                }
                
                // 獲取教師課表
                const teacherSchedule = jsonData.teachers[teacherName].schedule;
                
                // 找出該教師所有無課務的節次（B陣列）
                const freeSlots = [];
                for (let p = 0; p < 7; p++) {
                    for (let d = 0; d < 5; d++) {
                        // 確保teacherSchedule[p][d]存在
                        if (teacherSchedule[p] && teacherSchedule[p][d] && teacherSchedule[p][d].length === 0) {
                            freeSlots.push({ day: d + 1, period: p + 1 });
                        }
                    }
                }
                
                // 確保班級課表存在
                if (!jsonData.classes[classCode] || !jsonData.classes[classCode].schedule) {
                    showNotification(`找不到班級 ${classCode} 的課表資料`, 'error');
                    return;
                }
                
                // 獲取班級課表
                const classSchedule = jsonData.classes[classCode].schedule;
                
                // 生成班級調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = `第${period + 1}節`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'class-swap-cell';
                        
                        // 確保classSchedule[period][day]存在
                        if (classSchedule[period] && classSchedule[period][day]) {
                            const courses = classSchedule[period][day];
                            if (courses.length > 0) {
                                courses.forEach(course => {
                                    const courseItem = document.createElement('div');
                                    courseItem.className = 'class-swap-item';
                                    
                                    const subjectDiv = document.createElement('div');
                                    subjectDiv.className = 'class-swap-name';
                                    subjectDiv.textContent = course.subject;
                                    
                                    const teacherDiv = document.createElement('div');
                                    teacherDiv.className = 'teacher-name';
                                    
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            teacherDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        teacherDiv.appendChild(teacherSpan);
                                    });
                                    
                                    courseItem.appendChild(subjectDiv);
                                    courseItem.appendChild(teacherDiv);
                                    cell.appendChild(courseItem);
                                });
                            } else {
                                // 添加空堂樣式
                                const emptySlot = document.createElement('div');
                                emptySlot.className = 'empty-slot';
                                emptySlot.textContent = '  ';
                                cell.appendChild(emptySlot);
                            }
                            
                            // 檢查是否為B陣列中的節次
                            const isFreeSlot = freeSlots.some(slot => slot.day === day + 1 && slot.period === period + 1);
                            
                            if (isFreeSlot) {
                                // 檢查該節次是否有可調課的教師
                                const availableTeachers = [];
                                
                                // 獲取所有教師
                                const allTeachers = Object.keys(jsonData.teachers);
                                
                                // 遍歷所有教師（除了當前教師）
                                allTeachers.forEach(t => {
                                    if (t === teacherName) return;
                                    
                                    // 確保教師課表存在
                                    if (!jsonData.teachers[t] || !jsonData.teachers[t].schedule) {
                                        return;
                                    }
                                    
                                    const tSchedule = jsonData.teachers[t].schedule;
                                    
                                    // 檢查該教師是否在A節次（點擊的節次）無課務
                                    const aDayIndex = day - 1;
                                    const aPeriodIndex = period - 1;
                                    
                                    // 確保tSchedule[aPeriodIndex][aDayIndex]存在
                                    if (tSchedule[aPeriodIndex] && tSchedule[aPeriodIndex][aDayIndex] && tSchedule[aPeriodIndex][aDayIndex].length > 0) {
                                        return; // 在A節次有課務，跳過
                                    }
                                    
                                    // 檢查該教師是否在B陣列節次有課務且任教該班
                                    let hasTeachingInB = false;
                                    for (const slot of freeSlots) {
                                        const bDayIndex = slot.day - 1;
                                        const bPeriodIndex = slot.period - 1;
                                        
                                        // 確保tSchedule[bPeriodIndex][bDayIndex]存在
                                        if (tSchedule[bPeriodIndex] && tSchedule[bPeriodIndex][bDayIndex]) {
                                            const courses = tSchedule[bPeriodIndex][bDayIndex];
                                            if (courses.length > 0 && courses.some(course => course.class === classCode)) {
                                                hasTeachingInB = true;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (hasTeachingInB) {
                                        availableTeachers.push(t);
                                    }
                                });
                                
                                // 如果有可調課的教師，添加"有空堂"標記
                                if (availableTeachers.length > 0) {
                                    const availableSlot = document.createElement('div');
                                    availableSlot.className = 'available-slot';
                                    availableSlot.textContent = '有空堂';
                                    cell.appendChild(availableSlot);
                                }
                            }
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    classSwapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        classSwapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示班級調課表
                noData.style.display = 'none';
                
                showNotification('調課查詢成功', 'success');
            }
            
            // 切換到教師課表
            function switchToTeacherSchedule(teacherName) {
                // 切換到教師標籤頁
                document.querySelector('[data-tab="teacher"]').click();
                
                // 選擇教師
                teacherSelect.value = teacherName;
                
                // 查詢教師課表
                displaySchedule(teacherName, 'teacher');
            }
            
            // 切換到班級課表
            function switchToClassSchedule(classCode) {
                // 切換到班級標籤頁
                document.querySelector('[data-tab="class"]').click();
                
                // 選擇班級
                classSelect.value = classCode;
                
                // 查詢班級課表
                displaySchedule(classCode, 'class');
            }
            
            // 顯示通知
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                // 3秒後自動隱藏
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            
            // 生成獨立查詢頁面HTML
            function generateStandaloneHtml(data) {
                // 將JSON資料轉換為字符串，並進行必要的轉義
                const jsonString = JSON.stringify(data);
                
                // 創建一個腳本標籤來存儲JSON資料
                const scriptTag = `<script id="schedule-data" type="application/json">${jsonString}<\/script>`;
                
                // 創建讀取JSON資料的函數
                const readDataFunction = `
                function getScheduleData() {
                    const scriptElement = document.getElementById('schedule-data');
                    return JSON.parse(scriptElement.textContent);
                }`;
                
                return `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教學組專用課表查詢系統V6.0</title>
    <style>
        * {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
        }
        
        .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
            transition: border-color 0.3s;
        }
        
        .class-select:focus, .teacher-select:focus, .subject-select:focus, .day-select:focus, .period-select:focus, .swap-teacher-select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .search-btn {
            background-color: #2ecc71;
        }
        
        .search-btn:hover {
            background-color: #27ae60;
        }
        
        .print-btn {
            background-color: #e74c3c;
        }
        
        .print-btn:hover {
            background-color: #c0392b;
        }
        
        .swap-btn {
            background-color: #f39c12;
            font-size: 14px;
            padding: 5px 10px;
            margin-top: 5px;
        }
        
        .swap-btn:hover {
            background-color: #e67e22;
        }
        
        .schedule-container {
            overflow-x: auto;
        }
        
        .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, 
        .period-table th, .period-table td, .swap-table th, .swap-table td,
        .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
            border: 2px solid #2c3e50;
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
        }
        
        .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            position: sticky;
            top: 0;
        }
        
        .schedule-table tr:nth-child(even), .subject-table tr:nth-child(even), 
        .period-table tr:nth-child(even), .swap-table tr:nth-child(even),
        .swap-result-table tr:nth-child(even), .class-swap-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .schedule-table tr:hover, .subject-table tr:hover, 
        .period-table tr:hover, .swap-table tr:hover,
        .swap-result-table tr:hover, .class-swap-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .time-slot {
            background-color: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            width: 80px;
        }
        
        .course-cell, .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
        }
        
        .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 4px;
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
        }
        
        .course-item:last-child, .subject-item:last-child, .period-item:last-child, .swap-item:last-child, .class-swap-item:last-child {
            margin-bottom: 0;
        }
        
        .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .detail-name {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .clickable {
            cursor: pointer;
            text-decoration: none;
            color: #3498db;
        }
        
        .clickable:hover {
            color: #2980b9;
        }
        
        .teacher-link {
            color: #27ae60; /* 深綠色 */
        }
        
        .teacher-link:hover {
            color: #229954; /* 深綠色的懸停顏色 */
        }
        
        .free-teacher {
            color: #d35400; /* 橘棕色 */
        }
        
        .available-slot {
            color: #27ae60;
            font-weight: bold;
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 3px solid #27ae60;
            padding: 6px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        
        .error {
            background-color: #ffecec;
            color: #e74c3c;
            border: 1px solid #f5aca6;
        }
        
        .success {
            background-color: #e8f8f5;
            color: #2ecc71;
            border: 1px solid #a9e8d3;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .lunch-break {
            background-color: #fff9e6;
            color: #f39c12;
            font-weight: bold;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        
        .print-area {
            margin-top: 20px;
        }
        
        /* 新增樣式用於科目查詢的表格顯示 */
        .grade-header {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
        }
        
        .grade-separator {
            height: 20px;
            background-color: #f5f7fa;
        }
        
        .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }
        
        .subject-cell .class-name, .subject-cell .teacher-name, 
        .period-cell .class-name, .period-cell .teacher-name, 
        .period-cell .subject-name, .swap-cell .class-name, 
        .swap-cell .teacher-name, .swap-cell .subject-name,
        .class-swap-cell .class-name, .class-swap-cell .teacher-name, 
        .class-swap-cell .subject-name {
            display: block;
            margin: 5px 0;
        }
        
        .no-teacher-header {
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
            margin-top: 30px;
        }
        
        .swap-result-section {
            margin-top: 30px;
        }
        
        .swap-teacher-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .swap-teacher-info h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .swap-teacher-info p {
            margin-bottom: 5px;
        }
        
        .class-swap-section {
            margin-top: 30px;
        }
        
        .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        /* 空堂樣式 */
        .empty-slot {
            /*color: #bdc3c7;*/
            font-style: italic;
            font-size: 0.9em;
            padding: 10px;
            /* border: 0px dashed #ddd;*/
            border-radius: 0px;
            /*background-color: #fafafa;*/
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select, .search-btn, .print-btn {
                width: 100%;
            }
            
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.9rem;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 8px 10px;
            }
            
            .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.8rem;
            }
            
            .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 6px 8px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* 列印樣式優化 */
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                border-collapse: collapse !important;
                width: 100% !important;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                border: 2px solid #000 !important;
                padding: 8px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
                background-color: #2c3e50 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 1.1rem !important;
            }
            
            .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
                font-size: 1.8rem !important;
                font-weight: bold !important;
                margin-bottom: 20px !important;
                color: #000 !important;
            }
            
            .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
                border-left: 3px solid #3498db !important;
                background-color: rgba(52, 152, 219, 0.1) !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-bottom: 8px !important;
                page-break-inside: avoid;
            }
            
            .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
                font-weight: bold !important;
                color: #000 !important;
                margin-bottom: 4px !important;
            }
            
            .detail-name {
                color: #333 !important;
                font-size: 0.9em !important;
            }
            
            .lunch-break {
                background-color: #fff9e6 !important;
                color: #f39c12 !important;
                font-weight: bold !important;
            }
            
            .grade-header, .no-teacher-header {
                background-color: #3498db !important;
                color: white !important;
                font-weight: bold !important;
                text-align: center !important;
                padding: 10px !important;
                font-size: 1.2rem !important;
            }
            
            .no-teacher-header {
                background-color: #e74c3c !important;
            }
            
            .clickable {
                text-decoration: none !important;
            }
            
            .teacher-link {
                color: #27ae60 !important;
            }
            
            .free-teacher {
                color: #d35400 !important;
            }
            
            .available-slot {
                color: #27ae60 !important;
                font-weight: bold !important;
                background-color: rgba(39, 174, 96, 0.1) !important;
                border-left: 3px solid #27ae60 !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-top: 5px !important;
            }
            
            .empty-slot {
                color: #999 !important;
                font-style: italic !important;
                border: 1px dashed #ccc !important;
                background-color: #f9f9f9 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>教學組專用課表查詢系統V6.0</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="class">班級課表查詢</button>
                <button class="tab-button" data-tab="teacher">教師課表查詢</button>
                <button class="tab-button" data-tab="subject">科目查詢</button>
                <button class="tab-button" data-tab="period">節次任課查詢</button>
                <button class="tab-button" data-tab="swap">同班無課教師查詢</button>
                <button class="tab-button" data-tab="weekly-subject">每週科目課表</button>
            </div>
            
            <div id="class-tab" class="tab-content active">
                <div class="input-section">
                    <select id="class-select" class="class-select">
                        <option value="">請選擇班級</option>
                    </select>
                    <button id="search-class-btn" class="search-btn">查詢班級課表</button>
                    <button id="print-class-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="teacher-tab" class="tab-content">
                <div class="input-section">
                    <select id="teacher-select" class="teacher-select">
                        <option value="">請選擇教師</option>
                    </select>
                    <button id="search-teacher-btn" class="search-btn">查詢教師課表</button>
                    <button id="print-teacher-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="subject-tab" class="tab-content">
                <div class="input-section">
                    <select id="subject-select" class="subject-select">
                        <option value="">請選擇科目</option>
                    </select>
                    <button id="search-subject-btn" class="search-btn">查詢科目任課教師</button>
                    <button id="print-subject-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="period-tab" class="tab-content">
                <div class="input-section">
                    <select id="day-select" class="day-select">
                        <option value="">請選擇星期</option>
                        <option value="1">星期一</option>
                        <option value="2">星期二</option>
                        <option value="3">星期三</option>
                        <option value="4">星期四</option>
                        <option value="5">星期五</option>
                    </select>
                    <select id="period-select" class="period-select">
                        <option value="">請選擇節次</option>
                        <option value="1">第1節</option>
                        <option value="2">第2節</option>
                        <option value="3">第3節</option>
                        <option value="4">第4節</option>
                        <option value="5">第5節</option>
                        <option value="6">第6節</option>
                        <option value="7">第7節</option>
                        <option value="8">第8節</option>
                    </select>
                    <button id="search-period-btn" class="search-btn">查詢節次任課</button>
                    <button id="print-period-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="swap-tab" class="tab-content">
                <div class="input-section">
                    <select id="swap-teacher-select" class="swap-teacher-select">
                        <option value="">請選擇教師</option>
                    </select>
                    <button id="search-swap-btn" class="search-btn">查詢教師課表</button>
                    <button id="print-swap-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
            
            <div id="weekly-subject-tab" class="tab-content">
                <div class="input-section">
                    <select id="weekly-subject-select" class="subject-select">
                        <option value="">請選擇科目</option>
                    </select>
                    <button id="search-weekly-subject-btn" class="search-btn">查詢每週科目課表</button>
                    <button id="print-weekly-subject-btn" class="print-btn no-print">課表列印</button>
                </div>
            </div>
        </div>
        
        <div id="notification" class="notification"></div>
        
        <div class="print-area">
            <div id="schedule-header" class="schedule-header" style="display: none;"></div>
            <div id="subject-header" class="subject-header" style="display: none;"></div>
            <div id="period-header" class="period-header" style="display: none;"></div>
            <div id="swap-header" class="swap-header" style="display: none;"></div>
            <div id="swap-result-header" class="swap-result-header" style="display: none;"></div>
            <div id="class-swap-header" class="class-swap-header" style="display: none;"></div>
            <div id="weekly-subject-header" class="schedule-header" style="display: none;"></div>
            <div class="schedule-container">
                <table id="schedule-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <!-- 課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="subject-table" class="subject-table" style="display: none;">
                    <tbody id="subject-body">
                        <!-- 科目任課教師內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="period-table" class="period-table" style="display: none;">
                    <tbody id="period-body">
                        <!-- 節次任課內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="swap-table" class="swap-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="swap-body">
                        <!-- 調課查詢內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="swap-result-section" class="swap-result-section" style="display: none;">
                    <div id="swap-teacher-info" class="swap-teacher-info" style="display: none;">
                        <h3>調課資訊</h3>
                        <p><strong>教師：</strong><span id="swap-teacher-name"></span></p>
                        <p><strong>調課時間：</strong><span id="swap-time"></span></p>
                        <p><strong>班級：</strong><span id="swap-class"></span></p>
                        <p><strong>科目：</strong><span id="swap-subject"></span></p>
                    </div>
                    
                    <table id="swap-result-table" class="swap-result-table">
                        <thead>
                            <tr>
                                <th>教師</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="swap-result-body">
                            <!-- 調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="class-swap-section" class="class-swap-section" style="display: none;">
                    <table id="class-swap-table" class="class-swap-table">
                        <thead>
                            <tr>
                                <th>節次</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="class-swap-body">
                            <!-- 班級調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <table id="weekly-subject-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-subject-body">
                        <!-- 每週科目課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="no-data" class="no-data" style="display: none;">
                    請選擇查詢類型並輸入查詢條件
                </div>
            </div>
        </div>
        
        <div class="legend no-print">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>表頭</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ecf0f1;"></div>
                <span>節次</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f9f9f9;"></div>
                <span>課程內容</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>班級連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>教師連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d35400;"></div>
                <span>無課務教師</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>有空堂</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff9e6;"></div>
                <span>午休分隔</span>
            </div>
        </div>
        
        <div class="footer no-print">
            本網頁程式 design by koming 2025
        </div>
    </div>

    <!-- 隱藏的JSON資料 -->
    ${scriptTag}

    <script>
        ${readDataFunction}

        document.addEventListener('DOMContentLoaded', function() {
            const classSelect = document.getElementById('class-select');
            const teacherSelect = document.getElementById('teacher-select');
            const subjectSelect = document.getElementById('subject-select');
            const daySelect = document.getElementById('day-select');
            const periodSelect = document.getElementById('period-select');
            const swapTeacherSelect = document.getElementById('swap-teacher-select');
            const weeklySubjectSelect = document.getElementById('weekly-subject-select');
            const searchClassBtn = document.getElementById('search-class-btn');
            const searchTeacherBtn = document.getElementById('search-teacher-btn');
            const searchSubjectBtn = document.getElementById('search-subject-btn');
            const searchPeriodBtn = document.getElementById('search-period-btn');
            const searchSwapBtn = document.getElementById('search-swap-btn');
            const searchWeeklySubjectBtn = document.getElementById('search-weekly-subject-btn');
            const printClassBtn = document.getElementById('print-class-btn');
            const printTeacherBtn = document.getElementById('print-teacher-btn');
            const printSubjectBtn = document.getElementById('print-subject-btn');
            const printPeriodBtn = document.getElementById('print-period-btn');
            const printSwapBtn = document.getElementById('print-swap-btn');
            const printWeeklySubjectBtn = document.getElementById('print-weekly-subject-btn');
            const scheduleHeader = document.getElementById('schedule-header');
            const subjectHeader = document.getElementById('subject-header');
            const periodHeader = document.getElementById('period-header');
            const swapHeader = document.getElementById('swap-header');
            const swapResultHeader = document.getElementById('swap-result-header');
            const classSwapHeader = document.getElementById('class-swap-header');
            const weeklySubjectHeader = document.getElementById('weekly-subject-header');
            const scheduleTable = document.getElementById('schedule-table');
            const subjectTable = document.getElementById('subject-table');
            const periodTable = document.getElementById('period-table');
            const swapTable = document.getElementById('swap-table');
            const swapResultTable = document.getElementById('swap-result-table');
            const classSwapTable = document.getElementById('class-swap-table');
            const weeklySubjectTable = document.getElementById('weekly-subject-table');
            const scheduleBody = document.getElementById('schedule-body');
            const subjectBody = document.getElementById('subject-body');
            const periodBody = document.getElementById('period-body');
            const swapBody = document.getElementById('swap-body');
            const swapResultBody = document.getElementById('swap-result-body');
            const classSwapBody = document.getElementById('class-swap-body');
            const weeklySubjectBody = document.getElementById('weekly-subject-body');
            const swapResultSection = document.getElementById('swap-result-section');
            const classSwapSection = document.getElementById('class-swap-section');
            const swapTeacherInfo = document.getElementById('swap-teacher-info');
            const swapTeacherName = document.getElementById('swap-teacher-name');
            const swapTime = document.getElementById('swap-time');
            const swapClass = document.getElementById('swap-class');
            const swapSubject = document.getElementById('swap-subject');
            const noData = document.getElementById('no-data');
            const notification = document.getElementById('notification');
            
            // 標籤頁功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // 移除所有標籤的active類
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 為當前標籤添加active類
                    button.classList.add('active');
                    document.getElementById(\`\${tabId}-tab\`).classList.add('active');
                });
            });
            
            // 從隱藏的script標籤讀取JSON資料
            const jsonData = getScheduleData();
            
            // 填充班級、教師和科目下拉選單
            populateClassSelect(jsonData.classes);
            populateTeacherSelect(jsonData.teachers);
            populateSubjectSelect(jsonData.subjects);
            populateSwapTeacherSelect(jsonData.teachers);
            
            // 監聽班級查詢按鈕
            searchClassBtn.addEventListener('click', function() {
                const classCode = classSelect.value;
                if (!classCode) {
                    showNotification('請選擇班級', 'error');
                    return;
                }
                
                displaySchedule(classCode, 'class');
            });
            
            // 監聽教師查詢按鈕
            searchTeacherBtn.addEventListener('click', function() {
                const teacherName = teacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                displaySchedule(teacherName, 'teacher');
            });
            
            // 監聽科目查詢按鈕
            searchSubjectBtn.addEventListener('click', function() {
                const subjectName = subjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                displaySubjectSchedule(subjectName);
            });
            
            // 監聽節次查詢按鈕
            searchPeriodBtn.addEventListener('click', function() {
                const day = daySelect.value;
                const period = periodSelect.value;
                
                if (!day) {
                    showNotification('請選擇星期', 'error');
                    return;
                }
                
                if (!period) {
                    showNotification('請選擇節次', 'error');
                    return;
                }
                
                displayPeriodSchedule(day, period);
            });
            
            // 監聽調課查詢按鈕
            searchSwapBtn.addEventListener('click', function() {
                const teacherName = swapTeacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                displaySwapSchedule(teacherName);
            });
            
            // 監聽每週科目課表查詢按鈕
            searchWeeklySubjectBtn.addEventListener('click', function() {
                const subjectName = weeklySubjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                displayWeeklySubjectSchedule(subjectName);
            });
            
            // 監聽班級課表列印按鈕
            printClassBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢班級課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽教師課表列印按鈕
            printTeacherBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢教師課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽科目課表列印按鈕
            printSubjectBtn.addEventListener('click', function() {
                if (subjectTable.style.display === 'none') {
                    showNotification('請先查詢科目課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽節次課表列印按鈕
            printPeriodBtn.addEventListener('click', function() {
                if (periodTable.style.display === 'none') {
                    showNotification('請先查詢節次課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽調課課表列印按鈕
            printSwapBtn.addEventListener('click', function() {
                if (swapTable.style.display === 'none' && swapResultTable.style.display === 'none' && classSwapTable.style.display === 'none') {
                    showNotification('請先查詢調課課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 監聽每週科目課表列印按鈕
            printWeeklySubjectBtn.addEventListener('click', function() {
                if (weeklySubjectTable.style.display === 'none') {
                    showNotification('請先查詢每週科目課表', 'error');
                    return;
                }
                window.print();
            });
            
            // 填充班級下拉選單
            function populateClassSelect(classes) {
                // 清空選單
                classSelect.innerHTML = '<option value="">請選擇班級</option>';
                
                // 添加班級選項
                Object.keys(classes).sort().forEach(classCode => {
                    const option = document.createElement('option');
                    option.value = classCode;
                    option.textContent = \`\${classCode} - \${classes[classCode].className}\`;
                    classSelect.appendChild(option);
                });
            }
            
            // 填充教師下拉選單
            function populateTeacherSelect(teachers) {
                // 清空選單
                teacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    teacherSelect.appendChild(option);
                });
            }
            
            // 填充調課教師下拉選單
            function populateSwapTeacherSelect(teachers) {
                // 清空選單
                swapTeacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    swapTeacherSelect.appendChild(option);
                });
            }
            
            // 填充科目下拉選單
            function populateSubjectSelect(subjects) {
                // 清空選單
                subjectSelect.innerHTML = '<option value="">請選擇科目</option>';
                weeklySubjectSelect.innerHTML = '<option value="">請選擇科目</option>';
                
                // 添加科目選項
                Object.keys(subjects).sort().forEach(subjectName => {
                    const option = document.createElement('option');
                    option.value = subjectName;
                    option.textContent = subjectName;
                    subjectSelect.appendChild(option.cloneNode(true));
                    weeklySubjectSelect.appendChild(option);
                });
            }
            
            // 顯示課表
            function displaySchedule(queryCode, type) {
                let scheduleData;
                
                // 隱藏其他表格
                scheduleTable.style.display = 'table';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'block';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                if (type === 'class') {
                    if (!jsonData.classes[queryCode]) {
                        showNotification(\`找不到班級 \${queryCode} 的課表資料\`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = \`找不到班級 \${queryCode} 的課表資料\`;
                        return;
                    }
                    scheduleData = jsonData.classes[queryCode].schedule;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = \`\${jsonData.classes[queryCode].className} 的班級課表\`;
                } else {
                    if (!jsonData.teachers[queryCode]) {
                        showNotification(\`找不到教師 \${queryCode} 的課表資料\`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = \`找不到教師 \${queryCode} 的課表資料\`;
                        return;
                    }
                    scheduleData = jsonData.teachers[queryCode].schedule;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = \`\${queryCode} 老師的課表\`;
                }
                
                // 清空課表內容
                scheduleBody.innerHTML = '';
                
                // 生成課表HTML
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'course-item';
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'course-name';
                                subjectDiv.textContent = course.subject;
                                
                                const detailDiv = document.createElement('div');
                                detailDiv.className = 'detail-name';
                                
                                if (type === 'class') {
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            detailDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        detailDiv.appendChild(teacherSpan);
                                    });
                                } else {
                                    detailDiv.className = 'detail-name clickable';
                                    detailDiv.textContent = course.className || course.class;
                                    detailDiv.setAttribute('data-class', course.class);
                                    detailDiv.addEventListener('click', function() {
                                        switchToClassSchedule(course.class);
                                    });
                                }
                                
                                courseItem.appendChild(subjectDiv);
                                courseItem.appendChild(detailDiv);
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    scheduleBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        scheduleBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示課表
                noData.style.display = 'none';
                
                const successMessage = type === 'class' 
                    ? \`班級 \${queryCode} 課表查詢成功\` 
                    : \`教師 \${queryCode} 課表查詢成功\`;
                    
                showNotification(successMessage, 'success');
            }
            
            // 顯示科目課表
            function displaySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(\`找不到科目 \${subjectName} 的任課資料\`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到科目 \${subjectName} 的任課資料\`;
                    return;
                }
                
                // 隱藏其他表格，顯示科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'table';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'block';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示科目標題（置中）
                subjectHeader.textContent = \`\${subjectName} 的所有班級的任課教師一覽表\`;
                subjectHeader.style.textAlign = 'center';
                
                // 清空科目表內容
                subjectBody.innerHTML = '';
                
                // 獲取科目資料
                const subjectData = jsonData.subjects[subjectName];
                
                // 按班級代碼排序
                subjectData.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                subjectData.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = \`\${grade} 年級\`;
                    gradeRow.appendChild(gradeCell);
                    subjectBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    subjectBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'subject-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teacher;
                                teacherDiv.setAttribute('data-teacher', item.teacher);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teacher);
                                });
                                
                                // 將班級和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        subjectBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        subjectBody.appendChild(separatorRow);
                    }
                });
                
                // 顯示科目表
                noData.style.display = 'none';
                
                showNotification(\`科目 \${subjectName} 查詢成功\`, 'success');
            }
            
            // 顯示節次課表
            function displayPeriodSchedule(day, period) {
                // 隱藏其他表格，顯示節次表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'table';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'block';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 顯示節次標題（置中）
                periodHeader.textContent = \`\${dayNames[day]} 第\${period}節 教師任課一覽表\`;
                periodHeader.style.textAlign = 'center';
                
                // 清空節次表內容
                periodBody.innerHTML = '';
                
                // 獲取所有班級
                const allClasses = Object.keys(jsonData.classes);
                
                // 收集該節次有課務的班級和教師
                const periodClasses = [];
                const busyTeachers = new Set();
                
                // 轉換為索引
                const dayIndex = parseInt(day) - 1;
                const periodIndex = parseInt(period) - 1;
                
                // 遍歷所有班級，找出該節次有課務的班級
                allClasses.forEach(classCode => {
                    const classData = jsonData.classes[classCode];
                    const courses = classData.schedule[periodIndex][dayIndex];
                    
                    if (courses.length > 0) {
                        courses.forEach(course => {
                            // 添加班級資料
                            periodClasses.push({
                                class: classCode,
                                className: classData.className,
                                teachers: course.teachers,
                                subject: course.subject
                            });
                            
                            // 添加教師到忙碌教師集合
                            course.teachers.forEach(teacher => {
                                busyTeachers.add(teacher);
                            });
                        });
                    }
                });
                
                // 按班級代碼排序
                periodClasses.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                periodClasses.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = \`\${grade} 年級\`;
                    gradeRow.appendChild(gradeCell);
                    periodBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    periodBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'period-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建科目名稱元素
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = item.subject;
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teachers.join('、');
                                teacherDiv.setAttribute('data-teacher', item.teachers[0]);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teachers[0]);
                                });
                                
                                // 將班級、科目和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(subjectDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        periodBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        periodBody.appendChild(separatorRow);
                    }
                });
                
                // 創建無課務教師標題行
                const noTeacherRow = document.createElement('tr');
                const noTeacherCell = document.createElement('td');
                noTeacherCell.className = 'no-teacher-header';
                noTeacherCell.colSpan = 10;
                noTeacherCell.textContent = '本節無課務教師一覽表';
                noTeacherRow.appendChild(noTeacherCell);
                periodBody.appendChild(noTeacherRow);
                
                // 獲取所有教師
                const allTeachers = Object.keys(jsonData.teachers);
                
                // 找出無課務的教師
                const freeTeachers = allTeachers.filter(teacher => !busyTeachers.has(teacher));
                
                // 按教師姓名排序
                freeTeachers.sort();
                
                // 計算需要多少行來顯示所有教師（每行10個教師）
                const teacherRowsNeeded = Math.ceil(freeTeachers.length / 10);
                
                // 創建標題行
                const teacherHeaderRow = document.createElement('tr');
                for (let i = 0; i < 10; i++) {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = '教師';
                    teacherHeaderRow.appendChild(headerCell);
                }
                periodBody.appendChild(teacherHeaderRow);
                
                // 創建內容行
                for (let row = 0; row < teacherRowsNeeded; row++) {
                    const teacherContentRow = document.createElement('tr');
                    
                    // 為每個教師創建單元格
                    for (let col = 0; col < 10; col++) {
                        const index = row * 10 + col;
                        const cell = document.createElement('td');
                        cell.className = 'period-cell';
                        
                        if (index < freeTeachers.length) {
                            const teacher = freeTeachers[index];
                            
                            // 創建教師名稱元素
                            const teacherDiv = document.createElement('div');
                            teacherDiv.className = 'teacher-name clickable free-teacher';
                            teacherDiv.textContent = teacher;
                            teacherDiv.setAttribute('data-teacher', teacher);
                            teacherDiv.addEventListener('click', function() {
                                switchToTeacherSchedule(teacher);
                            });
                            
                            // 將教師添加到單元格
                            cell.appendChild(teacherDiv);
                        }
                        
                        teacherContentRow.appendChild(cell);
                    }
                    
                    periodBody.appendChild(teacherContentRow);
                }
                
                // 顯示節次表
                noData.style.display = 'none';
                
                showNotification(\`\${dayNames[day]} 第\${period}節 查詢成功\`, 'success');
            }
            
            // 顯示調課查詢課表
            function displaySwapSchedule(teacherName) {
                // 隱藏其他表格，顯示調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'table';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'block';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示調課標題（置中）
                swapHeader.textContent = \`\${teacherName} 老師的課表\`;
                swapHeader.style.textAlign = 'center';
                
                // 清空調課表內容
                swapBody.innerHTML = '';
                
                if (!jsonData.teachers[teacherName]) {
                    showNotification(\`找不到教師 \${teacherName} 的課表資料\`, 'error');
                    swapTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到教師 \${teacherName} 的課表資料\`;
                    return;
                }
                
                const scheduleData = jsonData.teachers[teacherName].schedule;
                
                // 生成調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'swap-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'swap-item';
                                
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = course.className || course.class;
                                classDiv.setAttribute('data-class', course.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(course.class);
                                });
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = course.subject;
                                
                                // 創建調課按鈕
                                const swapBtn = document.createElement('button');
                                swapBtn.className = 'swap-btn';
                                swapBtn.textContent = '調課';
                                swapBtn.setAttribute('data-teacher', teacherName);
                                swapBtn.setAttribute('data-day', day + 1);
                                swapBtn.setAttribute('data-period', period + 1);
                                swapBtn.setAttribute('data-class', course.class);
                                swapBtn.setAttribute('data-subject', course.subject);
                                swapBtn.addEventListener('click', function() {
                                    findAvailableTeachersForSwap(
                                        teacherName,
                                        day + 1,
                                        period + 1,
                                        course.class,
                                        course.subject
                                    );
                                });
                                
                                courseItem.appendChild(classDiv);
                                courseItem.appendChild(subjectDiv);
                                courseItem.appendChild(swapBtn);
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    swapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        swapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示調課表
                noData.style.display = 'none';
                
                showNotification(\`教師 \${teacherName} 課表查詢成功\`, 'success');
            }
            
            // 顯示每週科目課表
            function displayWeeklySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(\`找不到科目 \${subjectName} 的任課資料\`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到科目 \${subjectName} 的任課資料\`;
                    return;
                }
                
                // 隱藏其他表格，顯示每週科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'table';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'block';
                
                // 顯示標題
                weeklySubjectHeader.textContent = \`\${subjectName} 每週課表\`;
                weeklySubjectHeader.style.textAlign = 'center';
                
                // 清空內容
                weeklySubjectBody.innerHTML = '';
                
                // 收集資料
                const weeklyData = Array(8).fill(null).map(() => Array(5).fill(null).map(() => []));
                
                Object.keys(jsonData.classes).forEach(classCode => {
                    const classSchedule = jsonData.classes[classCode].schedule;
                    const className = jsonData.classes[classCode].className;
                    for (let p = 0; p < 8; p++) {
                        for (let d = 0; d < 5; d++) {
                            const courses = classSchedule[p][d];
                            courses.forEach(course => {
                                if (course.subject === subjectName) {
                                    course.teachers.forEach(teacher => {
                                        weeklyData[p][d].push({teacher, classCode, className});
                                    });
                                }
                            });
                        }
                    }
                });
                
                // 生成表格
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const entries = weeklyData[period][day];
                        if (entries.length > 0) {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'course-item';
                            
                            // 修改這部分：每個教師和班級組合單獨一行顯示
                            entries.forEach((entry, index) => {
                                const entryDiv = document.createElement('div');
                                entryDiv.style.marginBottom = '2px'; // 添加一些間距
                                
                                const span = document.createElement('span');
                                span.textContent = \`\${entry.teacher}(\${entry.className || entry.classCode})\`;
                                span.className = 'clickable teacher-link';
                                span.setAttribute('data-teacher', entry.teacher);
                                span.addEventListener('click', () => switchToTeacherSchedule(entry.teacher));
                                
                                entryDiv.appendChild(span);
                                itemDiv.appendChild(entryDiv);
                            });
                            
                            cell.appendChild(itemDiv);
                        } else {
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    weeklySubjectBody.appendChild(row);
                    
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        weeklySubjectBody.appendChild(lunchRow);
                    }
                }
                
                noData.style.display = 'none';
                showNotification(\`科目 \${subjectName} 每週課表查詢成功\`, 'success');
            }
            
            // 尋找可調課的教師
            function findAvailableTeachersForSwap(teacherName, day, period, classCode, subject) {
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 隱藏其他表格，顯示班級調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'block';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'block';
                weeklySubjectHeader.style.display = 'none';
                
                // 設置班級調課表標題
                classSwapHeader.textContent = \`\${jsonData.classes[classCode].className} 可調課教師一覽表\`;
                classSwapHeader.style.textAlign = 'center';
                
                // 清空班級調課表內容
                classSwapBody.innerHTML = '';
                
                // 確保教師課表存在
                if (!jsonData.teachers[teacherName] || !jsonData.teachers[teacherName].schedule) {
                    showNotification(\`找不到教師 \${teacherName} 的課表資料\`, 'error');
                    return;
                }
                
                // 獲取教師課表
                const teacherSchedule = jsonData.teachers[teacherName].schedule;
                
                // 找出該教師所有無課務的節次（B陣列）
                const freeSlots = [];
                for (let p = 0; p < 7; p++) {
                    for (let d = 0; d < 5; d++) {
                        // 確保teacherSchedule[p][d]存在
                        if (teacherSchedule[p] && teacherSchedule[p][d] && teacherSchedule[p][d].length === 0) {
                            freeSlots.push({ day: d + 1, period: p + 1 });
                        }
                    }
                }
                
                // 確保班級課表存在
                if (!jsonData.classes[classCode] || !jsonData.classes[classCode].schedule) {
                    showNotification(\`找不到班級 \${classCode} 的課表資料\`, 'error');
                    return;
                }
                
                // 獲取班級課表
                const classSchedule = jsonData.classes[classCode].schedule;
                
                // 生成班級調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'class-swap-cell';
                        
                        // 確保classSchedule[period][day]存在
                        if (classSchedule[period] && classSchedule[period][day]) {
                            const courses = classSchedule[period][day];
                            if (courses.length > 0) {
                                courses.forEach(course => {
                                    const courseItem = document.createElement('div');
                                    courseItem.className = 'class-swap-item';
                                    
                                    const subjectDiv = document.createElement('div');
                                    subjectDiv.className = 'class-swap-name';
                                    subjectDiv.textContent = course.subject;
                                    
                                    const teacherDiv = document.createElement('div');
                                    teacherDiv.className = 'teacher-name';
                                    
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            teacherDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        teacherDiv.appendChild(teacherSpan);
                                    });
                                    
                                    courseItem.appendChild(subjectDiv);
                                    courseItem.appendChild(teacherDiv);
                                    cell.appendChild(courseItem);
                                });
                            } else {
                                // 添加空堂樣式
                                const emptySlot = document.createElement('div');
                                emptySlot.className = 'empty-slot';
                                emptySlot.textContent = '  ';
                                cell.appendChild(emptySlot);
                            }
                            
                            // 檢查是否為B陣列中的節次
                            const isFreeSlot = freeSlots.some(slot => slot.day === day + 1 && slot.period === period + 1);
                            
                            if (isFreeSlot) {
                                // 檢查該節次是否有可調課的教師
                                const availableTeachers = [];
                                
                                // 獲取所有教師
                                const allTeachers = Object.keys(jsonData.teachers);
                                
                                // 遍歷所有教師（除了當前教師）
                                allTeachers.forEach(t => {
                                    if (t === teacherName) return;
                                    
                                    // 確保教師課表存在
                                    if (!jsonData.teachers[t] || !jsonData.teachers[t].schedule) {
                                        return;
                                    }
                                    
                                    const tSchedule = jsonData.teachers[t].schedule;
                                    
                                    // 檢查該教師是否在A節次（點擊的節次）無課務
                                    const aDayIndex = day - 1;
                                    const aPeriodIndex = period - 1;
                                    
                                    // 確保tSchedule[aPeriodIndex][aDayIndex]存在
                                    if (tSchedule[aPeriodIndex] && tSchedule[aPeriodIndex][aDayIndex] && tSchedule[aPeriodIndex][aDayIndex].length > 0) {
                                        return; // 在A節次有課務，跳過
                                    }
                                    
                                    // 檢查該教師是否在B陣列節次有課務且任教該班
                                    let hasTeachingInB = false;
                                    for (const slot of freeSlots) {
                                        const bDayIndex = slot.day - 1;
                                        const bPeriodIndex = slot.period - 1;
                                        
                                        // 確保tSchedule[bPeriodIndex][bDayIndex]存在
                                        if (tSchedule[bPeriodIndex] && tSchedule[bPeriodIndex][bDayIndex]) {
                                            const courses = tSchedule[bPeriodIndex][bDayIndex];
                                            if (courses.length > 0 && courses.some(course => course.class === classCode)) {
                                                hasTeachingInB = true;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (hasTeachingInB) {
                                        availableTeachers.push(t);
                                    }
                                });
                                
                                // 如果有可調課的教師，添加"有空堂"標記
                                if (availableTeachers.length > 0) {
                                    const availableSlot = document.createElement('div');
                                    availableSlot.className = 'available-slot';
                                    availableSlot.textContent = '有空堂';
                                    cell.appendChild(availableSlot);
                                }
                            }
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    classSwapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        classSwapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示班級調課表
                noData.style.display = 'none';
                
                showNotification('調課查詢成功', 'success');
            }
            
            // 切換到教師課表
            function switchToTeacherSchedule(teacherName) {
                // 切換到教師標籤頁
                document.querySelector('[data-tab="teacher"]').click();
                
                // 選擇教師
                teacherSelect.value = teacherName;
                
                // 查詢教師課表
                displaySchedule(teacherName, 'teacher');
            }
            
            // 切換到班級課表
            function switchToClassSchedule(classCode) {
                // 切換到班級標籤頁
                document.querySelector('[data-tab="class"]').click();
                
                // 選擇班級
                classSelect.value = classCode;
                
                // 查詢班級課表
                displaySchedule(classCode, 'class');
            }
            
            // 顯示通知
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = \`notification \${type}\`;
                notification.style.display = 'block';
                
                // 3秒後自動隱藏
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        });
    <\/script>
</body>
</html>`;
            }
            
            // 生成自訂獨立查詢頁面HTML
            function generateCustomStandaloneHtml(data, selectedFeatures) {
                // 將JSON資料轉換為字符串，並進行必要的轉義
                const jsonString = JSON.stringify(data);
                
                // 創建一個腳本標籤來存儲JSON資料
                const scriptTag = `<script id="schedule-data" type="application/json">${jsonString}<\/script>`;
                
                // 創建讀取JSON資料的函數
                const readDataFunction = `
                function getScheduleData() {
                    const scriptElement = document.getElementById('schedule-data');
                    return JSON.parse(scriptElement.textContent);
                }`;
                
                // 根據選擇的功能生成標籤頁按鈕
                let tabButtonsHtml = '';
                let tabContentsHtml = '';
                
                // 功能映射
                const featureMap = {
                    'class': {
                        title: '班級課表查詢',
                        content: `
                            <div class="input-section">
                                <select id="class-select" class="class-select">
                                    <option value="">請選擇班級</option>
                                </select>
                                <button id="search-class-btn" class="search-btn">查詢班級課表</button>
                                <button id="print-class-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    },
                    'teacher': {
                        title: '教師課表查詢',
                        content: `
                            <div class="input-section">
                                <select id="teacher-select" class="teacher-select">
                                    <option value="">請選擇教師</option>
                                </select>
                                <button id="search-teacher-btn" class="search-btn">查詢教師課表</button>
                                <button id="print-teacher-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    },
                    'subject': {
                        title: '科目查詢',
                        content: `
                            <div class="input-section">
                                <select id="subject-select" class="subject-select">
                                    <option value="">請選擇科目</option>
                                </select>
                                <button id="search-subject-btn" class="search-btn">查詢科目任課教師</button>
                                <button id="print-subject-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    },
                    'period': {
                        title: '節次任課查詢',
                        content: `
                            <div class="input-section">
                                <select id="day-select" class="day-select">
                                    <option value="">請選擇星期</option>
                                    <option value="1">星期一</option>
                                    <option value="2">星期二</option>
                                    <option value="3">星期三</option>
                                    <option value="4">星期四</option>
                                    <option value="5">星期五</option>
                                </select>
                                <select id="period-select" class="period-select">
                                    <option value="">請選擇節次</option>
                                    <option value="1">第1節</option>
                                    <option value="2">第2節</option>
                                    <option value="3">第3節</option>
                                    <option value="4">第4節</option>
                                    <option value="5">第5節</option>
                                    <option value="6">第6節</option>
                                    <option value="7">第7節</option>
                                    <option value="8">第8節</option>
                                </select>
                                <button id="search-period-btn" class="search-btn">查詢節次任課</button>
                                <button id="print-period-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    },
                    'swap': {
                        title: '同班無課教師查詢',
                        content: `
                            <div class="input-section">
                                <select id="swap-teacher-select" class="swap-teacher-select">
                                    <option value="">請選擇教師</option>
                                </select>
                                <button id="search-swap-btn" class="search-btn">查詢教師課表</button>
                                <button id="print-swap-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    },
                    'weekly-subject': {
                        title: '每週科目課表',
                        content: `
                            <div class="input-section">
                                <select id="weekly-subject-select" class="subject-select">
                                    <option value="">請選擇科目</option>
                                </select>
                                <button id="search-weekly-subject-btn" class="search-btn">查詢每週科目課表</button>
                                <button id="print-weekly-subject-btn" class="print-btn no-print">課表列印</button>
                            </div>`
                    }
                };
                
                // 生成標籤頁按鈕和內容
                let firstTab = true;
                selectedFeatures.forEach(feature => {
                    if (featureMap[feature]) {
                        const isActive = firstTab ? 'active' : '';
                        tabButtonsHtml += `<button class="tab-button ${isActive}" data-tab="${feature}">${featureMap[feature].title}</button>`;
                        tabContentsHtml += `
                            <div id="${feature}-tab" class="tab-content ${isActive}">
                                ${featureMap[feature].content}
                            </div>`;
                        firstTab = false;
                    }
                });
                
                // 生成對應的JavaScript事件監聽器
                let eventListenersJs = '';
                selectedFeatures.forEach(feature => {
                    if (feature === 'class') {
                        eventListenersJs += `
            // 監聽班級查詢按鈕
            searchClassBtn.addEventListener('click', function() {
                const classCode = classSelect.value;
                if (!classCode) {
                    showNotification('請選擇班級', 'error');
                    return;
                }
                
                displaySchedule(classCode, 'class');
            });
            
            // 監聽班級課表列印按鈕
            printClassBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢班級課表', 'error');
                    return;
                }
                window.print();
            });`;
                    } else if (feature === 'teacher') {
                        eventListenersJs += `
            // 監聽教師查詢按鈕
            searchTeacherBtn.addEventListener('click', function() {
                const teacherName = teacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                displaySchedule(teacherName, 'teacher');
            });
            
            // 監聽教師課表列印按鈕
            printTeacherBtn.addEventListener('click', function() {
                if (scheduleTable.style.display === 'none') {
                    showNotification('請先查詢教師課表', 'error');
                    return;
                }
                window.print();
            });`;
                    } else if (feature === 'subject') {
                        eventListenersJs += `
            // 監聽科目查詢按鈕
            searchSubjectBtn.addEventListener('click', function() {
                const subjectName = subjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                displaySubjectSchedule(subjectName);
            });
            
            // 監聽科目課表列印按鈕
            printSubjectBtn.addEventListener('click', function() {
                if (subjectTable.style.display === 'none') {
                    showNotification('請先查詢科目課表', 'error');
                    return;
                }
                window.print();
            });`;
                    } else if (feature === 'period') {
                        eventListenersJs += `
            // 監聽節次查詢按鈕
            searchPeriodBtn.addEventListener('click', function() {
                const day = daySelect.value;
                const period = periodSelect.value;
                
                if (!day) {
                    showNotification('請選擇星期', 'error');
                    return;
                }
                
                if (!period) {
                    showNotification('請選擇節次', 'error');
                    return;
                }
                
                displayPeriodSchedule(day, period);
            });
            
            // 監聽節次課表列印按鈕
            printPeriodBtn.addEventListener('click', function() {
                if (periodTable.style.display === 'none') {
                    showNotification('請先查詢節次課表', 'error');
                    return;
                }
                window.print();
            });`;
                    } else if (feature === 'swap') {
                        eventListenersJs += `
            // 監聽調課查詢按鈕
            searchSwapBtn.addEventListener('click', function() {
                const teacherName = swapTeacherSelect.value;
                if (!teacherName) {
                    showNotification('請選擇教師', 'error');
                    return;
                }
                
                displaySwapSchedule(teacherName);
            });
            
            // 監聽調課課表列印按鈕
            printSwapBtn.addEventListener('click', function() {
                if (swapTable.style.display === 'none' && swapResultTable.style.display === 'none' && classSwapTable.style.display === 'none') {
                    showNotification('請先查詢調課課表', 'error');
                    return;
                }
                window.print();
            });`;
                    } else if (feature === 'weekly-subject') {
                        eventListenersJs += `
            // 監聽每週科目課表查詢按鈕
            searchWeeklySubjectBtn.addEventListener('click', function() {
                const subjectName = weeklySubjectSelect.value;
                if (!subjectName) {
                    showNotification('請選擇科目', 'error');
                    return;
                }
                
                displayWeeklySubjectSchedule(subjectName);
            });
            
            // 監聽每週科目課表列印按鈕
            printWeeklySubjectBtn.addEventListener('click', function() {
                if (weeklySubjectTable.style.display === 'none') {
                    showNotification('請先查詢每週科目課表', 'error');
                    return;
                }
                window.print();
            });`;
                    }
                });
                
                return `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教學組專用課表查詢系統V6.0</title>
    <style>
        * {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
        }
        
        .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
            transition: border-color 0.3s;
        }
        
        .class-select:focus, .teacher-select:focus, .subject-select:focus, .day-select:focus, .period-select:focus, .swap-teacher-select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .search-btn {
            background-color: #2ecc71;
        }
        
        .search-btn:hover {
            background-color: #27ae60;
        }
        
        .print-btn {
            background-color: #e74c3c;
        }
        
        .print-btn:hover {
            background-color: #c0392b;
        }
        
        .swap-btn {
            background-color: #f39c12;
            font-size: 14px;
            padding: 5px 10px;
            margin-top: 5px;
        }
        
        .swap-btn:hover {
            background-color: #e67e22;
        }
        
        .schedule-container {
            overflow-x: auto;
        }
        
        .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, 
        .period-table th, .period-table td, .swap-table th, .swap-table td,
        .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
            border: 2px solid #2c3e50;
            padding: 12px 15px;
            text-align: center;
            vertical-align: middle;
        }
        
        .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            position: sticky;
            top: 0;
        }
        
        .schedule-table tr:nth-child(even), .subject-table tr:nth-child(even), 
        .period-table tr:nth-child(even), .swap-table tr:nth-child(even),
        .swap-result-table tr:nth-child(even), .class-swap-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .schedule-table tr:hover, .subject-table tr:hover, 
        .period-table tr:hover, .swap-table tr:hover,
        .swap-result-table tr:hover, .class-swap-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .time-slot {
            background-color: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            width: 80px;
        }
        
        .course-cell, .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
        }
        
        .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 4px;
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
        }
        
        .course-item:last-child, .subject-item:last-child, .period-item:last-child, .swap-item:last-child, .class-swap-item:last-child {
            margin-bottom: 0;
        }
        
        .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .detail-name {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .clickable {
            cursor: pointer;
            text-decoration: none;
            color: #3498db;
        }
        
        .clickable:hover {
            color: #2980b9;
        }
        
        .teacher-link {
            color: #27ae60; /* 深綠色 */
        }
        
        .teacher-link:hover {
            color: #229954; /* 深綠色的懸停顏色 */
        }
        
        .free-teacher {
            color: #d35400; /* 橘棕色 */
        }
        
        .available-slot {
            color: #27ae60;
            font-weight: bold;
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 3px solid #27ae60;
            padding: 6px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        
        .error {
            background-color: #ffecec;
            color: #e74c3c;
            border: 1px solid #f5aca6;
        }
        
        .success {
            background-color: #e8f8f5;
            color: #2ecc71;
            border: 1px solid #a9e8d3;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .lunch-break {
            background-color: #fff9e6;
            color: #f39c12;
            font-weight: bold;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        
        .print-area {
            margin-top: 20px;
        }
        
        /* 新增樣式用於科目查詢的表格顯示 */
        .grade-header {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
        }
        
        .grade-separator {
            height: 20px;
            background-color: #f5f7fa;
        }
        
        .subject-cell, .period-cell, .swap-cell, .class-swap-cell {
            min-height: 80px;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }
        
        .subject-cell .class-name, .subject-cell .teacher-name, 
        .period-cell .class-name, .period-cell .teacher-name, 
        .period-cell .subject-name, .swap-cell .class-name, 
        .swap-cell .teacher-name, .swap-cell .subject-name,
        .class-swap-cell .class-name, .class-swap-cell .teacher-name, 
        .class-swap-cell .subject-name {
            display: block;
            margin: 5px 0;
        }
        
        .no-teacher-header {
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
            margin-top: 30px;
        }
        
        .swap-result-section {
            margin-top: 30px;
        }
        
        .swap-teacher-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .swap-teacher-info h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .swap-teacher-info p {
            margin-bottom: 5px;
        }
        
        .class-swap-section {
            margin-top: 30px;
        }
        
        .class-swap-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        /* 空堂樣式 */
        .empty-slot {
            /*color: #bdc3c7;*/
            font-style: italic;
            font-size: 0.9em;
            padding: 10px;
            /* border: 0px dashed #ddd;*/
            border-radius: 0px;
            /*background-color: #fafafa;*/
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .class-select, .teacher-select, .subject-select, .day-select, .period-select, .swap-teacher-select, .search-btn, .print-btn {
                width: 100%;
            }
            
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.9rem;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 8px 10px;
            }
            
            .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                font-size: 0.8rem;
            }
            
            .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                padding: 6px 8px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* 列印樣式優化 */
            .schedule-table, .subject-table, .period-table, .swap-table, .swap-result-table, .class-swap-table {
                border-collapse: collapse !important;
                width: 100% !important;
            }
            
            .schedule-table th, .schedule-table td, .subject-table th, .subject-table td, .period-table th, .period-table td, .swap-table th, .swap-table td, .swap-result-table th, .swap-result-table td, .class-swap-table th, .class-swap-table td {
                border: 2px solid #000 !important;
                padding: 8px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            .schedule-table th, .subject-table th, .period-table th, .swap-table th, .swap-result-table th, .class-swap-table th {
                background-color: #2c3e50 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 1.1rem !important;
            }
            
            .schedule-header, .subject-header, .period-header, .swap-header, .swap-result-header, .class-swap-header {
                font-size: 1.8rem !important;
                font-weight: bold !important;
                margin-bottom: 20px !important;
                color: #000 !important;
            }
            
            .course-item, .subject-item, .period-item, .swap-item, .class-swap-item {
                border-left: 3px solid #3498db !important;
                background-color: rgba(52, 152, 219, 0.1) !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-bottom: 8px !important;
                page-break-inside: avoid;
            }
            
            .course-name, .subject-name, .period-name, .swap-name, .class-swap-name {
                font-weight: bold !important;
                color: #000 !important;
                margin-bottom: 4px !important;
            }
            
            .detail-name {
                color: #333 !important;
                font-size: 0.9em !important;
            }
            
            .lunch-break {
                background-color: #fff9e6 !important;
                color: #f39c12 !important;
                font-weight: bold !important;
            }
            
            .grade-header, .no-teacher-header {
                background-color: #3498db !important;
                color: white !important;
                font-weight: bold !important;
                text-align: center !important;
                padding: 10px !important;
                font-size: 1.2rem !important;
            }
            
            .no-teacher-header {
                background-color: #e74c3c !important;
            }
            
            .clickable {
                text-decoration: none !important;
            }
            
            .teacher-link {
                color: #27ae60 !important;
            }
            
            .free-teacher {
                color: #d35400 !important;
            }
            
            .available-slot {
                color: #27ae60 !important;
                font-weight: bold !important;
                background-color: rgba(39, 174, 96, 0.1) !important;
                border-left: 3px solid #27ae60 !important;
                padding: 6px !important;
                border-radius: 4px !important;
                margin-top: 5px !important;
            }
            
            .empty-slot {
                color: #999 !important;
                font-style: italic !important;
                border: 1px dashed #ccc !important;
                background-color: #f9f9f9 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>教學組專用課表查詢系統V6.0</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                ${tabButtonsHtml}
            </div>
            
            ${tabContentsHtml}
        </div>
        
        <div id="notification" class="notification"></div>
        
        <div class="print-area">
            <div id="schedule-header" class="schedule-header" style="display: none;"></div>
            <div id="subject-header" class="subject-header" style="display: none;"></div>
            <div id="period-header" class="period-header" style="display: none;"></div>
            <div id="swap-header" class="swap-header" style="display: none;"></div>
            <div id="swap-result-header" class="swap-result-header" style="display: none;"></div>
            <div id="class-swap-header" class="class-swap-header" style="display: none;"></div>
            <div id="weekly-subject-header" class="schedule-header" style="display: none;"></div>
            <div class="schedule-container">
                <table id="schedule-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <!-- 課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="subject-table" class="subject-table" style="display: none;">
                    <tbody id="subject-body">
                        <!-- 科目任課教師內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="period-table" class="period-table" style="display: none;">
                    <tbody id="period-body">
                        <!-- 節次任課內容將動態生成 -->
                    </tbody>
                </table>
                
                <table id="swap-table" class="swap-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="swap-body">
                        <!-- 調課查詢內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="swap-result-section" class="swap-result-section" style="display: none;">
                    <div id="swap-teacher-info" class="swap-teacher-info" style="display: none;">
                        <h3>調課資訊</h3>
                        <p><strong>教師：</strong><span id="swap-teacher-name"></span></p>
                        <p><strong>調課時間：</strong><span id="swap-time"></span></p>
                        <p><strong>班級：</strong><span id="swap-class"></span></p>
                        <p><strong>科目：</strong><span id="swap-subject"></span></p>
                    </div>
                    
                    <table id="swap-result-table" class="swap-result-table">
                        <thead>
                            <tr>
                                <th>教師</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="swap-result-body">
                            <!-- 調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="class-swap-section" class="class-swap-section" style="display: none;">
                    <table id="class-swap-table" class="class-swap-table">
                        <thead>
                            <tr>
                                <th>節次</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="class-swap-body">
                            <!-- 班級調課結果內容將動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <table id="weekly-subject-table" class="schedule-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>節次</th>
                            <th>星期一</th>
                            <th>星期二</th>
                            <th>星期三</th>
                            <th>星期四</th>
                            <th>星期五</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-subject-body">
                        <!-- 每週科目課表內容將動態生成 -->
                    </tbody>
                </table>
                
                <div id="no-data" class="no-data" style="display: none;">
                    請選擇查詢類型並輸入查詢條件
                </div>
            </div>
        </div>
        
        <div class="legend no-print">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>表頭</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ecf0f1;"></div>
                <span>節次</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f9f9f9;"></div>
                <span>課程內容</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>班級連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>教師連結</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d35400;"></div>
                <span>無課務教師</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>有空堂</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff9e6;"></div>
                <span>午休分隔</span>
            </div>
        </div>
        
        <div class="footer no-print">
            本網頁程式 design by koming 2025
        </div>
    </div>

    <!-- 隱藏的JSON資料 -->
    ${scriptTag}

    <script>
        ${readDataFunction}

        document.addEventListener('DOMContentLoaded', function() {
            const classSelect = document.getElementById('class-select');
            const teacherSelect = document.getElementById('teacher-select');
            const subjectSelect = document.getElementById('subject-select');
            const daySelect = document.getElementById('day-select');
            const periodSelect = document.getElementById('period-select');
            const swapTeacherSelect = document.getElementById('swap-teacher-select');
            const weeklySubjectSelect = document.getElementById('weekly-subject-select');
            const searchClassBtn = document.getElementById('search-class-btn');
            const searchTeacherBtn = document.getElementById('search-teacher-btn');
            const searchSubjectBtn = document.getElementById('search-subject-btn');
            const searchPeriodBtn = document.getElementById('search-period-btn');
            const searchSwapBtn = document.getElementById('search-swap-btn');
            const searchWeeklySubjectBtn = document.getElementById('search-weekly-subject-btn');
            const printClassBtn = document.getElementById('print-class-btn');
            const printTeacherBtn = document.getElementById('print-teacher-btn');
            const printSubjectBtn = document.getElementById('print-subject-btn');
            const printPeriodBtn = document.getElementById('print-period-btn');
            const printSwapBtn = document.getElementById('print-swap-btn');
            const printWeeklySubjectBtn = document.getElementById('print-weekly-subject-btn');
            const scheduleHeader = document.getElementById('schedule-header');
            const subjectHeader = document.getElementById('subject-header');
            const periodHeader = document.getElementById('period-header');
            const swapHeader = document.getElementById('swap-header');
            const swapResultHeader = document.getElementById('swap-result-header');
            const classSwapHeader = document.getElementById('class-swap-header');
            const weeklySubjectHeader = document.getElementById('weekly-subject-header');
            const scheduleTable = document.getElementById('schedule-table');
            const subjectTable = document.getElementById('subject-table');
            const periodTable = document.getElementById('period-table');
            const swapTable = document.getElementById('swap-table');
            const swapResultTable = document.getElementById('swap-result-table');
            const classSwapTable = document.getElementById('class-swap-table');
            const weeklySubjectTable = document.getElementById('weekly-subject-table');
            const scheduleBody = document.getElementById('schedule-body');
            const subjectBody = document.getElementById('subject-body');
            const periodBody = document.getElementById('period-body');
            const swapBody = document.getElementById('swap-body');
            const swapResultBody = document.getElementById('swap-result-body');
            const classSwapBody = document.getElementById('class-swap-body');
            const weeklySubjectBody = document.getElementById('weekly-subject-body');
            const swapResultSection = document.getElementById('swap-result-section');
            const classSwapSection = document.getElementById('class-swap-section');
            const swapTeacherInfo = document.getElementById('swap-teacher-info');
            const swapTeacherName = document.getElementById('swap-teacher-name');
            const swapTime = document.getElementById('swap-time');
            const swapClass = document.getElementById('swap-class');
            const swapSubject = document.getElementById('swap-subject');
            const noData = document.getElementById('no-data');
            const notification = document.getElementById('notification');
            
            // 標籤頁功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // 移除所有標籤的active類
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 為當前標籤添加active類
                    button.classList.add('active');
                    document.getElementById(\`\${tabId}-tab\`).classList.add('active');
                });
            });
            
            // 從隱藏的script標籤讀取JSON資料
            const jsonData = getScheduleData();
            
            // 填充班級、教師和科目下拉選單
            ${selectedFeatures.includes('class') ? 'populateClassSelect(jsonData.classes);' : ''}
            ${selectedFeatures.includes('teacher') ? 'populateTeacherSelect(jsonData.teachers);' : ''}
            ${selectedFeatures.includes('subject') || selectedFeatures.includes('weekly-subject') ? 'populateSubjectSelect(jsonData.subjects);' : ''}
            ${selectedFeatures.includes('swap') ? 'populateSwapTeacherSelect(jsonData.teachers);' : ''}
            
            ${eventListenersJs}
            
            // 填充班級下拉選單
            function populateClassSelect(classes) {
                // 清空選單
                classSelect.innerHTML = '<option value="">請選擇班級</option>';
                
                // 添加班級選項
                Object.keys(classes).sort().forEach(classCode => {
                    const option = document.createElement('option');
                    option.value = classCode;
                    option.textContent = \`\${classCode} - \${classes[classCode].className}\`;
                    classSelect.appendChild(option);
                });
            }
            
            // 填充教師下拉選單
            function populateTeacherSelect(teachers) {
                // 清空選單
                teacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    teacherSelect.appendChild(option);
                });
            }
            
            // 填充調課教師下拉選單
            function populateSwapTeacherSelect(teachers) {
                // 清空選單
                swapTeacherSelect.innerHTML = '<option value="">請選擇教師</option>';
                
                // 添加教師選項
                Object.keys(teachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    swapTeacherSelect.appendChild(option);
                });
            }
            
            // 填充科目下拉選單
            function populateSubjectSelect(subjects) {
                // 清空選單
                subjectSelect.innerHTML = '<option value="">請選擇科目</option>';
                ${selectedFeatures.includes('weekly-subject') ? 'weeklySubjectSelect.innerHTML = \'<option value="">請選擇科目</option>\';' : ''}
                
                // 添加科目選項
                Object.keys(subjects).sort().forEach(subjectName => {
                    const option = document.createElement('option');
                    option.value = subjectName;
                    option.textContent = subjectName;
                    subjectSelect.appendChild(option);
                    ${selectedFeatures.includes('weekly-subject') ? 'weeklySubjectSelect.appendChild(option.cloneNode(true));' : ''}
                });
            }
            
            // 顯示課表
            function displaySchedule(queryCode, type) {
                let scheduleData;
                
                // 隱藏其他表格
                scheduleTable.style.display = 'table';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'block';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                if (type === 'class') {
                    if (!jsonData.classes[queryCode]) {
                        showNotification(\`找不到班級 \${queryCode} 的課表資料\`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = \`找不到班級 \${queryCode} 的課表資料\`;
                        return;
                    }
                    scheduleData = jsonData.classes[queryCode].schedule;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = \`\${jsonData.classes[queryCode].className} 的班級課表\`;
                } else {
                    if (!jsonData.teachers[queryCode]) {
                        showNotification(\`找不到教師 \${queryCode} 的課表資料\`, 'error');
                        scheduleTable.style.display = 'none';
                        noData.style.display = 'block';
                        noData.textContent = \`找不到教師 \${queryCode} 的課表資料\`;
                        return;
                    }
                    scheduleData = jsonData.teachers[queryCode].schedule;
                    
                    // 顯示課表標題
                    scheduleHeader.textContent = \`\${queryCode} 老師的課表\`;
                }
                
                // 清空課表內容
                scheduleBody.innerHTML = '';
                
                // 生成課表HTML
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'course-item';
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'course-name';
                                subjectDiv.textContent = course.subject;
                                
                                const detailDiv = document.createElement('div');
                                detailDiv.className = 'detail-name';
                                
                                if (type === 'class') {
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            detailDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        detailDiv.appendChild(teacherSpan);
                                    });
                                } else {
                                    detailDiv.className = 'detail-name clickable';
                                    detailDiv.textContent = course.className || course.class;
                                    detailDiv.setAttribute('data-class', course.class);
                                    detailDiv.addEventListener('click', function() {
                                        switchToClassSchedule(course.class);
                                    });
                                }
                                
                                courseItem.appendChild(subjectDiv);
                                courseItem.appendChild(detailDiv);
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    scheduleBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        scheduleBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示課表
                noData.style.display = 'none';
                
                const successMessage = type === 'class' 
                    ? \`班級 \${queryCode} 課表查詢成功\` 
                    : \`教師 \${queryCode} 課表查詢成功\`;
                    
                showNotification(successMessage, 'success');
            }
            
            ${selectedFeatures.includes('subject') ? `
            // 顯示科目課表
            function displaySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(\`找不到科目 \${subjectName} 的任課資料\`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到科目 \${subjectName} 的任課資料\`;
                    return;
                }
                
                // 隱藏其他表格，顯示科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'table';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'block';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示科目標題（置中）
                subjectHeader.textContent = \`\${subjectName} 的所有班級的任課教師一覽表\`;
                subjectHeader.style.textAlign = 'center';
                
                // 清空科目表內容
                subjectBody.innerHTML = '';
                
                // 獲取科目資料
                const subjectData = jsonData.subjects[subjectName];
                
                // 按班級代碼排序
                subjectData.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                subjectData.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = \`\${grade} 年級\`;
                    gradeRow.appendChild(gradeCell);
                    subjectBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    subjectBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'subject-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teacher;
                                teacherDiv.setAttribute('data-teacher', item.teacher);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teacher);
                                });
                                
                                // 將班級和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        subjectBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        subjectBody.appendChild(separatorRow);
                    }
                });
                
                // 顯示科目表
                noData.style.display = 'none';
                
                showNotification(\`科目 \${subjectName} 查詢成功\`, 'success');
            }` : ''}
            
            ${selectedFeatures.includes('period') ? `
            // 顯示節次課表
            function displayPeriodSchedule(day, period) {
                // 隱藏其他表格，顯示節次表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'table';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'block';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 顯示節次標題（置中）
                periodHeader.textContent = \`\${dayNames[day]} 第\${period}節 教師任課一覽表\`;
                periodHeader.style.textAlign = 'center';
                
                // 清空節次表內容
                periodBody.innerHTML = '';
                
                // 獲取所有班級
                const allClasses = Object.keys(jsonData.classes);
                
                // 收集該節次有課務的班級和教師
                const periodClasses = [];
                const busyTeachers = new Set();
                
                // 轉換為索引
                const dayIndex = parseInt(day) - 1;
                const periodIndex = parseInt(period) - 1;
                
                // 遍歷所有班級，找出該節次有課務的班級
                allClasses.forEach(classCode => {
                    const classData = jsonData.classes[classCode];
                    const courses = classData.schedule[periodIndex][dayIndex];
                    
                    if (courses.length > 0) {
                        courses.forEach(course => {
                            // 添加班級資料
                            periodClasses.push({
                                class: classCode,
                                className: classData.className,
                                teachers: course.teachers,
                                subject: course.subject
                            });
                            
                            // 添加教師到忙碌教師集合
                            course.teachers.forEach(teacher => {
                                busyTeachers.add(teacher);
                            });
                        });
                    }
                });
                
                // 按班級代碼排序
                periodClasses.sort((a, b) => {
                    // 提取年級部分進行比較
                    const gradeA = parseInt(a.class.substring(0, 1));
                    const gradeB = parseInt(b.class.substring(0, 1));
                    
                    if (gradeA !== gradeB) {
                        return gradeA - gradeB;
                    }
                    
                    // 如果年級相同，則按完整班級代碼排序
                    return a.class.localeCompare(b.class, undefined, { numeric: true });
                });
                
                // 按年級分組
                const gradeGroups = {};
                periodClasses.forEach(item => {
                    const grade = item.class.substring(0, 1); // 提取年級（第一個字元）
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = [];
                    }
                    gradeGroups[grade].push(item);
                });
                
                // 為每個年級創建表格
                Object.keys(gradeGroups).sort().forEach(grade => {
                    const gradeData = gradeGroups[grade];
                    
                    // 創建年級標題行
                    const gradeRow = document.createElement('tr');
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-header';
                    gradeCell.colSpan = 10; // 10個班級一行
                    gradeCell.textContent = \`\${grade} 年級\`;
                    gradeRow.appendChild(gradeCell);
                    periodBody.appendChild(gradeRow);
                    
                    // 計算需要多少行來顯示所有班級（每行10個班級）
                    const rowsNeeded = Math.ceil(gradeData.length / 10);
                    
                    // 創建標題行
                    const headerRow = document.createElement('tr');
                    for (let i = 0; i < 10; i++) {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = '班級';
                        headerRow.appendChild(headerCell);
                    }
                    periodBody.appendChild(headerRow);
                    
                    // 創建內容行
                    for (let row = 0; row < rowsNeeded; row++) {
                        const contentRow = document.createElement('tr');
                        
                        // 為每個班級創建單元格
                        for (let col = 0; col < 10; col++) {
                            const index = row * 10 + col;
                            const cell = document.createElement('td');
                            cell.className = 'period-cell';
                            
                            if (index < gradeData.length) {
                                const item = gradeData[index];
                                
                                // 創建班級名稱元素
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = item.className;
                                classDiv.setAttribute('data-class', item.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(item.class);
                                });
                                
                                // 創建科目名稱元素
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = item.subject;
                                
                                // 創建教師名稱元素
                                const teacherDiv = document.createElement('div');
                                teacherDiv.className = 'teacher-name clickable teacher-link';
                                teacherDiv.textContent = item.teachers.join('、');
                                teacherDiv.setAttribute('data-teacher', item.teachers[0]);
                                teacherDiv.addEventListener('click', function() {
                                    switchToTeacherSchedule(item.teachers[0]);
                                });
                                
                                // 將班級、科目和教師添加到單元格
                                cell.appendChild(classDiv);
                                cell.appendChild(subjectDiv);
                                cell.appendChild(teacherDiv);
                            }
                            
                            contentRow.appendChild(cell);
                        }
                        
                        periodBody.appendChild(contentRow);
                    }
                    
                    // 在不同年級之間添加分隔行
                    if (grade < Object.keys(gradeGroups).sort()[Object.keys(gradeGroups).length - 1]) {
                        const separatorRow = document.createElement('tr');
                        const separatorCell = document.createElement('td');
                        separatorCell.className = 'grade-separator';
                        separatorCell.colSpan = 10;
                        separatorCell.innerHTML = '&nbsp;';
                        separatorRow.appendChild(separatorCell);
                        periodBody.appendChild(separatorRow);
                    }
                });
                
                // 創建無課務教師標題行
                const noTeacherRow = document.createElement('tr');
                const noTeacherCell = document.createElement('td');
                noTeacherCell.className = 'no-teacher-header';
                noTeacherCell.colSpan = 10;
                noTeacherCell.textContent = '本節無課務教師一覽表';
                noTeacherRow.appendChild(noTeacherCell);
                periodBody.appendChild(noTeacherRow);
                
                // 獲取所有教師
                const allTeachers = Object.keys(jsonData.teachers);
                
                // 找出無課務的教師
                const freeTeachers = allTeachers.filter(teacher => !busyTeachers.has(teacher));
                
                // 按教師姓名排序
                freeTeachers.sort();
                
                // 計算需要多少行來顯示所有教師（每行10個教師）
                const teacherRowsNeeded = Math.ceil(freeTeachers.length / 10);
                
                // 創建標題行
                const teacherHeaderRow = document.createElement('tr');
                for (let i = 0; i < 10; i++) {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = '教師';
                    teacherHeaderRow.appendChild(headerCell);
                }
                periodBody.appendChild(teacherHeaderRow);
                
                // 創建內容行
                for (let row = 0; row < teacherRowsNeeded; row++) {
                    const teacherContentRow = document.createElement('tr');
                    
                    // 為每個教師創建單元格
                    for (let col = 0; col < 10; col++) {
                        const index = row * 10 + col;
                        const cell = document.createElement('td');
                        cell.className = 'period-cell';
                        
                        if (index < freeTeachers.length) {
                            const teacher = freeTeachers[index];
                            
                            // 創建教師名稱元素
                            const teacherDiv = document.createElement('div');
                            teacherDiv.className = 'teacher-name clickable free-teacher';
                            teacherDiv.textContent = teacher;
                            teacherDiv.setAttribute('data-teacher', teacher);
                            teacherDiv.addEventListener('click', function() {
                                switchToTeacherSchedule(teacher);
                            });
                            
                            // 將教師添加到單元格
                            cell.appendChild(teacherDiv);
                        }
                        
                        teacherContentRow.appendChild(cell);
                    }
                    
                    periodBody.appendChild(teacherContentRow);
                }
                
                // 顯示節次表
                noData.style.display = 'none';
                
                showNotification(\`\${dayNames[day]} 第\${period}節 查詢成功\`, 'success');
            }` : ''}
            
            ${selectedFeatures.includes('swap') ? `
            // 顯示調課查詢課表
            function displaySwapSchedule(teacherName) {
                // 隱藏其他表格，顯示調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'table';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'block';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'none';
                
                // 顯示調課標題（置中）
                swapHeader.textContent = \`\${teacherName} 老師的課表\`;
                swapHeader.style.textAlign = 'center';
                
                // 清空調課表內容
                swapBody.innerHTML = '';
                
                if (!jsonData.teachers[teacherName]) {
                    showNotification(\`找不到教師 \${teacherName} 的課表資料\`, 'error');
                    swapTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到教師 \${teacherName} 的課表資料\`;
                    return;
                }
                
                const scheduleData = jsonData.teachers[teacherName].schedule;
                
                // 生成調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'swap-cell';
                        
                        const courses = scheduleData[period][day];
                        if (courses.length > 0) {
                            courses.forEach(course => {
                                const courseItem = document.createElement('div');
                                courseItem.className = 'swap-item';
                                
                                const classDiv = document.createElement('div');
                                classDiv.className = 'class-name clickable';
                                classDiv.textContent = course.className || course.class;
                                classDiv.setAttribute('data-class', course.class);
                                classDiv.addEventListener('click', function() {
                                    switchToClassSchedule(course.class);
                                });
                                
                                const subjectDiv = document.createElement('div');
                                subjectDiv.className = 'subject-name';
                                subjectDiv.textContent = course.subject;
                                
                                // 創建調課按鈕
                                const swapBtn = document.createElement('button');
                                swapBtn.className = 'swap-btn';
                                swapBtn.textContent = '調課';
                                swapBtn.setAttribute('data-teacher', teacherName);
                                swapBtn.setAttribute('data-day', day + 1);
                                swapBtn.setAttribute('data-period', period + 1);
                                swapBtn.setAttribute('data-class', course.class);
                                swapBtn.setAttribute('data-subject', course.subject);
                                swapBtn.addEventListener('click', function() {
                                    findAvailableTeachersForSwap(
                                        teacherName,
                                        day + 1,
                                        period + 1,
                                        course.class,
                                        course.subject
                                    );
                                });
                                
                                courseItem.appendChild(classDiv);
                                courseItem.appendChild(subjectDiv);
                                courseItem.appendChild(swapBtn);
                                cell.appendChild(courseItem);
                            });
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    swapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        swapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示調課表
                noData.style.display = 'none';
                
                showNotification(\`教師 \${teacherName} 課表查詢成功\`, 'success');
            }` : ''}
            
            ${selectedFeatures.includes('weekly-subject') ? `
            // 顯示每週科目課表
            function displayWeeklySubjectSchedule(subjectName) {
                if (!jsonData.subjects[subjectName]) {
                    showNotification(\`找不到科目 \${subjectName} 的任課資料\`, 'error');
                    scheduleTable.style.display = 'none';
                    subjectTable.style.display = 'none';
                    periodTable.style.display = 'none';
                    swapTable.style.display = 'none';
                    swapResultSection.style.display = 'none';
                    classSwapSection.style.display = 'none';
                    weeklySubjectTable.style.display = 'none';
                    noData.style.display = 'block';
                    noData.textContent = \`找不到科目 \${subjectName} 的任課資料\`;
                    return;
                }
                
                // 隱藏其他表格，顯示每週科目表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'none';
                weeklySubjectTable.style.display = 'table';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'none';
                weeklySubjectHeader.style.display = 'block';
                
                // 顯示標題
                weeklySubjectHeader.textContent = \`\${subjectName} 每週課表\`;
                weeklySubjectHeader.style.textAlign = 'center';
                
                // 清空內容
                weeklySubjectBody.innerHTML = '';
                
                // 收集資料
                const weeklyData = Array(8).fill(null).map(() => Array(5).fill(null).map(() => []));
                
                Object.keys(jsonData.classes).forEach(classCode => {
                    const classSchedule = jsonData.classes[classCode].schedule;
                    const className = jsonData.classes[classCode].className;
                    for (let p = 0; p < 8; p++) {
                        for (let d = 0; d < 5; d++) {
                            const courses = classSchedule[p][d];
                            courses.forEach(course => {
                                if (course.subject === subjectName) {
                                    course.teachers.forEach(teacher => {
                                        weeklyData[p][d].push({teacher, classCode, className});
                                    });
                                }
                            });
                        }
                    }
                });
                
                // 生成表格
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'course-cell';
                        
                        const entries = weeklyData[period][day];
                        if (entries.length > 0) {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'course-item';
                            
                            // 修改這部分：每個教師和班級組合單獨一行顯示
                            entries.forEach((entry, index) => {
                                const entryDiv = document.createElement('div');
                                entryDiv.style.marginBottom = '2px'; // 添加一些間距
                                
                                const span = document.createElement('span');
                                span.textContent = \`\${entry.teacher}(\${entry.className || entry.classCode})\`;
                                span.className = 'clickable teacher-link';
                                span.setAttribute('data-teacher', entry.teacher);
                                span.addEventListener('click', () => switchToTeacherSchedule(entry.teacher));
                                
                                entryDiv.appendChild(span);
                                itemDiv.appendChild(entryDiv);
                            });
                            
                            cell.appendChild(itemDiv);
                        } else {
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    weeklySubjectBody.appendChild(row);
                    
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        weeklySubjectBody.appendChild(lunchRow);
                    }
                }
                
                noData.style.display = 'none';
                showNotification(\`科目 \${subjectName} 每週課表查詢成功\`, 'success');
            }` : ''}
            
            ${selectedFeatures.includes('swap') ? `
            // 尋找可調課的教師
            function findAvailableTeachersForSwap(teacherName, day, period, classCode, subject) {
                // 星期文字對應
                const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五'];
                
                // 隱藏其他表格，顯示班級調課表
                scheduleTable.style.display = 'none';
                subjectTable.style.display = 'none';
                periodTable.style.display = 'none';
                swapTable.style.display = 'none';
                swapResultSection.style.display = 'none';
                classSwapSection.style.display = 'block';
                weeklySubjectTable.style.display = 'none';
                scheduleHeader.style.display = 'none';
                subjectHeader.style.display = 'none';
                periodHeader.style.display = 'none';
                swapHeader.style.display = 'none';
                swapResultHeader.style.display = 'none';
                classSwapHeader.style.display = 'block';
                weeklySubjectHeader.style.display = 'none';
                
                // 設置班級調課表標題
                classSwapHeader.textContent = \`\${jsonData.classes[classCode].className} 可調課教師一覽表\`;
                classSwapHeader.style.textAlign = 'center';
                
                // 清空班級調課表內容
                classSwapBody.innerHTML = '';
                
                // 確保教師課表存在
                if (!jsonData.teachers[teacherName] || !jsonData.teachers[teacherName].schedule) {
                    showNotification(\`找不到教師 \${teacherName} 的課表資料\`, 'error');
                    return;
                }
                
                // 獲取教師課表
                const teacherSchedule = jsonData.teachers[teacherName].schedule;
                
                // 找出該教師所有無課務的節次（B陣列）
                const freeSlots = [];
                for (let p = 0; p < 7; p++) {
                    for (let d = 0; d < 5; d++) {
                        // 確保teacherSchedule[p][d]存在
                        if (teacherSchedule[p] && teacherSchedule[p][d] && teacherSchedule[p][d].length === 0) {
                            freeSlots.push({ day: d + 1, period: p + 1 });
                        }
                    }
                }
                
                // 確保班級課表存在
                if (!jsonData.classes[classCode] || !jsonData.classes[classCode].schedule) {
                    showNotification(\`找不到班級 \${classCode} 的課表資料\`, 'error');
                    return;
                }
                
                // 獲取班級課表
                const classSchedule = jsonData.classes[classCode].schedule;
                
                // 生成班級調課表HTML
                for (let period = 0; period < 7; period++) {
                    const row = document.createElement('tr');
                    
                    // 添加節次標題
                    const timeSlotCell = document.createElement('td');
                    timeSlotCell.className = 'time-slot';
                    timeSlotCell.textContent = \`第\${period + 1}節\`;
                    row.appendChild(timeSlotCell);
                    
                    // 添加每天的課程
                    for (let day = 0; day < 5; day++) {
                        const cell = document.createElement('td');
                        cell.className = 'class-swap-cell';
                        
                        // 確保classSchedule[period][day]存在
                        if (classSchedule[period] && classSchedule[period][day]) {
                            const courses = classSchedule[period][day];
                            if (courses.length > 0) {
                                courses.forEach(course => {
                                    const courseItem = document.createElement('div');
                                    courseItem.className = 'class-swap-item';
                                    
                                    const subjectDiv = document.createElement('div');
                                    subjectDiv.className = 'class-swap-name';
                                    subjectDiv.textContent = course.subject;
                                    
                                    const teacherDiv = document.createElement('div');
                                    teacherDiv.className = 'teacher-name';
                                    
                                    // 為每個教師創建可點擊的元素
                                    course.teachers.forEach((teacher, index) => {
                                        if (index > 0) {
                                            teacherDiv.appendChild(document.createTextNode('、'));
                                        }
                                        
                                        const teacherSpan = document.createElement('span');
                                        teacherSpan.textContent = teacher;
                                        teacherSpan.className = 'clickable teacher-link';
                                        teacherSpan.setAttribute('data-teacher', teacher);
                                        teacherSpan.addEventListener('click', function() {
                                            switchToTeacherSchedule(teacher);
                                        });
                                        
                                        teacherDiv.appendChild(teacherSpan);
                                    });
                                    
                                    courseItem.appendChild(subjectDiv);
                                    courseItem.appendChild(teacherDiv);
                                    cell.appendChild(courseItem);
                                });
                            } else {
                                // 添加空堂樣式
                                const emptySlot = document.createElement('div');
                                emptySlot.className = 'empty-slot';
                                emptySlot.textContent = '  ';
                                cell.appendChild(emptySlot);
                            }
                            
                            // 檢查是否為B陣列中的節次
                            const isFreeSlot = freeSlots.some(slot => slot.day === day + 1 && slot.period === period + 1);
                            
                            if (isFreeSlot) {
                                // 檢查該節次是否有可調課的教師
                                const availableTeachers = [];
                                
                                // 獲取所有教師
                                const allTeachers = Object.keys(jsonData.teachers);
                                
                                // 遍歷所有教師（除了當前教師）
                                allTeachers.forEach(t => {
                                    if (t === teacherName) return;
                                    
                                    // 確保教師課表存在
                                    if (!jsonData.teachers[t] || !jsonData.teachers[t].schedule) {
                                        return;
                                    }
                                    
                                    const tSchedule = jsonData.teachers[t].schedule;
                                    
                                    // 檢查該教師是否在A節次（點擊的節次）無課務
                                    const aDayIndex = day - 1;
                                    const aPeriodIndex = period - 1;
                                    
                                    // 確保tSchedule[aPeriodIndex][aDayIndex]存在
                                    if (tSchedule[aPeriodIndex] && tSchedule[aPeriodIndex][aDayIndex] && tSchedule[aPeriodIndex][aDayIndex].length > 0) {
                                        return; // 在A節次有課務，跳過
                                    }
                                    
                                    // 檢查該教師是否在B陣列節次有課務且任教該班
                                    let hasTeachingInB = false;
                                    for (const slot of freeSlots) {
                                        const bDayIndex = slot.day - 1;
                                        const bPeriodIndex = slot.period - 1;
                                        
                                        // 確保tSchedule[bPeriodIndex][bDayIndex]存在
                                        if (tSchedule[bPeriodIndex] && tSchedule[bPeriodIndex][bDayIndex]) {
                                            const courses = tSchedule[bPeriodIndex][bDayIndex];
                                            if (courses.length > 0 && courses.some(course => course.class === classCode)) {
                                                hasTeachingInB = true;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (hasTeachingInB) {
                                        availableTeachers.push(t);
                                    }
                                });
                                
                                // 如果有可調課的教師，添加"有空堂"標記
                                if (availableTeachers.length > 0) {
                                    const availableSlot = document.createElement('div');
                                    availableSlot.className = 'available-slot';
                                    availableSlot.textContent = '有空堂';
                                    cell.appendChild(availableSlot);
                                }
                            }
                        } else {
                            // 添加空堂樣式
                            const emptySlot = document.createElement('div');
                            emptySlot.className = 'empty-slot';
                            emptySlot.textContent = '  ';
                            cell.appendChild(emptySlot);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    classSwapBody.appendChild(row);
                    
                    // 在第4節後添加午休分隔行
                    if (period === 3) {
                        const lunchRow = document.createElement('tr');
                        const lunchCell = document.createElement('td');
                        lunchCell.className = 'lunch-break';
                        lunchCell.colSpan = 6;
                        lunchCell.textContent = '午休時間';
                        lunchRow.appendChild(lunchCell);
                        classSwapBody.appendChild(lunchRow);
                    }
                }
                
                // 顯示班級調課表
                noData.style.display = 'none';
                
                showNotification('調課查詢成功', 'success');
            }` : ''}
            
            ${selectedFeatures.includes('class') || selectedFeatures.includes('teacher') ? `
            // 切換到教師課表
            function switchToTeacherSchedule(teacherName) {
                // 切換到教師標籤頁
                document.querySelector('[data-tab="teacher"]').click();
                
                // 選擇教師
                teacherSelect.value = teacherName;
                
                // 查詢教師課表
                displaySchedule(teacherName, 'teacher');
            }
            
            // 切換到班級課表
            function switchToClassSchedule(classCode) {
                // 切換到班級標籤頁
                document.querySelector('[data-tab="class"]').click();
                
                // 選擇班級
                classSelect.value = classCode;
                
                // 查詢班級課表
                displaySchedule(classCode, 'class');
            }` : ''}
            
            // 顯示通知
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = \`notification \${type}\`;
                notification.style.display = 'block';
                
                // 3秒後自動隱藏
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        });
    <\/script>
</body>
</html>`;
            }
            
            // 下載檔案
            function downloadFile(content, fileName, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            }
        });
    </script>
</body>
</html>