<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¯æ„›å¤šé ç™½æ¿ï¼ˆç‰©ä»¶å³æ™‚æ›è‰²ï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0; overflow: hidden;
      background: #ffeaf4; font-family: 'Noto Sans TC', 'Comic Sans MS', Arial, sans-serif;
    }
    #container {
      width: 100vw; height: 100vh; position: relative;
    }
    #canvas-area {
      position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #fff9fc; border-radius: 24px;
      box-shadow: 0 0 24px #ffb6d5;
      z-index: 1;
    }
    #toolbar-toggle {
      position: fixed; right: 20px; top: 20px; z-index: 30;
      background: #ffb6d5; border-radius: 50%; border: 2px solid #fff;
      box-shadow: 0 2px 8px #ffb6d5;
      width: 40px; height: 40px; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #fff; transition: background 0.2s;
    }
    #toolbar-toggle:hover { background: #ff69b4; }
    #toolbar {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 20;
      background: #fff; border-radius: 12px 12px 0 0; border: 2px solid #ffb6d5;
      box-shadow: 0 -2px 12px #ffb6d5;
      padding: 6px 12px 4px 12px; min-width: 260px; display: none;
      flex-direction: column; gap: 4px; align-items: flex-start; justify-content: flex-start;
      font-size: 12px;
      max-width: 1920px;
      margin: 0 auto;
    }
    #toolbar.show { display: flex; }
    #toolbar button, #toolbar input[type="color"], #toolbar input[type="range"], #toolbar label, #toolbar select {
      margin: 0 2px 2px 0; font-size: 11px; padding: 4px 8px;
      border-radius: 8px; border: 2px solid #ffb6d5; background: #fff0f6;
      cursor: pointer; outline: none; color: #d12a6a;
      transition: background 0.2s, color 0.2s;
    }
    #toolbar button.active, #toolbar button:hover { background: #ffb6d5; color: #fff;}
    #toolbar input[type="color"] { padding: 1px; width: 24px; height: 24px; border: none; }
    #toolbar input[type="file"] { display: none; }
    #toolbar input[type="text"] { width: 60px; font-size: 11px; }
    #toolbar input[type="range"] { width: 60px; }
    #toolbar .row { 
      display: flex; 
      align-items: center; 
      gap: 2px; 
      margin-bottom: 0; 
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    #toolbar label { 
      background: none; 
      border: none; 
      padding: 0; 
      color: #d12a6a;
      font-size: 11px;
    }
    #page-selector {
      position: fixed; left: 20px; top: 20px; z-index: 22;
      background: #fff0f6; border: 2px solid #ffb6d5; border-radius: 12px;
      padding: 4px 8px; display: flex; gap: 4px; align-items: center;
      box-shadow: 0 2px 8px #ffb6d5;
      transition: transform 0.3s, opacity 0.3s;
    }
    #page-selector.hidden {
      transform: translateX(-120%);
      opacity: 0;
    }
    #page-selector-toggle {
      position: fixed; left: 20px; top: 20px; z-index: 21;
      background: #ffb6d5; border-radius: 50%; border: 2px solid #fff;
      box-shadow: 0 2px 8px #ffb6d5;
      width: 40px; height: 40px; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #fff; transition: background 0.2s;
    }
    #page-selector-toggle:hover { background: #ff69b4; }
    #page-selector select {
      background: #fff; color: #d12a6a; border-radius: 8px; border: 2px solid #ffb6d5;
      font-size: 12px; padding: 2px 6px; cursor: pointer;
    }
    #page-selector button {
      background: #ffb6d5; color: #fff; border-radius: 8px; border: 2px solid #fff;
      font-size: 12px; padding: 2px 6px; cursor: pointer;
    }
    .note { 
      position: absolute; 
      left: 36px; 
      top: 100px; 
      color: #d12a6a; 
      font-size: 15px; 
      z-index: 12; 
      background: #fff0f6; 
      padding: 6px 12px; 
      border-radius: 14px;
      transition: opacity 0.5s;
    }
    #modal {
      position: fixed; left:0; top:0; width:100vw; height:100vh; display:none;
      align-items: center; justify-content: center; z-index: 999;
      background: rgba(255, 234, 244, 0.8);
    }
    #modal-content {
      background: #fff; border-radius: 18px; border: 2px solid #ffb6d5;
      box-shadow: 0 2px 16px #ffb6d5; padding: 32px 28px; max-width: 420px;
      font-size: 16px; color: #d12a6a; text-align: left;
      position: relative;
    }
    #modal-content button {
      position: absolute; right: 18px; top: 18px; background: #ffb6d5; color: #fff;
      border-radius: 50%; border: 2px solid #fff; width: 32px; height: 32px; font-size: 18px; cursor: pointer;
    }
    #urlModal {
      position: fixed; left:0; top:0; width:100vw; height:100vh; display:none;
      align-items: center; justify-content: center; z-index: 1000;
      background: rgba(255, 234, 244, 0.8);
    }
    #urlModal-content {
      background: #fff; border-radius: 18px; border: 2px solid #ffb6d5;
      box-shadow: 0 2px 16px #ffb6d5; padding: 24px; max-width: 400px;
      font-size: 16px; color: #d12a6a; text-align: left;
      position: relative;
    }
    #urlModal-content button {
      background: #ffb6d5; color: #fff; border-radius: 10px; border: 2px solid #fff;
      font-size: 14px; padding: 6px 12px; cursor: pointer; margin: 8px 4px;
    }
    #urlModal-content input {
      width: 100%; padding: 8px; margin: 10px 0; border-radius: 8px;
      border: 2px solid #ffb6d5; font-size: 14px; color: #d12a6a;
    }
    #urlModal-content .close-btn {
      position: absolute; right: 12px; top: 12px; background: #ffb6d5; color: #fff;
      border-radius: 50%; border: 2px solid #fff; width: 28px; height: 28px; font-size: 16px; cursor: pointer;
    }
    #urlModal-content .tab-container {
      display: flex;
      margin-bottom: 10px;
    }
    #urlModal-content .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      background: #fff0f6;
      border: 2px solid #ffb6d5;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      margin-right: 2px;
    }
    #urlModal-content .tab.active {
      background: #ffb6d5;
      color: #fff;
    }
    #urlModal-content .tab-content {
      display: none;
    }
    #urlModal-content .tab-content.active {
      display: block;
    }
    .media-container {
      position: absolute;
      border: 2px solid #ffb6d5;
      border-radius: 8px;
      overflow: hidden;
      z-index: 100;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .media-container.fullscreen {
      position: fixed;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 2000;
      border-radius: 0;
    }
    .media-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      pointer-events: none;
    }
    .media-container.active iframe {
      pointer-events: auto;
    }
    .media-container .pdf-viewer {
      width: 100%;
      height: 100%;
      overflow: auto;
      pointer-events: none;
    }
    .media-container.active .pdf-viewer {
      pointer-events: auto;
    }
    .media-container.fullscreen .pdf-viewer {
      height: calc(100% - 40px);
    }
    .media-container .pdf-canvas {
      display: block;
      margin: 0 auto;
      border: 1px solid #ccc;
    }
    .media-container .pdf-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 182, 213, 0.8);
      padding: 5px;
      display: flex;
      justify-content: center;
      gap: 10px;
      z-index: 102;
    }
    .media-container.fullscreen .pdf-controls {
      background: rgba(255, 182, 213, 0.95);
    }
    .media-container .pdf-controls button {
      background: #fff;
      color: #d12a6a;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .media-container .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #ffb6d5;
      border: 1px solid #fff;
      border-radius: 50%;
      z-index: 101;
    }
    .media-container.fullscreen .resize-handle {
      display: none;
    }
    .media-container .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
    .media-container .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
    .media-container .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
    .media-container .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
    .media-container .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      background: #ffb6d5;
      color: #fff;
      border-radius: 50%;
      border: 1px solid #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 101;
    }
    .media-container .drag-handle {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 20px;
      height: 20px;
      background: #ffb6d5;
      color: #fff;
      border-radius: 50%;
      border: 1px solid #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      z-index: 101;
    }
    .media-container .fullscreen-btn {
      position: absolute;
      top: 5px;
      right: 30px;
      width: 20px;
      height: 20px;
      background: #ffb6d5;
      color: #fff;
      border-radius: 50%;
      border: 1px solid #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 101;
    }
    .media-container.fullscreen .fullscreen-btn {
      right: 30px;
    }
    .media-container .activation-indicator {
      position: absolute;
      top: 5px;
      left: 30px;
      width: 10px;
      height: 10px;
      background: #ff69b4;
      border-radius: 50%;
      border: 1px solid #fff;
      z-index: 101;
      display: none;
    }
    .media-container.active .activation-indicator {
      display: block;
    }
    .media-container.fullscreen-exit-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background: #ffb6d5;
      color: #fff;
      border-radius: 50%;
      border: 2px solid #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2001;
    }
    .pdf-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #d12a6a;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="canvas-area">
    <canvas id="whiteboard"></canvas>
  </div>
  <div id="page-selector-toggle" title="é¡¯ç¤º/éš±è—é é¢é¸æ“‡å™¨">ğŸ“‹</div>
  <div id="page-selector">
    <select id="pageSelect"></select>
    <button id="addPageBtn">â•</button>
    <button id="deletePageBtn">âœ•</button>
  </div>
  <div id="toolbar-toggle" title="é¡¯ç¤º/éš±è—å·¥å…·">ğŸ¬</div>
  <div id="toolbar">
    <div class="row">
      <button id="selectBtn">ğŸ”² é¸å–</button>
      <button id="penBtn">ğŸ– ç­†åˆ·</button>
      <button id="rectBtn">â–­ çŸ©å½¢</button>
      <button id="circleBtn">âšª åœ“å½¢</button>
      <button id="lineBtn">ï¼ ç·šæ®µ</button>
      <button id="textBtn">ğŸ“ æ–‡å­—</button>
      <button id="eraserBtn">ğŸ§¹ æ©¡çš®æ“¦</button>
      <input type="file" id="imgInput" accept="image/*">
      <button id="imgBtn">ğŸŒˆ æ’å…¥åœ–ç‰‡</button>
      <button id="youtubeBtn">ğŸ“º æ’å…¥YouTube</button>
      <button id="websiteBtn">ğŸŒ ç¶²ç«™åµŒå…¥</button>
      <input type="file" id="pdfInput" accept=".pdf">
      <button id="pdfBtn">ğŸ“„ æ’å…¥PDF</button>
      <button id="clearBtn">ğŸ§º å…¨éƒ¨æ¸…é™¤</button>
      <button id="saveBtn">ğŸ’¾ å„²å­˜åœ–ç‰‡</button>
      <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
      <button id="importBtn">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
      <input type="file" id="importInput" accept=".json">
      
    </div>
    <div class="row">
      <button id="helpBtn">â” èªªæ˜</button>
      <label>é¡è‰²</label>
      <input type="color" id="colorPicker" value="#d12a6a" title="ç•«ç­†é¡è‰²">
      <label for="lineWidth">ç²—ç´°</label>
      <input type="range" id="lineWidth" min="1" max="18" value="4">
      <label>æ–‡å­—å±¬æ€§</label>
      <select id="textSize">
        <option value="20">20px</option>
        <option value="28">28px</option>
        <option value="36">36px</option>
        <option value="48">48px</option>
      </select>
      <input type="color" id="textColor" value="#d12a6a" title="æ–‡å­—é¡è‰²">
      <input type="text" id="textInput" placeholder="è¼¸å…¥æ–‡å­—">
      <label>ç‰©ä»¶è®Šæ›´é¡è‰²:</label>
      <input type="color" id="objColorPicker" value="#d12a6a" title="é¸å–ç‰©ä»¶å¾Œå¯ç›´æ¥è®Šè‰²">
       <label>å½¢ç‹€æ¨£å¼:</label>
      <select id="shapeStyle">
        <option value="filled">å¯¦å¿ƒ</option>
        <option value="outline">ç©ºå¿ƒ</option>
      </select>
      <button id="bringForwardBtn">â¬†ï¸ ä¸Šç§»</button>
      <button id="sendBackwardsBtn">â¬‡ï¸ ä¸‹ç§»</button>
      <button id="bringToFrontBtn">ğŸ” ç½®é ‚</button>
      <button id="sendToBackBtn">ğŸ”» ç½®åº•</button>
      <label>ç¶²é è¨­è¨ˆ: koming 2025</label>
    </div>
   
  </div>
  <div class="note" id="note">ğŸ­ é»æ“Šå³ä¸Šè§’å±•é–‹å·¥å…·åˆ—ï¼Œæ¯å€‹ç‰©ä»¶éƒ½å¯ç§»å‹•ã€åˆªé™¤ã€è¤‡è£½ã€ç¸®æ”¾ã€æ—‹è½‰ã€‚æ”¯æ´å¤šé ç®¡ç†ã€ç‰©ä»¶æ›è‰²ã€å¯æ„›ç³–æœé¢¨ï¼</div>
  <div id="modal">
    <div id="modal-content">
      <button onclick="document.getElementById('modal').style.display='none'">âœ•</button>
      <b>ä½¿ç”¨èªªæ˜</b><br><br>
      1. ä¸‹æ–¹å·¥å…·åˆ—å¯é¸æ“‡ç¹ªåœ–ã€å½¢ç‹€ã€æ–‡å­—ã€åœ–ç‰‡ã€æ©¡çš®æ“¦ç­‰åŠŸèƒ½<br>
      2. ç•«é¢å·¦ä¸Šæ–¹å¯æ–°å¢/åˆ‡æ›/åˆªé™¤ç™½æ¿é é¢<br>
      3. ç‰©ä»¶çš†å¯ç§»å‹•ã€ç¸®æ”¾ã€æ—‹è½‰ã€è¤‡è£½ï¼ˆCtrl+C/Vï¼‰ã€åˆªé™¤ï¼ˆDeleteéµ/æ©¡çš®æ“¦ï¼‰<br>
      4. é¸å–ç‰©ä»¶å¾Œå¯ç”¨å³å´è‰²å½©é¸æ“‡å™¨ç›´æ¥è®Šæ›´é¡è‰²<br>
      5. ç•«å¸ƒå¯å„²å­˜æˆåœ–ç‰‡<br>
      6. æ”¯æ´ç™½æ¿è³‡æ–™åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½ï¼Œå¯å‚™ä»½å’Œé‚„åŸæ‰€æœ‰é é¢å…§å®¹<br>
      7. å·¥å…·åˆ—å¯æ„›ç³–æœé¢¨ï¼Œé»æ“Šå³ä¸Šè§’å±•é–‹/æ”¶åˆ
    </div>
  </div>
  <div id="urlModal">
    <div id="urlModal-content">
      <button class="close-btn" onclick="document.getElementById('urlModal').style.display='none'">âœ•</button>
      <h3 id="urlModalTitle">è¼¸å…¥URL</h3>
      <div class="tab-container">
        <div class="tab active" data-tab="url">URL</div>
        <div class="tab" data-tab="upload">ä¸Šå‚³</div>
      </div>
      <div class="tab-content active" id="url-tab">
        <input type="text" id="urlInput" placeholder="è«‹è¼¸å…¥URL">
      </div>
      <div class="tab-content" id="upload-tab">
        <input type="file" id="fileInput" accept="image/*,.pdf">
      </div>
      <div>
        <button id="urlModalCancel">å–æ¶ˆ</button>
        <button id="urlModalConfirm">ç¢ºèª</button>
      </div>
    </div>
  </div>
</div>
<script>
  // è¨­ç½®PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  
  // 3ç§’å¾Œéš±è—æç¤ºæ–‡å­—
  setTimeout(() => {
    document.getElementById('note').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('note').style.display = 'none';
    }, 500);
  }, 3000);
  
  // å·¥å…·åˆ—å±•é–‹/æ”¶åˆ
  const toolbar = document.getElementById('toolbar');
  document.getElementById('toolbar-toggle').onclick = () => {
    toolbar.classList.toggle('show');
  };
  
  // é é¢é¸æ“‡å™¨å±•é–‹/æ”¶åˆ
  const pageSelector = document.getElementById('page-selector');
  document.getElementById('page-selector-toggle').onclick = () => {
    pageSelector.classList.toggle('hidden');
  };
  
  // ç•«å¸ƒå…¨è¢å¹•åˆå§‹åŒ–
  function resizeCanvas() {
    const canvasElem = document.getElementById('whiteboard');
    canvasElem.width = window.innerWidth;
    canvasElem.height = window.innerHeight;
    if (window.fabricCanvas) {
      window.fabricCanvas.setWidth(window.innerWidth);
      window.fabricCanvas.setHeight(window.innerHeight);
    }
  }
  window.addEventListener('resize', resizeCanvas);
  
  // å¤šé ç®¡ç†
  let pages = [];
  let currentPage = 0;
  let mediaContainers = [];
  
  // å¾localStorageåŠ è¼‰ä¿å­˜çš„æ•¸æ“š
  function loadFromLocalStorage() {
    try {
      const savedData = localStorage.getItem('whiteboardData');
      if (savedData) {
        const data = JSON.parse(savedData);
        pages = data.pages || [JSON.stringify({objects:[], background:'#fff9fc'})];
        
        // è™•ç†mediaContainersçš„åŠ è¼‰ï¼Œå…¼å®¹èˆŠç‰ˆæœ¬
        if (Array.isArray(data.mediaContainers)) {
          // æ–°ç‰ˆæœ¬ï¼šæ•¸çµ„çµæ§‹
          mediaContainers = data.mediaContainers;
        } else if (data.mediaContainers && typeof data.mediaContainers === 'object') {
          // èˆŠç‰ˆæœ¬ï¼šå°è±¡çµæ§‹ï¼Œè½‰æ›ç‚ºæ•¸çµ„
          mediaContainers = [];
          for (let i = 0; i < pages.length; i++) {
            if (data.mediaContainers[i] !== undefined) {
              mediaContainers.push(data.mediaContainers[i]);
            } else {
              mediaContainers.push([]);
            }
          }
        } else {
          // æ²’æœ‰mediaContainersæ•¸æ“šï¼Œåˆå§‹åŒ–ç‚ºç©ºæ•¸çµ„
          mediaContainers = pages.map(() => []);
        }
        
        currentPage = data.currentPage || 0;
        console.log("å¾localStorageåŠ è¼‰æ•¸æ“šæˆåŠŸ:", data);
        return true;
      }
    } catch (e) {
      console.error('åŠ è¼‰æœ¬åœ°å­˜å„²æ•¸æ“šå¤±æ•—:', e);
    }
    
    // å¦‚æœæ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œä½¿ç”¨é»˜èªå€¼
    pages = [JSON.stringify({objects:[], background:'#fff9fc'})];
    mediaContainers = [[]];
    currentPage = 0;
    console.log("ä½¿ç”¨é»˜èªæ•¸æ“š");
    return false;
  }
  
  // ä¿å­˜æ•¸æ“šåˆ°localStorage
  function saveToLocalStorage() {
    try {
      const data = {
        pages: pages,
        mediaContainers: mediaContainers,
        currentPage: currentPage
      };
      localStorage.setItem('whiteboardData', JSON.stringify(data));
      console.log("ä¿å­˜åˆ°localStorageæˆåŠŸ:", data);
    } catch (e) {
      console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å„²å¤±æ•—:', e);
    }
  }
  
  // åŒ¯å‡ºç™½æ¿è³‡æ–™
  function exportWhiteboardData() {
    try {
      // ç¢ºä¿ç•¶å‰é é¢å·²ä¿å­˜
      saveCurrentPage();
      saveCurrentPageMediaInfo();
      
      // ç²å–å®Œæ•´çš„ç™½æ¿æ•¸æ“š
      const data = {
        pages: pages,
        mediaContainers: mediaContainers,
        currentPage: currentPage,
        exportDate: new Date().toISOString(),
        version: "1.0"
      };
      
      // å‰µå»ºJSONå­—ç¬¦ä¸²
      const dataStr = JSON.stringify(data, null, 2);
      
      // å‰µå»ºBlobå°è±¡
      const blob = new Blob([dataStr], { type: 'application/json' });
      
      // å‰µå»ºä¸‹è¼‰éˆæ¥
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // ç”Ÿæˆæª”æ¡ˆåï¼ˆåŒ…å«æ—¥æœŸæ™‚é–“ï¼‰
      const now = new Date();
      const dateStr = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '_' +
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0');
      
      a.download = `whiteboard_backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      
      // æ¸…ç†
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      console.log("ç™½æ¿è³‡æ–™åŒ¯å‡ºæˆåŠŸ");
      alert('ç™½æ¿è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼');
    } catch (e) {
      console.error('åŒ¯å‡ºå¤±æ•—:', e);
      alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
    }
  }
  
  // åŒ¯å…¥ç™½æ¿è³‡æ–™
  function importWhiteboardData(file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        // è§£æJSONæ•¸æ“š
        const data = JSON.parse(event.target.result);
        
        // é©—è­‰æ•¸æ“šæ ¼å¼
        if (!data.pages || !Array.isArray(data.pages)) {
          throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
        }
        
        // ç¢ºèªæ˜¯å¦è¦æ›¿æ›ç¾æœ‰è³‡æ–™
        if (confirm('ç¢ºå®šè¦åŒ¯å…¥æ–°è³‡æ–™ä¸¦æ›¿æ›ç¾æœ‰ç™½æ¿å…§å®¹ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          // æ›´æ–°å…¨å±€è®Šé‡
          pages = data.pages;
          mediaContainers = data.mediaContainers || pages.map(() => []);
          currentPage = data.currentPage || 0;
          
          // ä¿å­˜åˆ°localStorage
          saveToLocalStorage();
          
          // é‡æ–°åŠ è¼‰é é¢ä»¥æ‡‰ç”¨æ–°æ•¸æ“š
          location.reload();
        }
      } catch (e) {
        console.error('åŒ¯å…¥å¤±æ•—:', e);
        alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º');
      }
    };
    reader.readAsText(file);
  }
  
  function updatePageSelector() {
    const select = document.getElementById('pageSelect');
    select.innerHTML = '';
    for(let i=0;i<pages.length;i++) {
      const option = document.createElement('option');
      option.textContent = 'é é¢ '+(i+1);
      option.value = i;
      if(i===currentPage) option.selected = true;
      select.appendChild(option);
    }
  }
  
  // åªä¿å­˜åª’é«”å®¹å™¨ä¿¡æ¯ï¼Œä¸è§¸ç™¼å®Œæ•´çš„ä¿å­˜éç¨‹
  function saveCurrentPageMediaInfo() {
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    const currentPageMedia = [];
    document.querySelectorAll('.media-container').forEach(container => {
      if (container.style.display !== 'none') { // åªä¿å­˜å¯è¦‹çš„å®¹å™¨
        const mediaInfo = {
          id: container.mediaId,
          type: container.mediaType,
          url: container.mediaUrl || '',
          position: {
            left: container.style.left,
            top: container.style.top
          },
          size: {
            width: container.style.width,
            height: container.style.height
          },
          filename: container.filename || '',
          // ä¿å­˜PDFçš„ç•¶å‰é é¢å’Œç¸®æ”¾ç‹€æ…‹
          pdfPageNum: container.pdfPageNum || 1,
          pdfScale: container.pdfScale || 1.0
        };
        
        // å°æ–¼PDFï¼Œæˆ‘å€‘åªå­˜å„²å¼•ç”¨IDï¼Œä¸å­˜å„²å¯¦éš›æ•¸æ“š
        if (container.mediaType === 'pdf') {
          mediaInfo.pdfId = container.mediaId; // ä½¿ç”¨mediaIdä½œç‚ºéµ
          // PDFæ•¸æ“šä¸ä¿å­˜åˆ°IndexedDBï¼Œåˆ‡æ›é é¢æ™‚æœƒæ¸…é™¤
        }
        
        currentPageMedia.push(mediaInfo);
        console.log("ä¿å­˜åª’é«”å®¹å™¨ä¿¡æ¯:", mediaInfo);
      }
    });
    
    // ç¢ºä¿mediaContainersæ•¸çµ„é•·åº¦è¶³å¤ 
    while (mediaContainers.length <= currentPage) {
      mediaContainers.push([]);
    }
    
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    mediaContainers[currentPage] = currentPageMedia;
    
    // ä¿å­˜åˆ°localStorage
    saveToLocalStorage();
  }
  
  // åªä¿å­˜ç•«å¸ƒæ•¸æ“šï¼Œä¸åŒ…æ‹¬åª’é«”å®¹å™¨
  function saveCurrentPage() {
    // ä¿å­˜ç•«å¸ƒç‹€æ…‹ï¼Œä¸åŒ…æ‹¬åª’é«”å®¹å™¨
    pages[currentPage] = JSON.stringify(canvas.toJSON());
    
    // ä¿å­˜åˆ°localStorage
    saveToLocalStorage();
  }
  
  function switchPage(idx) {
    console.log("åˆ‡æ›é é¢å¾", currentPage, "åˆ°", idx);
    
    // å…ˆä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
    
    // ç§»é™¤æ‰€æœ‰åª’é«”å®¹å™¨å’Œå°æ‡‰çš„ä½”ä½ç¬¦
    document.querySelectorAll('.media-container').forEach(container => {
      console.log("ç§»é™¤åª’é«”å®¹å™¨:", container.mediaId);
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // ä¿å­˜ç•¶å‰é é¢ï¼ˆæ­¤æ™‚ç•«å¸ƒä¸Šå·²æ²’æœ‰ä½”ä½ç¬¦ï¼‰
    saveCurrentPage();
    
    currentPage = idx;
    canvas.loadFromJSON(JSON.parse(pages[idx]), () => {
      canvas.renderAll();
      console.log("ç•«å¸ƒåŠ è¼‰å®Œæˆï¼Œé é¢:", idx);
    });
    
    // é‡æ–°å‰µå»ºç•¶å‰é é¢çš„åª’é«”å®¹å™¨
    console.log("é–‹å§‹åŠ è¼‰é é¢åª’é«”ï¼Œé é¢:", idx, "åª’é«”å®¹å™¨ä¿¡æ¯:", mediaContainers[idx]);
    loadPageMedia(idx);
    updatePageSelector();
  }
  
  function loadPageMedia(pageIndex) {
    console.log("åŠ è¼‰é é¢åª’é«”:", pageIndex);
    
    // ç¢ºä¿mediaContainersæ•¸çµ„é•·åº¦è¶³å¤ 
    while (mediaContainers.length <= pageIndex) {
      mediaContainers.push([]);
    }
    
    // å¦‚æœç•¶å‰é é¢æœ‰åª’é«”å®¹å™¨ä¿¡æ¯ï¼Œå‰‡é‡æ–°å‰µå»ºå®ƒå€‘
    if (mediaContainers[pageIndex] && mediaContainers[pageIndex].length > 0) {
      console.log("æ‰¾åˆ°åª’é«”å®¹å™¨ä¿¡æ¯:", mediaContainers[pageIndex]);
      
      mediaContainers[pageIndex].forEach((mediaInfo, index) => {
        console.log("å‰µå»ºåª’é«”å®¹å™¨:", index, mediaInfo);
        
        if (mediaInfo.type === 'youtube') {
          createYouTubeContainer(mediaInfo.url, mediaInfo.position, mediaInfo.size, mediaInfo.id);
        } else if (mediaInfo.type === 'website') {
          createWebsiteContainer(mediaInfo.url, mediaInfo.position, mediaInfo.size, mediaInfo.id);
        } else if (mediaInfo.type === 'pdf') {
          // PDFä¸ä¿å­˜æ•¸æ“šï¼Œåªå‰µå»ºä¸€å€‹æç¤ºå®¹å™¨
          createPDFPlaceholderContainer(
            mediaInfo.filename, 
            mediaInfo.position, 
            mediaInfo.size, 
            mediaInfo.id
          );
        }
      });
    } else {
      console.log("é é¢", pageIndex, "æ²’æœ‰åª’é«”å®¹å™¨ä¿¡æ¯");
    }
  }
  
  function addPage() {
    saveCurrentPage();
    saveCurrentPageMediaInfo();
    pages.push(JSON.stringify({objects:[], background:'#fff9fc'}));
    mediaContainers.push([]); // æ–°é é¢å°æ‡‰ä¸€å€‹ç©ºæ•¸çµ„
    currentPage = pages.length-1;
    canvas.clear();
    canvas.backgroundColor = '#fff9fc';
    
    // ç§»é™¤æ‰€æœ‰åª’é«”å®¹å™¨
    document.querySelectorAll('.media-container').forEach(container => {
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    updatePageSelector();
    saveToLocalStorage();
  }
  
  function deletePage() {
    if(pages.length<=1) {
      alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€é ');
      return;
    }
    if(confirm('ç¢ºå®šåˆªé™¤æœ¬é ï¼Ÿ')) {
      // ç§»é™¤æ‰€æœ‰åª’é«”å®¹å™¨å’Œå°æ‡‰çš„ä½”ä½ç¬¦
      document.querySelectorAll('.media-container').forEach(container => {
        removeMediaContainerAndPlaceholder(container.mediaId);
      });
      
      pages.splice(currentPage,1);
      mediaContainers.splice(currentPage,1); // æ­£ç¢ºä½¿ç”¨spliceåˆªé™¤æ•¸çµ„å…ƒç´ 
      if(currentPage>=pages.length) currentPage=pages.length-1;
      canvas.loadFromJSON(JSON.parse(pages[currentPage]), () => {
        canvas.renderAll();
      });
      
      // é‡æ–°å‰µå»ºç•¶å‰é é¢çš„åª’é«”å®¹å™¨
      loadPageMedia(currentPage);
      updatePageSelector();
      saveToLocalStorage();
    }
  }
  
  document.getElementById('pageSelect').onchange = (e) => {
    switchPage(Number(e.target.value));
  };
  document.getElementById('addPageBtn').onclick = addPage;
  document.getElementById('deletePageBtn').onclick = deletePage;
  
  // åˆå§‹åŒ– Fabric.js ç•«å¸ƒ
  const canvas = new fabric.Canvas('whiteboard', {
    backgroundColor: '#fff9fc',
    selection: true,
    preserveObjectStacking: true
  });
  window.fabricCanvas = canvas;
  resizeCanvas();
  
  // å¾localStorageåŠ è¼‰æ•¸æ“š
  const hasSavedData = loadFromLocalStorage();
  
  // å¦‚æœæœ‰ä¿å­˜çš„æ•¸æ“šï¼Œå‰‡åŠ è¼‰ç•¶å‰é é¢
  if (hasSavedData) {
    console.log("æœ‰ä¿å­˜çš„æ•¸æ“šï¼ŒåŠ è¼‰ç•¶å‰é é¢:", currentPage);
    canvas.loadFromJSON(JSON.parse(pages[currentPage]), () => {
      canvas.renderAll();
      console.log("ç•«å¸ƒåŠ è¼‰å®Œæˆï¼Œç¾åœ¨åŠ è¼‰åª’é«”å®¹å™¨");
      // ç¢ºä¿åœ¨ç•«å¸ƒåŠ è¼‰å®Œæˆå¾Œå†åŠ è¼‰åª’é«”å®¹å™¨
      setTimeout(() => {
        loadPageMedia(currentPage);
      }, 100);
    });
  } else {
    // æ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œä½¿ç”¨é»˜èªå€¼
    console.log("æ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œä½¿ç”¨é»˜èªå€¼");
    pages = [JSON.stringify({objects:[], background:'#fff9fc'})];
    mediaContainers = [[]];
    currentPage = 0;
  }
  
  updatePageSelector();
  
  // å·¥å…·ç‹€æ…‹
  let currentTool = 'select';
  let drawingMode = false;
  function setTool(t) {
    currentTool = t;
    document.querySelectorAll('#toolbar button').forEach(b => b.classList.remove('active'));
    document.getElementById('selectBtn').classList.toggle('active', t==='select');
    document.getElementById('penBtn').classList.toggle('active', t==='pen');
    document.getElementById('rectBtn').classList.toggle('active', t==='rect');
    document.getElementById('circleBtn').classList.toggle('active', t==='circle');
    document.getElementById('lineBtn').classList.toggle('active', t==='line');
    document.getElementById('textBtn').classList.toggle('active', t==='text');
    document.getElementById('eraserBtn').classList.toggle('active', t==='eraser');
    document.getElementById('imgBtn').classList.toggle('active', t==='img');
    document.getElementById('youtubeBtn').classList.toggle('active', t==='youtube');
    document.getElementById('websiteBtn').classList.toggle('active', t==='website');
    document.getElementById('pdfBtn').classList.toggle('active', t==='pdf');
    document.getElementById('exportBtn').classList.toggle('active', t==='export');
    document.getElementById('importBtn').classList.toggle('active', t==='import');
    updateToolMode();
  }
  document.getElementById('selectBtn').onclick = () => setTool('select');
  document.getElementById('penBtn').onclick = () => setTool('pen');
  document.getElementById('rectBtn').onclick = () => setTool('rect');
  document.getElementById('circleBtn').onclick = () => setTool('circle');
  document.getElementById('lineBtn').onclick = () => setTool('line');
  document.getElementById('textBtn').onclick = () => setTool('text');
  document.getElementById('eraserBtn').onclick = () => setTool('eraser');
  document.getElementById('imgBtn').onclick = () => setTool('img');
  document.getElementById('youtubeBtn').onclick = () => setTool('youtube');
  document.getElementById('websiteBtn').onclick = () => setTool('website');
  document.getElementById('pdfBtn').onclick = () => setTool('pdf');
  document.getElementById('exportBtn').onclick = () => exportWhiteboardData();
  document.getElementById('importBtn').onclick = () => document.getElementById('importInput').click();
  document.getElementById('importInput').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
      importWhiteboardData(file);
    }
  };
  document.getElementById('helpBtn').onclick = () => {
    document.getElementById('modal').style.display = 'flex';
  };
  
  // éšå±¤èª¿æ•´æŒ‰éˆ•äº‹ä»¶
  document.getElementById('bringForwardBtn').onclick = () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
      canvas.bringForward(activeObject);
      canvas.requestRenderAll();
      saveCurrentPage();
    }
  };
  
  document.getElementById('sendBackwardsBtn').onclick = () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
      canvas.sendBackwards(activeObject);
      canvas.requestRenderAll();
      saveCurrentPage();
    }
  };
  
  document.getElementById('bringToFrontBtn').onclick = () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
      canvas.bringToFront(activeObject);
      canvas.requestRenderAll();
      saveCurrentPage();
    }
  };
  
  document.getElementById('sendToBackBtn').onclick = () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
      canvas.sendToBack(activeObject);
      canvas.requestRenderAll();
      saveCurrentPage();
    }
  };
  
  // è‡ªå®šç¾©æ–‡ä»¶é¸æ“‡æŒ‰éˆ•
  document.getElementById('imgBtn').onclick = () => {
    document.getElementById('imgInput').click();
  };
  
  // æ’å…¥åœ–ç‰‡è™•ç†
  document.getElementById('imgInput').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        fabric.Image.fromURL(event.target.result, function(img) {
          img.set({
            left: 100,
            top: 100,
            scaleX: 0.4,
            scaleY: 0.4,
            borderColor: "#ffb6d5",
            cornerStyle: 'circle',
            cornerColor: '#ffb6d5'
          });
          canvas.add(img);
          canvas.setActiveObject(img);
          canvas.requestRenderAll();
          saveCurrentPage();
        });
      };
      reader.readAsDataURL(file);
    }
  };
  
  // PDFæ–‡ä»¶é¸æ“‡æŒ‰éˆ•
  document.getElementById('pdfBtn').onclick = () => {
    document.getElementById('pdfInput').click();
  };
  
  // æ’å…¥PDFè™•ç†
  document.getElementById('pdfInput').onchange = function(e) {
    const file = e.target.files[0];
    if (file && file.type === 'application/pdf') {
      const reader = new FileReader();
      reader.onload = function(event) {
        // ç¢ºä¿ArrayBufferä¸æœƒè¢«åˆ†é›¢ï¼Œå‰µå»ºä¸€å€‹æ–°çš„å‰¯æœ¬
        const originalArrayBuffer = event.target.result;
        const arrayBufferCopy = originalArrayBuffer.slice(0);
        const typedarray = new Uint8Array(arrayBufferCopy);
        insertPDF(typedarray, file.name);
      };
      reader.readAsArrayBuffer(file);
    }
  };
  
  // YouTubeå’Œç¶²ç«™åµŒå…¥æ¨¡æ…‹æ¡†è™•ç†
  const urlModal = document.getElementById('urlModal');
  const urlModalTitle = document.getElementById('urlModalTitle');
  const urlInput = document.getElementById('urlInput');
  const fileInput = document.getElementById('fileInput');
  let urlModalCallback = null;
  
  // æ¨™ç±¤åˆ‡æ›è™•ç†
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeé¡
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      // æ·»åŠ activeé¡åˆ°ç•¶å‰æ¨™ç±¤
      this.classList.add('active');
      
      // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // é¡¯ç¤ºå°æ‡‰çš„æ¨™ç±¤å…§å®¹
      const tabId = this.getAttribute('data-tab');
      document.getElementById(`${tabId}-tab`).classList.add('active');
    });
  });
  
  document.getElementById('youtubeBtn').onclick = () => {
    urlModalTitle.textContent = 'æ’å…¥YouTubeè¦–é »';
    urlInput.placeholder = 'è«‹è¼¸å…¥YouTubeè¦–é »URL';
    urlInput.value = '';
    fileInput.value = '';
    urlModal.style.display = 'flex';
    urlModalCallback = insertYouTube;
    
    // é¡¯ç¤ºURLæ¨™ç±¤ï¼Œéš±è—ä¸Šå‚³æ¨™ç±¤
    document.querySelector('[data-tab="url"]').click();
  };
  
  document.getElementById('websiteBtn').onclick = () => {
    urlModalTitle.textContent = 'åµŒå…¥ç¶²ç«™';
    urlInput.placeholder = 'è«‹è¼¸å…¥ç¶²ç«™URL';
    urlInput.value = '';
    fileInput.value = '';
    urlModal.style.display = 'flex';
    urlModalCallback = insertWebsite;
    
    // é¡¯ç¤ºURLæ¨™ç±¤ï¼Œéš±è—ä¸Šå‚³æ¨™ç±¤
    document.querySelector('[data-tab="url"]').click();
  };
  
  document.getElementById('urlModalCancel').onclick = () => {
    urlModal.style.display = 'none';
    urlModalCallback = null;
  };
  
  document.getElementById('urlModalConfirm').onclick = () => {
    if (urlModalCallback) {
      const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
      if (activeTab === 'url') {
        urlModalCallback(urlInput.value);
      } else if (activeTab === 'upload') {
        const file = fileInput.files[0];
        if (file) {
          if (file.type.startsWith('image/')) {
            // è™•ç†åœ–ç‰‡ä¸Šå‚³
            const reader = new FileReader();
            reader.onload = function(event) {
              fabric.Image.fromURL(event.target.result, function(img) {
                img.set({
                  left: 100,
                  top: 100,
                  scaleX: 0.4,
                  scaleY: 0.4,
                  borderColor: "#ffb6d5",
                  cornerStyle: 'circle',
                  cornerColor: '#ffb6d5'
                });
                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.requestRenderAll();
                saveCurrentPage();
              });
            };
            reader.readAsDataURL(file);
          } else if (file.type === 'application/pdf') {
            // è™•ç†PDFä¸Šå‚³
            const reader = new FileReader();
            reader.onload = function(event) {
              // ç¢ºä¿ArrayBufferä¸æœƒè¢«åˆ†é›¢ï¼Œå‰µå»ºä¸€å€‹æ–°çš„å‰¯æœ¬
              const originalArrayBuffer = event.target.result;
              const arrayBufferCopy = originalArrayBuffer.slice(0);
              const typedarray = new Uint8Array(arrayBufferCopy);
              insertPDF(typedarray, file.name);
            };
            reader.readAsArrayBuffer(file);
          }
        }
      }
    }
    urlModal.style.display = 'none';
    urlModalCallback = null;
  };
  
  // æ’å…¥YouTubeè¦–é »
  function insertYouTube(url) {
    // æå–YouTubeè¦–é »ID
    const videoId = extractYouTubeId(url);
    if (!videoId) {
      alert('ç„¡æ•ˆçš„YouTube URL');
      return;
    }
    
    console.log("æ’å…¥YouTubeè¦–é »:", url, "è¦–é »ID:", videoId);
    createYouTubeContainer(url, {left: '100px', top: '100px'}, {width: '400px', height: '225px'});
  }
  
  // å‰µå»ºYouTubeå®¹å™¨
  function createYouTubeContainer(url, position, size, mediaId) {
    // æå–YouTubeè¦–é »ID
    const videoId = extractYouTubeId(url);
    if (!videoId) {
      alert('ç„¡æ•ˆçš„YouTube URL');
      return;
    }
    
    console.log("å‰µå»ºYouTubeå®¹å™¨:", url, position, size, mediaId);
    
    // å‰µå»ºåª’é«”å®¹å™¨
    const container = document.createElement('div');
    container.className = 'media-container';
    container.style.left = position.left;
    container.style.top = position.top;
    container.style.width = size.width;
    container.style.height = size.height;
    
    // è¨­ç½®åª’é«”å±¬æ€§
    container.mediaId = mediaId || `youtube-${Date.now()}`;
    container.mediaType = 'youtube';
    container.mediaUrl = url;
    
    console.log("YouTubeå®¹å™¨å±¬æ€§:", {
      id: container.mediaId,
      type: container.mediaType,
      url: container.mediaUrl
    });
    
    // å‰µå»ºiframe
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
    iframe.frameBorder = '0';
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.allowFullscreen = true;
    
    console.log("å‰µå»ºYouTube iframe:", iframe.src);
    
    // æ·»åŠ é—œé–‰æŒ‰éˆ•
    const closeBtn = document.createElement('div');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = 'âœ•';
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      console.log("é—œé–‰YouTubeå®¹å™¨:", container.mediaId);
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // æ·»åŠ æ‹–å‹•æ‰‹æŸ„
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â‹®â‹®';
    
    // æ·»åŠ æ¿€æ´»æŒ‡ç¤ºå™¨
    const indicator = document.createElement('div');
    indicator.className = 'activation-indicator';
    
    // æ·»åŠ èª¿æ•´å¤§å°æ‰‹æŸ„
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(position => {
      const handle = document.createElement('div');
      handle.className = `resize-handle ${position}`;
      container.appendChild(handle);
      
      // æ·»åŠ æ‹–å‹•èª¿æ•´å¤§å°åŠŸèƒ½
      makeResizable(container, handle, position);
    });
    
    // æ·»åŠ æ‹–å‹•ç§»å‹•åŠŸèƒ½
    makeDraggable(container, dragHandle);
    
    // æ·»åŠ é»æ“Šæ¿€æ´»/åœç”¨äº‹ä»¶
    container.addEventListener('click', function(e) {
      // å¦‚æœé»æ“Šçš„æ˜¯æ§åˆ¶å…ƒç´ ï¼Œä¸åˆ‡æ›æ¿€æ´»ç‹€æ…‹
      if (e.target === closeBtn || e.target === dragHandle || 
          e.target.classList.contains('resize-handle') ||
          e.target.classList.contains('fullscreen-btn')) {
        return;
      }
      container.classList.toggle('active');
    });
    
    container.appendChild(iframe);
    container.appendChild(closeBtn);
    container.appendChild(dragHandle);
    container.appendChild(indicator);
    document.getElementById('container').appendChild(container);
    
    console.log("YouTubeå®¹å™¨å·²æ·»åŠ åˆ°DOM");
    
    // åœ¨ç•«å¸ƒä¸Šæ·»åŠ ä¸€å€‹ä½”ä½ç¬¦çŸ©å½¢
    const rect = new fabric.Rect({
      left: parseInt(position.left),
      top: parseInt(position.top),
      width: parseInt(size.width),
      height: parseInt(size.height),
      fill: 'transparent',
      stroke: 'transparent',
      selectable: false,
      evented: false,
      mediaId: container.mediaId,
      isMediaPlaceholder: true
    });
    
    canvas.add(rect);
    canvas.requestRenderAll();
    
    // åŒæ­¥ä½”ä½ç¬¦å’Œå®¹å™¨ä½ç½®
    syncMediaWithPlaceholder(rect, container);
    
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
    
    console.log("YouTubeå®¹å™¨å‰µå»ºå®Œæˆ");
  }
  
  // æ’å…¥ç¶²ç«™
  function insertWebsite(url) {
    if (!url) {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„URL');
      return;
    }
    
    // ç¢ºä¿URLåŒ…å«å”è­°
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      url = 'https://' + url;
    }
    
    console.log("æ’å…¥ç¶²ç«™:", url);
    createWebsiteContainer(url, {left: '100px', top: '100px'}, {width: '600px', height: '400px'});
  }
  
  // å‰µå»ºç¶²ç«™å®¹å™¨
  function createWebsiteContainer(url, position, size, mediaId) {
    if (!url) {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„URL');
      return;
    }
    
    // ç¢ºä¿URLåŒ…å«å”è­°
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      url = 'https://' + url;
    }
    
    console.log("å‰µå»ºç¶²ç«™å®¹å™¨:", url, position, size, mediaId);
    
    // å‰µå»ºåª’é«”å®¹å™¨
    const container = document.createElement('div');
    container.className = 'media-container';
    container.style.left = position.left;
    container.style.top = position.top;
    container.style.width = size.width;
    container.style.height = size.height;
    
    // è¨­ç½®åª’é«”å±¬æ€§
    container.mediaId = mediaId || `website-${Date.now()}`;
    container.mediaType = 'website';
    container.mediaUrl = url;
    
    console.log("ç¶²ç«™å®¹å™¨å±¬æ€§:", {
      id: container.mediaId,
      type: container.mediaType,
      url: container.mediaUrl
    });
    
    // å‰µå»ºiframe
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.frameBorder = '0';
    iframe.style.overflow = 'auto';
    
    console.log("å‰µå»ºç¶²ç«™iframe:", iframe.src);
    
    // æ·»åŠ é—œé–‰æŒ‰éˆ•
    const closeBtn = document.createElement('div');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = 'âœ•';
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      console.log("é—œé–‰ç¶²ç«™å®¹å™¨:", container.mediaId);
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // æ·»åŠ æ‹–å‹•æ‰‹æŸ„
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â‹®â‹®';
    
    // æ·»åŠ æ¿€æ´»æŒ‡ç¤ºå™¨
    const indicator = document.createElement('div');
    indicator.className = 'activation-indicator';
    
    // æ·»åŠ å…¨è¢å¹•æŒ‰éˆ•
    const fullscreenBtn = document.createElement('div');
    fullscreenBtn.className = 'fullscreen-btn';
    fullscreenBtn.innerHTML = 'â›¶';
    fullscreenBtn.title = 'å…¨è¢å¹•';
    fullscreenBtn.onclick = function() {
      toggleFullscreen(container);
    };
    
    // æ·»åŠ èª¿æ•´å¤§å°æ‰‹æŸ„
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(position => {
      const handle = document.createElement('div');
      handle.className = `resize-handle ${position}`;
      container.appendChild(handle);
      
      // æ·»åŠ æ‹–å‹•èª¿æ•´å¤§å°åŠŸèƒ½
      makeResizable(container, handle, position);
    });
    
    // æ·»åŠ æ‹–å‹•ç§»å‹•åŠŸèƒ½
    makeDraggable(container, dragHandle);
    
    // æ·»åŠ é»æ“Šæ¿€æ´»/åœç”¨äº‹ä»¶
    container.addEventListener('click', function(e) {
      // å¦‚æœé»æ“Šçš„æ˜¯æ§åˆ¶å…ƒç´ ï¼Œä¸åˆ‡æ›æ¿€æ´»ç‹€æ…‹
      if (e.target === closeBtn || e.target === dragHandle || 
          e.target.classList.contains('resize-handle') ||
          e.target.classList.contains('fullscreen-btn')) {
        return;
      }
      container.classList.toggle('active');
    });
    
    container.appendChild(iframe);
    container.appendChild(closeBtn);
    container.appendChild(dragHandle);
    container.appendChild(indicator);
    container.appendChild(fullscreenBtn);
    document.getElementById('container').appendChild(container);
    
    console.log("ç¶²ç«™å®¹å™¨å·²æ·»åŠ åˆ°DOM");
    
    // åœ¨ç•«å¸ƒä¸Šæ·»åŠ ä¸€å€‹ä½”ä½ç¬¦çŸ©å½¢
    const rect = new fabric.Rect({
      left: parseInt(position.left),
      top: parseInt(position.top),
      width: parseInt(size.width),
      height: parseInt(size.height),
      fill: 'transparent',
      stroke: 'transparent',
      selectable: false,
      evented: false,
      mediaId: container.mediaId,
      isMediaPlaceholder: true
    });
    
    canvas.add(rect);
    canvas.requestRenderAll();
    
    // åŒæ­¥ä½”ä½ç¬¦å’Œå®¹å™¨ä½ç½®
    syncMediaWithPlaceholder(rect, container);
    
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
    
    console.log("ç¶²ç«™å®¹å™¨å‰µå»ºå®Œæˆ");
  }
  
  // æ’å…¥PDF
  function insertPDF(typedarray, filename) {
    console.log("æ’å…¥PDF:", filename);
    createPDFContainer(typedarray, filename, {left: '100px', top: '100px'}, {width: '600px', height: '400px'});
  }
  
  // å‰µå»ºPDFä½”ä½ç¬¦å®¹å™¨ï¼ˆç”¨æ–¼é é¢åˆ‡æ›æ™‚é¡¯ç¤ºï¼‰
  function createPDFPlaceholderContainer(filename, position, size, mediaId) {
    console.log("å‰µå»ºPDFä½”ä½ç¬¦å®¹å™¨:", filename, position, size, mediaId);
    
    // å‰µå»ºåª’é«”å®¹å™¨
    const container = document.createElement('div');
    container.className = 'media-container';
    container.style.left = position.left;
    container.style.top = position.top;
    container.style.width = size.width;
    container.style.height = size.height;
    
    // è¨­ç½®åª’é«”å±¬æ€§
    container.mediaId = mediaId || `pdf-${Date.now()}`;
    container.mediaType = 'pdf';
    container.filename = filename;
    
    // å‰µå»ºæç¤ºæ–‡å­—
    const placeholderDiv = document.createElement('div');
    placeholderDiv.className = 'pdf-loading';
    placeholderDiv.textContent = `PDF: ${filename || 'æœªå‘½å'}\n(åˆ‡æ›é é¢å·²æ¸…é™¤)`;
    placeholderDiv.style.whiteSpace = 'pre-line';
    placeholderDiv.style.textAlign = 'center';
    placeholderDiv.style.padding = '20px';
    
    // æ·»åŠ é—œé–‰æŒ‰éˆ•
    const closeBtn = document.createElement('div');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = 'âœ•';
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      console.log("é—œé–‰PDFå®¹å™¨:", container.mediaId);
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // æ·»åŠ æ‹–å‹•æ‰‹æŸ„
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â‹®â‹®';
    
    // æ·»åŠ æ¿€æ´»æŒ‡ç¤ºå™¨
    const indicator = document.createElement('div');
    indicator.className = 'activation-indicator';
    
    // æ·»åŠ èª¿æ•´å¤§å°æ‰‹æŸ„
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(position => {
      const handle = document.createElement('div');
      handle.className = `resize-handle ${position}`;
      container.appendChild(handle);
      
      // æ·»åŠ æ‹–å‹•èª¿æ•´å¤§å°åŠŸèƒ½
      makeResizable(container, handle, position);
    });
    
    // æ·»åŠ æ‹–å‹•ç§»å‹•åŠŸèƒ½
    makeDraggable(container, dragHandle);
    
    // æ·»åŠ é»æ“Šæ¿€æ´»/åœç”¨äº‹ä»¶
    container.addEventListener('click', function(e) {
      // å¦‚æœé»æ“Šçš„æ˜¯æ§åˆ¶å…ƒç´ ï¼Œä¸åˆ‡æ›æ¿€æ´»ç‹€æ…‹
      if (e.target === closeBtn || e.target === dragHandle || 
          e.target.classList.contains('resize-handle')) {
        return;
      }
      container.classList.toggle('active');
    });
    
    container.appendChild(placeholderDiv);
    container.appendChild(closeBtn);
    container.appendChild(dragHandle);
    container.appendChild(indicator);
    document.getElementById('container').appendChild(container);
    
    console.log("PDFä½”ä½ç¬¦å®¹å™¨å·²æ·»åŠ åˆ°DOM");
    
    // åœ¨ç•«å¸ƒä¸Šæ·»åŠ ä¸€å€‹ä½”ä½ç¬¦çŸ©å½¢
    const rect = new fabric.Rect({
      left: parseInt(position.left),
      top: parseInt(position.top),
      width: parseInt(size.width),
      height: parseInt(size.height),
      fill: 'transparent',
      stroke: 'transparent',
      selectable: false,
      evented: false,
      mediaId: container.mediaId,
      isMediaPlaceholder: true
    });
    
    canvas.add(rect);
    canvas.requestRenderAll();
    
    // åŒæ­¥ä½”ä½ç¬¦å’Œå®¹å™¨ä½ç½®
    syncMediaWithPlaceholder(rect, container);
    
    console.log("PDFä½”ä½ç¬¦å®¹å™¨å‰µå»ºå®Œæˆ");
  }
  
  // å‰µå»ºPDFå®¹å™¨
  function createPDFContainer(typedarray, filename, position, size, mediaId, pdfPageNum, pdfScale) {
    console.log("å‰µå»ºPDFå®¹å™¨:", filename, position, size, mediaId);
    
    // å‰µå»ºåª’é«”å®¹å™¨
    const container = document.createElement('div');
    container.className = 'media-container';
    container.style.left = position.left;
    container.style.top = position.top;
    container.style.width = size.width;
    container.style.height = size.height;
    
    // è¨­ç½®åª’é«”å±¬æ€§
    container.mediaId = mediaId || `pdf-${Date.now()}`;
    container.mediaType = 'pdf';
    container.pdfData = typedarray; // ä¿å­˜åŸå§‹PDFæ•¸æ“š
    container.filename = filename;
    
    console.log("PDFå®¹å™¨å±¬æ€§:", {
      id: container.mediaId,
      type: container.mediaType,
      filename: container.filename
    });
    
    // å‰µå»ºPDFæŸ¥çœ‹å™¨
    const pdfViewer = document.createElement('div');
    pdfViewer.className = 'pdf-viewer';
    
    // å‰µå»ºPDFç•«å¸ƒ
    const pdfCanvas = document.createElement('canvas');
    pdfCanvas.className = 'pdf-canvas';
    pdfViewer.appendChild(pdfCanvas);
    
    // å‰µå»ºPDFæ§åˆ¶æŒ‰éˆ•
    const pdfControls = document.createElement('div');
    pdfControls.className = 'pdf-controls';
    
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'ä¸Šä¸€é ';
    prevBtn.onclick = function() {
      if (container.pdfPageNum > 1) {
        container.pdfPageNum--;
        renderPDFPage(container.pdfDocument, container.pdfPageNum, pdfCanvas);
        saveCurrentPageMediaInfo();
      }
    };
    
    const pageLabel = document.createElement('span');
    pageLabel.textContent = 'é é¢: 1/1';
    
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'ä¸‹ä¸€é ';
    nextBtn.onclick = function() {
      if (container.pdfPageNum < container.pdfDocument.numPages) {
        container.pdfPageNum++;
        renderPDFPage(container.pdfDocument, container.pdfPageNum, pdfCanvas);
        saveCurrentPageMediaInfo();
      }
    };
    
    const zoomInBtn = document.createElement('button');
    zoomInBtn.textContent = 'æ”¾å¤§';
    zoomInBtn.onclick = function() {
      container.pdfScale *= 1.2;
      renderPDFPage(container.pdfDocument, container.pdfPageNum, pdfCanvas);
      saveCurrentPageMediaInfo();
    };
    
    const zoomOutBtn = document.createElement('button');
    zoomOutBtn.textContent = 'ç¸®å°';
    zoomOutBtn.onclick = function() {
      container.pdfScale /= 1.2;
      renderPDFPage(container.pdfDocument, container.pdfPageNum, pdfCanvas);
      saveCurrentPageMediaInfo();
    };
    
    const fullscreenBtn = document.createElement('button');
    fullscreenBtn.textContent = 'å…¨è¢å¹•';
    fullscreenBtn.onclick = function() {
      toggleFullscreen(container);
    };
    
    pdfControls.appendChild(prevBtn);
    pdfControls.appendChild(pageLabel);
    pdfControls.appendChild(nextBtn);
    pdfControls.appendChild(zoomInBtn);
    pdfControls.appendChild(zoomOutBtn);
    pdfControls.appendChild(fullscreenBtn);
    
    // æ·»åŠ é—œé–‰æŒ‰éˆ•
    const closeBtn = document.createElement('div');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = 'âœ•';
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      console.log("é—œé–‰PDFå®¹å™¨:", container.mediaId);
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // æ·»åŠ æ‹–å‹•æ‰‹æŸ„
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â‹®â‹®';
    
    // æ·»åŠ æ¿€æ´»æŒ‡ç¤ºå™¨
    const indicator = document.createElement('div');
    indicator.className = 'activation-indicator';
    
    // æ·»åŠ èª¿æ•´å¤§å°æ‰‹æŸ„
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(position => {
      const handle = document.createElement('div');
      handle.className = `resize-handle ${position}`;
      container.appendChild(handle);
      
      // æ·»åŠ æ‹–å‹•èª¿æ•´å¤§å°åŠŸèƒ½
      makeResizable(container, handle, position);
    });
    
    // æ·»åŠ æ‹–å‹•ç§»å‹•åŠŸèƒ½
    makeDraggable(container, dragHandle);
    
    // æ·»åŠ é»æ“Šæ¿€æ´»/åœç”¨äº‹ä»¶
    container.addEventListener('click', function(e) {
      // å¦‚æœé»æ“Šçš„æ˜¯æ§åˆ¶å…ƒç´ ï¼Œä¸åˆ‡æ›æ¿€æ´»ç‹€æ…‹
      if (e.target === closeBtn || e.target === dragHandle || 
          e.target.classList.contains('resize-handle') ||
          e.target.tagName === 'BUTTON') {
        return;
      }
      container.classList.toggle('active');
    });
    
    container.appendChild(pdfViewer);
    container.appendChild(pdfControls);
    container.appendChild(closeBtn);
    container.appendChild(dragHandle);
    container.appendChild(indicator);
    document.getElementById('container').appendChild(container);
    
    console.log("PDFå®¹å™¨å·²æ·»åŠ åˆ°DOM");
    
    // è¨­ç½®PDFåˆå§‹å€¼
    container.pdfScale = pdfScale || 1.0;
    container.pdfPageNum = pdfPageNum || 1;
    container.pdfPageLabel = pageLabel;
    
    // åŠ è¼‰PDFæ–‡æª”
    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
      container.pdfDocument = pdf;
      container.pdfPageLabel.textContent = `é é¢: ${container.pdfPageNum}/${pdf.numPages}`;
      renderPDFPage(pdf, container.pdfPageNum, pdfCanvas);
      console.log("PDFæ–‡æª”åŠ è¼‰å®Œæˆ:", filename);
    }).catch(function(error) {
      console.error('PDFåŠ è¼‰éŒ¯èª¤:', error);
      alert('PDFåŠ è¼‰å¤±æ•—ï¼Œè«‹ç¢ºä¿æ–‡ä»¶æ ¼å¼æ­£ç¢º');
    });
    
    // åœ¨ç•«å¸ƒä¸Šæ·»åŠ ä¸€å€‹ä½”ä½ç¬¦çŸ©å½¢
    const rect = new fabric.Rect({
      left: parseInt(position.left),
      top: parseInt(position.top),
      width: parseInt(size.width),
      height: parseInt(size.height),
      fill: 'transparent',
      stroke: 'transparent',
      selectable: false,
      evented: false,
      mediaId: container.mediaId,
      isMediaPlaceholder: true
    });
    
    canvas.add(rect);
    canvas.requestRenderAll();
    
    // åŒæ­¥ä½”ä½ç¬¦å’Œå®¹å™¨ä½ç½®
    syncMediaWithPlaceholder(rect, container);
    
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
    
    console.log("PDFå®¹å™¨å‰µå»ºå®Œæˆ");
  }
  
  // åˆªé™¤åª’é«”å®¹å™¨å’Œå°æ‡‰çš„ä½”ä½ç¬¦
  function removeMediaContainerAndPlaceholder(mediaId) {
    // æ‰¾åˆ°ä¸¦ç§»é™¤åª’é«”å®¹å™¨
    const containers = document.querySelectorAll('.media-container');
    containers.forEach(container => {
      if (container.mediaId === mediaId) {
        container.remove();
      }
    });
    
    // æ‰¾åˆ°ä¸¦ç§»é™¤å°æ‡‰çš„ä½”ä½ç¬¦
    const objects = canvas.getObjects();
    for (const obj of objects) {
      if (obj.mediaId === mediaId && obj.isMediaPlaceholder) {
        canvas.remove(obj);
        break;
      }
    }
    
    canvas.requestRenderAll();
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
  }
  
  // æ¸²æŸ“PDFé é¢
  function renderPDFPage(pdf, pageNum, canvas) {
    pdf.getPage(pageNum).then(function(page) {
      const viewport = page.getViewport({ scale: canvas.parentElement.parentElement.pdfScale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      const renderContext = {
        canvasContext: canvas.getContext('2d'),
        viewport: viewport
      };
      
      page.render(renderContext);
      
      // æ›´æ–°é é¢æ¨™ç±¤
      canvas.parentElement.parentElement.pdfPageLabel.textContent = `é é¢: ${pageNum}/${pdf.numPages}`;
    });
  }
  
  // åˆ‡æ›å…¨è¢å¹•åŠŸèƒ½
  function toggleFullscreen(container) {
    if (container.classList.contains('fullscreen')) {
      // é€€å‡ºå…¨è¢å¹•
      exitFullscreen(container);
    } else {
      // é€²å…¥å…¨è¢å¹•
      enterFullscreen(container);
    }
  }
  
  // é€²å…¥å…¨è¢å¹•
  function enterFullscreen(container) {
    // ä¿å­˜åŸå§‹ä½ç½®å’Œå¤§å°
    container.originalStyle = {
      left: container.style.left,
      top: container.style.top,
      width: container.style.width,
      height: container.style.height
    };
    
    // æ·»åŠ å…¨è¢å¹•é¡
    container.classList.add('fullscreen');
    
    // å¼·åˆ¶è¨­ç½®å…¨è¢å¹•æ¨£å¼
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100vw';
    container.style.height = '100vh';
    container.style.borderRadius = '0';
    
    // è‡ªå‹•æ¿€æ´»åª’é«”å®¹å™¨
    container.classList.add('active');
    
    // å‰µå»ºå…¨è¢å¹•é€€å‡ºæŒ‰éˆ•
    const exitBtn = document.createElement('div');
    exitBtn.className = 'fullscreen-exit-btn';
    exitBtn.innerHTML = 'âœ•';
    exitBtn.title = 'é€€å‡ºå…¨è¢å¹•';
    exitBtn.onclick = function() {
      exitFullscreen(container);
    };
    document.body.appendChild(exitBtn);
    
    // ä¿å­˜é€€å‡ºæŒ‰éˆ•å¼•ç”¨
    container.fullscreenExitBtn = exitBtn;
    
    // å¼·åˆ¶é‡æ’ï¼Œç¢ºä¿æ¨£å¼ç«‹å³æ‡‰ç”¨
    container.offsetHeight;
  }
  
  // é€€å‡ºå…¨è¢å¹•
  function exitFullscreen(container) {
    // ç§»é™¤å…¨è¢å¹•é¡
    container.classList.remove('fullscreen');
    
    // æ¢å¾©åŸå§‹ä½ç½®å’Œå¤§å°
    if (container.originalStyle) {
      container.style.position = 'absolute';
      container.style.left = container.originalStyle.left;
      container.style.top = container.originalStyle.top;
      container.style.width = container.originalStyle.width;
      container.style.height = container.originalStyle.height;
      container.style.borderRadius = '8px';
    }
    
    // ç§»é™¤å…¨è¢å¹•é€€å‡ºæŒ‰éˆ•
    if (container.fullscreenExitBtn) {
      container.fullscreenExitBtn.remove();
      container.fullscreenExitBtn = null;
    }
    
    // å¼·åˆ¶é‡æ’ï¼Œç¢ºä¿æ¨£å¼ç«‹å³æ‡‰ç”¨
    container.offsetHeight;
    
    // æ›´æ–°ä½”ä½ç¬¦
    updatePlaceholderPosition(container);
    updatePlaceholderSize(container);
    
    // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    saveCurrentPageMediaInfo();
  }
  
  // æå–YouTubeè¦–é »ID
  function extractYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }
  
  // ä½¿å…ƒç´ å¯æ‹–å‹•
  function makeDraggable(element, handle) {
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    let wasActive = false;
    
    handle.addEventListener('mousedown', startDragging);
    
    function startDragging(e) {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      initialLeft = element.offsetLeft;
      initialTop = element.offsetTop;
      
      // è¨˜éŒ„ç•¶å‰æ¿€æ´»ç‹€æ…‹
      wasActive = element.classList.contains('active');
      
      // è‡¨æ™‚ç¦ç”¨iframeäº‹ä»¶ï¼Œé˜²æ­¢å¹²æ“¾æ‹–å‹•
      if (wasActive) {
        element.classList.remove('active');
      }
      
      // é˜²æ­¢äº‹ä»¶å†’æ³¡å’Œé¸æ“‡æ–‡æœ¬
      e.preventDefault();
      e.stopPropagation();
      
      // æ·»åŠ å…¨å±€äº‹ä»¶ç›£è½å™¨
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDragging);
      
      // æé«˜z-indexç¢ºä¿åœ¨æœ€ä¸Šå±¤
      element.style.zIndex = 1000;
    }
    
    function drag(e) {
      if (!isDragging) return;
      
      // è¨ˆç®—æ–°çš„ä½ç½®
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      
      let newLeft = initialLeft + dx;
      let newTop = initialTop + dy;
      
      // é™åˆ¶åœ¨è¦–çª—å…§
      const maxLeft = window.innerWidth - element.offsetWidth;
      const maxTop = window.innerHeight - element.offsetHeight;
      
      newLeft = Math.max(0, Math.min(newLeft, maxLeft));
      newTop = Math.max(0, Math.min(newTop, maxTop));
      
      // è¨­ç½®å…ƒç´ çš„æ–°ä½ç½®
      element.style.left = newLeft + 'px';
      element.style.top = newTop + 'px';
      
      // æ›´æ–°å°æ‡‰çš„ä½”ä½ç¬¦ä½ç½®
      updatePlaceholderPosition(element);
    }
    
    function stopDragging() {
      if (!isDragging) return;
      
      isDragging = false;
      
      // ç§»é™¤å…¨å±€äº‹ä»¶ç›£è½å™¨
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDragging);
      
      // æ¢å¾©z-index
      element.style.zIndex = 100;
      
      // æ¢å¾©ä¹‹å‰çš„æ¿€æ´»ç‹€æ…‹
      if (wasActive) {
        element.classList.add('active');
      }
      
      // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
      saveCurrentPageMediaInfo();
    }
  }
  
  // ä½¿å…ƒç´ å¯èª¿æ•´å¤§å°
  function makeResizable(element, handle, position) {
    let isResizing = false;
    let startX, startY, startWidth, startHeight, startLeft, startTop;
    let wasActive = false;
    
    handle.addEventListener('mousedown', startResizing);
    
    function startResizing(e) {
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = element.offsetWidth;
      startHeight = element.offsetHeight;
      startLeft = element.offsetLeft;
      startTop = element.offsetTop;
      
      // è¨˜éŒ„ç•¶å‰æ¿€æ´»ç‹€æ…‹
      wasActive = element.classList.contains('active');
      
      // è‡¨æ™‚ç¦ç”¨iframeäº‹ä»¶ï¼Œé˜²æ­¢å¹²æ“¾èª¿æ•´å¤§å°
      if (wasActive) {
        element.classList.remove('active');
      }
      
      // é˜²æ­¢äº‹ä»¶å†’æ³¡å’Œé¸æ“‡æ–‡æœ¬
      e.preventDefault();
      e.stopPropagation();
      
      // æ·»åŠ å…¨å±€äº‹ä»¶ç›£è½å™¨
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResizing);
      
      // æé«˜z-indexç¢ºä¿åœ¨æœ€ä¸Šå±¤
      element.style.zIndex = 1000;
    }
    
    function resize(e) {
      if (!isResizing) return;
      
      // è¨ˆç®—æ–°çš„å°ºå¯¸å’Œä½ç½®
      let newWidth, newHeight, newLeft, newTop;
      
      if (position.includes('e')) {
        newWidth = startWidth + e.clientX - startX;
      } else if (position.includes('w')) {
        newWidth = startWidth - e.clientX + startX;
        newLeft = startLeft + e.clientX - startX;
      } else {
        newWidth = startWidth;
      }
      
      if (position.includes('s')) {
        newHeight = startHeight + e.clientY - startY;
      } else if (position.includes('n')) {
        newHeight = startHeight - e.clientY + startY;
        newTop = startTop + e.clientY - startY;
      } else {
        newHeight = startHeight;
      }
      
      // è¨­ç½®æœ€å°å°ºå¯¸
      newWidth = Math.max(100, newWidth);
      newHeight = Math.max(60, newHeight);
      
      // é™åˆ¶åœ¨è¦–çª—å…§
      if (newLeft !== undefined) {
        newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - newWidth));
      }
      if (newTop !== undefined) {
        newTop = Math.max(0, Math.min(newTop, window.innerHeight - newHeight));
      }
      
      // è¨­ç½®å…ƒç´ çš„æ–°å°ºå¯¸å’Œä½ç½®
      if (newWidth) element.style.width = newWidth + 'px';
      if (newHeight) element.style.height = newHeight + 'px';
      if (newLeft !== undefined) element.style.left = newLeft + 'px';
      if (newTop !== undefined) element.style.top = newTop + 'px';
      
      // æ›´æ–°å°æ‡‰çš„ä½”ä½ç¬¦å¤§å°å’Œä½ç½®
      updatePlaceholderSize(element);
    }
    
    function stopResizing() {
      if (!isResizing) return;
      
      isResizing = false;
      
      // ç§»é™¤å…¨å±€äº‹ä»¶ç›£è½å™¨
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResizing);
      
      // æ¢å¾©z-index
      element.style.zIndex = 100;
      
      // æ¢å¾©ä¹‹å‰çš„æ¿€æ´»ç‹€æ…‹
      if (wasActive) {
        element.classList.add('active');
      }
      
      // ä¿å­˜ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
      saveCurrentPageMediaInfo();
    }
  }
  
  // åŒæ­¥åª’é«”å®¹å™¨å’Œä½”ä½ç¬¦ä½ç½®
  function syncMediaWithPlaceholder(rect, container) {
    // ä¿å­˜åª’é«”IDåˆ°å®¹å™¨
    container.mediaId = rect.mediaId;
    
    // ç›£è½å®¹å™¨è®ŠåŒ–
    const observer = new MutationObserver(() => {
      updatePlaceholderPosition(container);
      updatePlaceholderSize(container);
    });
    
    observer.observe(container, {
      attributes: true,
      attributeFilter: ['style']
    });
    
    // ä¿å­˜è§€å¯Ÿå™¨å¼•ç”¨ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ™‚æ–·é–‹é€£æ¥
    container.observer = observer;
  }
  
  // æ›´æ–°ä½”ä½ç¬¦ä½ç½®
  function updatePlaceholderPosition(container) {
    const mediaId = container.mediaId;
    if (!mediaId) return;
    
    const objects = canvas.getObjects();
    for (const obj of objects) {
      if (obj.mediaId === mediaId && obj.isMediaPlaceholder) {
        obj.set({
          left: parseInt(container.style.left),
          top: parseInt(container.style.top)
        });
        canvas.requestRenderAll();
        break;
      }
    }
  }
  
  // æ›´æ–°ä½”ä½ç¬¦å¤§å°
  function updatePlaceholderSize(container) {
    const mediaId = container.mediaId;
    if (!mediaId) return;
    
    const objects = canvas.getObjects();
    for (const obj of objects) {
      if (obj.mediaId === mediaId && obj.isMediaPlaceholder) {
        obj.set({
          width: parseInt(container.style.width),
          height: parseInt(container.style.height)
        });
        canvas.requestRenderAll();
        break;
      }
    }
  }
  
  // é¡è‰²ã€ç²—ç´°ã€æ–‡å­—è¨­å®š
  let color = document.getElementById('colorPicker').value;
  let lineWidth = Number(document.getElementById('lineWidth').value);
  let textSize = Number(document.getElementById('textSize').value);
  let textColor = document.getElementById('textColor').value;
  let shapeStyle = document.getElementById('shapeStyle').value;
  document.getElementById('colorPicker').oninput = (e) => { color = e.target.value; updateToolMode(); };
  document.getElementById('lineWidth').oninput = (e) => { lineWidth = Number(e.target.value); updateToolMode(); };
  document.getElementById('textSize').onchange = (e) => { textSize = Number(e.target.value); };
  document.getElementById('textColor').oninput = (e) => { textColor = e.target.value; };
  document.getElementById('textInput').oninput = (e) => {};
  document.getElementById('shapeStyle').onchange = (e) => { shapeStyle = e.target.value; };
  
  // å·¥å…·æ¨¡å¼åˆ‡æ›èˆ‡æ»‘é¼ æŒ‡æ¨™
  function updateToolMode() {
    canvas.isDrawingMode = (currentTool === 'pen');
    if (canvas.isDrawingMode) {
      canvas.freeDrawingBrush.color = color;
      canvas.freeDrawingBrush.width = lineWidth;
      canvas.defaultCursor = 'crosshair';
    } else {
      canvas.isDrawingMode = false;
      switch(currentTool) {
        case 'select': canvas.defaultCursor = 'default'; break;
        case 'rect': canvas.defaultCursor = 'crosshair'; break;
        case 'circle': canvas.defaultCursor = 'crosshair'; break;
        case 'line': canvas.defaultCursor = 'crosshair'; break;
        case 'text': canvas.defaultCursor = 'text'; break;
        case 'img': canvas.defaultCursor = 'pointer'; break;
        case 'youtube': canvas.defaultCursor = 'pointer'; break;
        case 'website': canvas.defaultCursor = 'pointer'; break;
        case 'pdf': canvas.defaultCursor = 'pointer'; break;
        case 'export': canvas.defaultCursor = 'pointer'; break;
        case 'import': canvas.defaultCursor = 'pointer'; break;
        case 'eraser': canvas.defaultCursor = 'not-allowed'; break;
        default: canvas.defaultCursor = 'default';
      }
    }
    canvas.selection = (currentTool === 'select');
  }
  
  // ç•«å½¢ç‹€
  let shapeObj = null;
  let isDrawingShape = false;
  let origX, origY;
  canvas.on('mouse:down', function(opt){
    const pointer = canvas.getPointer(opt.e);
    if (currentTool === 'rect') {
      isDrawingShape = true;
      origX = pointer.x; origY = pointer.y;
      const isFilled = shapeStyle === 'filled';
      shapeObj = new fabric.Rect({
        left: origX, top: origY, width: 0, height: 0,
        fill: isFilled ? color : 'transparent',
        stroke: color, strokeWidth: lineWidth,
        selectable: true, cornerStyle:'circle', cornerColor:'#ffb6d5'
      });
      canvas.add(shapeObj);
    }
    if (currentTool === 'circle') {
      isDrawingShape = true;
      origX = pointer.x; origY = pointer.y;
      const isFilled = shapeStyle === 'filled';
      shapeObj = new fabric.Ellipse({
        left: origX, top: origY, rx: 0, ry: 0,
        fill: isFilled ? color : 'transparent',
        stroke: color, strokeWidth: lineWidth,
        selectable: true, cornerStyle:'circle', cornerColor:'#ffb6d5'
      });
      canvas.add(shapeObj);
    }
    if (currentTool === 'line') {
      isDrawingShape = true;
      origX = pointer.x; origY = pointer.y;
      shapeObj = new fabric.Line([origX, origY, origX, origY], {
        stroke: color, strokeWidth: lineWidth,
        selectable: true, cornerStyle:'circle', cornerColor:'#ffb6d5'
      });
      canvas.add(shapeObj);
    }
    if (currentTool === 'text') {
      const val = document.getElementById('textInput').value || "æ–‡å­—";
      const textObj = new fabric.Textbox(val, {
        left: pointer.x, top: pointer.y,
        fontSize: textSize, fill: textColor,
        fontFamily: "'Noto Sans TC', 'Comic Sans MS', Arial",
        borderColor: "#ffb6d5", cornerStyle:'circle', cornerColor:'#ffb6d5',
        editable: true
      });
      canvas.add(textObj);
      canvas.setActiveObject(textObj);
    }
    if (currentTool === 'eraser') {
      // æ©¡çš®æ“¦ï¼šé»é¸ç‰©ä»¶å¾Œåˆªé™¤
      const target = canvas.findTarget(opt.e);
      if (target) {
        canvas.remove(target);
        canvas.requestRenderAll();
      }
    }
  });
  
  canvas.on('mouse:move', function(opt){
    if (!isDrawingShape || !shapeObj) return;
    const pointer = canvas.getPointer(opt.e);
    if (currentTool === 'rect') {
      shapeObj.set({
        width: Math.abs(pointer.x - origX),
        height: Math.abs(pointer.y - origY),
        left: pointer.x < origX ? pointer.x : origX,
        top: pointer.y < origY ? pointer.y : origY
      });
      canvas.requestRenderAll();
    }
    if (currentTool === 'circle') {
      shapeObj.set({
        rx: Math.abs(pointer.x - origX)/2,
        ry: Math.abs(pointer.y - origY)/2,
        left: pointer.x < origX ? pointer.x : origX,
        top: pointer.y < origY ? pointer.y : origY
      });
      canvas.requestRenderAll();
    }
    if (currentTool === 'line') {
      shapeObj.set({
        x2: pointer.x,
        y2: pointer.y
      });
      canvas.requestRenderAll();
    }
  });
  
  canvas.on('mouse:up', function(opt){
    if (isDrawingShape && shapeObj) {
      shapeObj.setCoords();
      canvas.setActiveObject(shapeObj);
      shapeObj = null;
      isDrawingShape = false;
    }
    saveCurrentPage();
  });
  
  // æ¸…é™¤
  document.getElementById('clearBtn').onclick = () => {
    // ç§»é™¤ç•¶å‰é é¢çš„æ‰€æœ‰åª’é«”å®¹å™¨å’Œä½”ä½ç¬¦
    document.querySelectorAll('.media-container').forEach(container => {
      removeMediaContainerAndPlaceholder(container.mediaId);
    });
    
    // æ¸…é™¤ç•¶å‰é é¢çš„åª’é«”å®¹å™¨ä¿¡æ¯
    mediaContainers[currentPage] = [];
    
    canvas.clear();
    canvas.backgroundColor = '#fff9fc';
    saveCurrentPage();
  };
  
  // å„²å­˜
  document.getElementById('saveBtn').onclick = () => {
    const dataURL = canvas.toDataURL({
      format: 'png',
      quality: 1
    });
    const link = document.createElement('a');
    link.download = 'whiteboard.png';
    link.href = dataURL;
    link.click();
  };
  
  // ç‰©ä»¶å³æ™‚æ›è‰²ï¼ˆè‰²å½©é¸æ“‡å™¨ï¼‰
  document.getElementById('objColorPicker').oninput = function(e){
    const obj = canvas.getActiveObject();
    if(obj){
      const newColor = e.target.value;
      if(obj.type==='rect'||obj.type==='ellipse'||obj.type==='circle'){
        // å¦‚æœæ˜¯ç©ºå¿ƒå½¢ç‹€ï¼Œåªæ”¹è®Šé‚Šæ¡†é¡è‰²
        if(obj.fill === 'transparent') {
          obj.set('stroke', newColor);
        } else {
          obj.set('fill', newColor);
          obj.set('stroke', newColor);
        }
      }else if(obj.type==='line'){
        obj.set('stroke', newColor);
      }else if(obj.type==='textbox'||obj.type==='text'){
        obj.set('fill', newColor);
      }else if(obj.type==='path'){
        obj.set('stroke', newColor);
      }
      canvas.requestRenderAll();
      saveCurrentPage();
    }else{
      alert('è«‹å…ˆé¸å–è¦æ›è‰²çš„ç‰©ä»¶');
    }
  };
  
  // é è¨­é¸å–å·¥å…·
  setTool('select');
  
  // æ”¯æ´ç‰©ä»¶è¤‡è£½ï¼ˆCtrl+C/Vï¼‰èˆ‡åˆªé™¤ï¼ˆDeleteéµï¼‰
  document.addEventListener('keydown', function(e){
    if(e.key === 'Delete' || e.key === 'Backspace'){
      const obj = canvas.getActiveObject();
      if(obj) { 
        canvas.remove(obj); 
        canvas.discardActiveObject(); 
        canvas.requestRenderAll(); 
        saveCurrentPage(); 
      }
    }
    if(e.ctrlKey && e.key === 'c'){
      const obj = canvas.getActiveObject();
      if(obj) { canvas._clipboard = obj; }
    }
    if(e.ctrlKey && e.key === 'v'){
      if(canvas._clipboard){
        canvas._clipboard.clone(function(clonedObj){
          clonedObj.set({ left: clonedObj.left+30, top: clonedObj.top+30 });
          canvas.add(clonedObj);
          canvas.setActiveObject(clonedObj);
          canvas.requestRenderAll();
          saveCurrentPage();
        });
      }
    }
  });
  
  // æ¯æ¬¡ç‰©ä»¶æ“ä½œéƒ½å³æ™‚å„²å­˜é é¢
  canvas.on('object:added', saveCurrentPage);
  canvas.on('object:modified', saveCurrentPage);
  canvas.on('object:removed', saveCurrentPage);
</script>
</body>
</html>