<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜é›„å¸‚YouBikeå³æ™‚æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸš² é«˜é›„å¸‚YouBikeå³æ™‚æŸ¥è©¢</h1>
            <p class="text-gray-600 text-lg">å³æ™‚é¡¯ç¤ºå„ç«™é»å€Ÿç”¨æƒ…æ³ï¼Œé»æ“Šå¯æŸ¥çœ‹Googleåœ°åœ–ä½ç½®</p>
        </div>

        <!-- æ§åˆ¶å€åŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-center">
                <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                    <span id="refreshIcon">ğŸ”„</span>
                    é‡æ–°æ•´ç†
                </button>
                
                <select id="areaSelect" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">æ‰€æœ‰å€åŸŸ</option>
                </select>
                
                <select id="stationSelect" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">æ‰€æœ‰ç«™é»</option>
                </select>
                
                <select id="statusFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                    <option value="available">æœ‰è»Šå¯å€Ÿ</option>
                    <option value="low">è»Šè¼›ä¸è¶³</option>
                    <option value="empty">ç„¡è»Šå¯å€Ÿ</option>
                </select>
            </div>
        </div>

        <!-- çµ±è¨ˆæ•¸æ“šé¡¯ç¤º -->
        <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 hidden">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalStations">0</div>
                <div class="text-gray-600">ç¸½ç«™é»æ•¸</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="availableStations">0</div>
                <div class="text-gray-600">æœ‰è»Šç«™é»</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="totalBikes">0</div>
                <div class="text-gray-600">ç¸½è»Šè¼›æ•¸</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="totalSpaces">0</div>
                <div class="text-gray-600">ç¸½åœè»Šä½</div>
            </div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingContainer" class="text-center py-12">
            <div class="loading-spinner inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mb-4"></div>
            <p class="text-gray-600 text-lg">æ­£åœ¨è¼‰å…¥YouBikeè³‡æ–™...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤º -->
        <div id="errorContainer" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center">
                <span class="text-xl mr-2">âš ï¸</span>
                <div>
                    <strong>è¼‰å…¥å¤±æ•—ï¼š</strong>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>

        <!-- ç„¡çµæœé¡¯ç¤º -->
        <div id="noResultsContainer" class="hidden text-center py-12">
            <div class="text-6xl mb-4">ğŸ”</div>
            <p class="text-gray-600 text-lg">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç«™é»</p>
        </div>

        <!-- ç«™é»è³‡æ–™é¡¯ç¤º -->
        <div id="stationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        </div>
    </div>

    <script>
        let allStations = [];
        let filteredStations = [];

        // DOM å…ƒç´ 
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const areaSelect = document.getElementById('areaSelect');
        const stationSelect = document.getElementById('stationSelect');
        const statusFilter = document.getElementById('statusFilter');
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const noResultsContainer = document.getElementById('noResultsContainer');
        const stationsContainer = document.getElementById('stationsContainer');
        const statsContainer = document.getElementById('statsContainer');

        // çµ±è¨ˆå…ƒç´ 
        const totalStations = document.getElementById('totalStations');
        const availableStations = document.getElementById('availableStations');
        const totalBikes = document.getElementById('totalBikes');
        const totalSpaces = document.getElementById('totalSpaces');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadYouBikeData();
            
            // äº‹ä»¶ç›£è½å™¨
            refreshBtn.addEventListener('click', loadYouBikeData);
            areaSelect.addEventListener('change', filterStations);
            stationSelect.addEventListener('change', filterStations);
            statusFilter.addEventListener('change', filterStations);
        });

        // è¼‰å…¥YouBikeè³‡æ–™
        async function loadYouBikeData() {
            showLoading();
            
            try {
                // ä½¿ç”¨é«˜é›„å¸‚æ”¿åºœå®˜æ–¹API
                const response = await fetch('https://api.kcg.gov.tw/Api/Service/Get/b4dd9c40-9027-4125-8666-06bef1756092');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // æª¢æŸ¥APIå›æ‡‰æ ¼å¼ - æ ¹æ“šå¯¦éš›å›æ‡‰çµæ§‹èª¿æ•´
                if (!result.data || !result.data.data || !result.data.data.retVal || !Array.isArray(result.data.data.retVal)) {
                    throw new Error('APIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
                }
                
                allStations = result.data.data.retVal;
                
                if (allStations.length === 0) {
                    throw new Error('ç„¡æ³•å–å¾—é«˜é›„å¸‚YouBikeè³‡æ–™');
                }
                
                populateAreaSelect();
                populateStationSelect();
                updateStatistics();
                filterStations();
                hideLoading();
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                showError(error.message);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoading() {
            refreshIcon.style.transform = 'rotate(0deg)';
            refreshIcon.style.animation = 'spin 1s linear infinite';
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            stationsContainer.classList.add('hidden');
            noResultsContainer.classList.add('hidden');
            statsContainer.classList.add('hidden');
        }

        // éš±è—è¼‰å…¥ç‹€æ…‹
        function hideLoading() {
            refreshIcon.style.animation = 'none';
            loadingContainer.classList.add('hidden');
            statsContainer.classList.remove('hidden');
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            hideLoading();
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        // å¡«å……å€åŸŸé¸æ“‡å™¨
        function populateAreaSelect() {
            const areas = [...new Set(allStations.map(station => station.sarea))].filter(area => area).sort();
            areaSelect.innerHTML = '<option value="">æ‰€æœ‰å€åŸŸ</option>';
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });
        }

        // å¡«å……ç«™é»é¸æ“‡å™¨
        function populateStationSelect() {
            const stations = allStations.map(station => ({
                id: station.sno,
                name: station.sna
            })).sort((a, b) => a.name.localeCompare(b.name));
            
            stationSelect.innerHTML = '<option value="">æ‰€æœ‰ç«™é»</option>';
            stations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = station.name;
                stationSelect.appendChild(option);
            });
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStatistics() {
            const total = allStations.length;
            const available = allStations.filter(station => parseInt(station.sbi) > 0).length;
            const bikes = allStations.reduce((sum, station) => sum + parseInt(station.sbi || 0), 0);
            const spaces = allStations.reduce((sum, station) => sum + parseInt(station.bemp || 0), 0);

            totalStations.textContent = total;
            availableStations.textContent = available;
            totalBikes.textContent = bikes;
            totalSpaces.textContent = spaces;
        }

        // ç¯©é¸ç«™é»
        function filterStations() {
            const selectedArea = areaSelect.value;
            const selectedStation = stationSelect.value;
            const selectedStatus = statusFilter.value;

            filteredStations = allStations.filter(station => {
                // å€åŸŸç¯©é¸
                if (selectedArea && station.sarea !== selectedArea) return false;
                
                // ç«™é»ç¯©é¸
                if (selectedStation && station.sno !== selectedStation) return false;
                
                // ç‹€æ…‹ç¯©é¸
                if (selectedStatus) {
                    const availableBikes = parseInt(station.sbi || 0);
                    switch (selectedStatus) {
                        case 'available':
                            if (availableBikes === 0) return false;
                            break;
                        case 'low':
                            if (availableBikes === 0 || availableBikes > 3) return false;
                            break;
                        case 'empty':
                            if (availableBikes > 0) return false;
                            break;
                    }
                }
                
                return true;
            });

            displayStations();
        }

        // é¡¯ç¤ºç«™é»
        function displayStations() {
            if (filteredStations.length === 0) {
                stationsContainer.classList.add('hidden');
                noResultsContainer.classList.remove('hidden');
                return;
            }

            noResultsContainer.classList.add('hidden');
            stationsContainer.classList.remove('hidden');
            
            stationsContainer.innerHTML = '';
            
            filteredStations.forEach(station => {
                const stationCard = createStationCard(station);
                stationsContainer.appendChild(stationCard);
            });
        }

        // å»ºç«‹ç«™é»å¡ç‰‡
        function createStationCard(station) {
            const availableBikes = parseInt(station.sbi || 0);
            const emptySpaces = parseInt(station.bemp || 0);
            
            // æ±ºå®šç‹€æ…‹é¡è‰²
            let statusColor, statusText, statusBg;
            if (availableBikes === 0) {
                statusColor = 'text-red-600';
                statusText = 'ç„¡è»Šå¯å€Ÿ';
                statusBg = 'bg-red-50 border-red-200';
            } else if (availableBikes <= 3) {
                statusColor = 'text-orange-600';
                statusText = 'è»Šè¼›ä¸è¶³';
                statusBg = 'bg-orange-50 border-orange-200';
            } else {
                statusColor = 'text-green-600';
                statusText = 'æœ‰è»Šå¯å€Ÿ';
                statusBg = 'bg-green-50 border-green-200';
            }

            const card = document.createElement('div');
            card.className = `bg-white rounded-lg shadow-md border-2 ${statusBg} card-hover fade-in`;
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex-1">${station.sna || 'æœªçŸ¥ç«™é»'}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor} bg-white border">
                            ${statusText}
                        </span>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4">${station.ar || 'åœ°å€æœªæä¾›'}</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold ${statusColor}">${availableBikes}</div>
                            <div class="text-xs text-gray-500">å¯å€Ÿè»Šè¼›</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${emptySpaces}</div>
                            <div class="text-xs text-gray-500">å¯åœç©ºä½</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openGoogleMaps(${station.lat || 0}, ${station.lng || 0})" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200">
                            ğŸ“ åœ°åœ–ä½ç½®
                        </button>
                        <button onclick="showStationDetails('${station.sno}')" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200">
                            â„¹ï¸ è©³ç´°è³‡è¨Š
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // é–‹å•ŸGoogleåœ°åœ–
        function openGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // é¡¯ç¤ºç«™é»è©³ç´°è³‡è¨Š
        function showStationDetails(stationNo) {
            const station = allStations.find(s => s.sno === stationNo);
            if (!station) return;
            
            const availableBikes = parseInt(station.sbi || 0);
            const emptySpaces = parseInt(station.bemp || 0);
            const totalSpaces = availableBikes + emptySpaces;
            
            const details = `
ç«™é»åç¨±ï¼š${station.sna || 'æœªçŸ¥ç«™é»'}
ç«™é»ç·¨è™Ÿï¼š${station.sno || 'æœªçŸ¥'}
æ‰€åœ¨å€åŸŸï¼š${station.sarea || 'æœªçŸ¥å€åŸŸ'}
è©³ç´°åœ°å€ï¼š${station.ar || 'åœ°å€æœªæä¾›'}
å¯å€Ÿè»Šè¼›ï¼š${availableBikes} è¼›
å¯åœç©ºä½ï¼š${emptySpaces} ä½
ç¸½åœè»Šä½ï¼š${totalSpaces} ä½
ç‡Ÿé‹ç‹€æ…‹ï¼š${station.act === '1' ? 'ç‡Ÿé‹ä¸­' : 'æš«åœç‡Ÿé‹'}
æ›´æ–°æ™‚é–“ï¼š${station.mday ? new Date(station.mday).toLocaleString('zh-TW') : 'æœªçŸ¥'}
            `;
            
            alert(details);
        }
    </script>
</body>
</html>
