<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄市YouBike即時查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 標題區域 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">🚲 高雄市YouBike即時查詢</h1>
            <p class="text-gray-600 text-lg">即時顯示各站點借用情況，點擊可查看Google地圖位置</p>
        </div>

        <!-- 控制區域 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-center">
                <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                    <span id="refreshIcon">🔄</span>
                    重新整理
                </button>
                
                <select id="areaSelect" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">所有區域</option>
                </select>
                
                <select id="stationSelect" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">所有站點</option>
                </select>
                
                <select id="statusFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">所有狀態</option>
                    <option value="available">有車可借</option>
                    <option value="low">車輛不足</option>
                    <option value="empty">無車可借</option>
                </select>
            </div>
        </div>

        <!-- 統計數據顯示 -->
        <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 hidden">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalStations">0</div>
                <div class="text-gray-600">總站點數</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="availableStations">0</div>
                <div class="text-gray-600">有車站點</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="totalBikes">0</div>
                <div class="text-gray-600">總車輛數</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="totalSpaces">0</div>
                <div class="text-gray-600">總停車位</div>
            </div>
        </div>

        <!-- 載入狀態 -->
        <div id="loadingContainer" class="text-center py-12">
            <div class="loading-spinner inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mb-4"></div>
            <p class="text-gray-600 text-lg">正在載入YouBike資料...</p>
        </div>

        <!-- 錯誤訊息顯示 -->
        <div id="errorContainer" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center">
                <span class="text-xl mr-2">⚠️</span>
                <div>
                    <strong>載入失敗：</strong>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>

        <!-- 無結果顯示 -->
        <div id="noResultsContainer" class="hidden text-center py-12">
            <div class="text-6xl mb-4">🔍</div>
            <p class="text-gray-600 text-lg">找不到符合條件的站點</p>
        </div>

        <!-- 站點資料顯示 -->
        <div id="stationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        </div>
    </div>

    <script>
        let allStations = [];
        let filteredStations = [];

        // DOM 元素
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const areaSelect = document.getElementById('areaSelect');
        const stationSelect = document.getElementById('stationSelect');
        const statusFilter = document.getElementById('statusFilter');
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const noResultsContainer = document.getElementById('noResultsContainer');
        const stationsContainer = document.getElementById('stationsContainer');
        const statsContainer = document.getElementById('statsContainer');

        // 統計元素
        const totalStations = document.getElementById('totalStations');
        const availableStations = document.getElementById('availableStations');
        const totalBikes = document.getElementById('totalBikes');
        const totalSpaces = document.getElementById('totalSpaces');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadYouBikeData();
            
            // 事件監聽器
            refreshBtn.addEventListener('click', loadYouBikeData);
            areaSelect.addEventListener('change', filterStations);
            stationSelect.addEventListener('change', filterStations);
            statusFilter.addEventListener('change', filterStations);
        });

        // 載入YouBike資料
        async function loadYouBikeData() {
            showLoading();
            
            try {
                // 使用高雄市政府官方API
                const response = await fetch('https://api.kcg.gov.tw/Api/Service/Get/b4dd9c40-9027-4125-8666-06bef1756092');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // 檢查API回應格式 - 根據實際回應結構調整
                if (!result.data || !result.data.data || !result.data.data.retVal || !Array.isArray(result.data.data.retVal)) {
                    throw new Error('API回應格式不正確');
                }
                
                allStations = result.data.data.retVal;
                
                if (allStations.length === 0) {
                    throw new Error('無法取得高雄市YouBike資料');
                }
                
                populateAreaSelect();
                populateStationSelect();
                updateStatistics();
                filterStations();
                hideLoading();
                
            } catch (error) {
                console.error('載入資料失敗:', error);
                showError(error.message);
            }
        }

        // 顯示載入狀態
        function showLoading() {
            refreshIcon.style.transform = 'rotate(0deg)';
            refreshIcon.style.animation = 'spin 1s linear infinite';
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            stationsContainer.classList.add('hidden');
            noResultsContainer.classList.add('hidden');
            statsContainer.classList.add('hidden');
        }

        // 隱藏載入狀態
        function hideLoading() {
            refreshIcon.style.animation = 'none';
            loadingContainer.classList.add('hidden');
            statsContainer.classList.remove('hidden');
        }

        // 顯示錯誤
        function showError(message) {
            hideLoading();
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        // 填充區域選擇器
        function populateAreaSelect() {
            const areas = [...new Set(allStations.map(station => station.sarea))].filter(area => area).sort();
            areaSelect.innerHTML = '<option value="">所有區域</option>';
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });
        }

        // 填充站點選擇器
        function populateStationSelect() {
            const stations = allStations.map(station => ({
                id: station.sno,
                name: station.sna
            })).sort((a, b) => a.name.localeCompare(b.name));
            
            stationSelect.innerHTML = '<option value="">所有站點</option>';
            stations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = station.name;
                stationSelect.appendChild(option);
            });
        }

        // 更新統計資料
        function updateStatistics() {
            const total = allStations.length;
            const available = allStations.filter(station => parseInt(station.sbi) > 0).length;
            const bikes = allStations.reduce((sum, station) => sum + parseInt(station.sbi || 0), 0);
            const spaces = allStations.reduce((sum, station) => sum + parseInt(station.bemp || 0), 0);

            totalStations.textContent = total;
            availableStations.textContent = available;
            totalBikes.textContent = bikes;
            totalSpaces.textContent = spaces;
        }

        // 篩選站點
        function filterStations() {
            const selectedArea = areaSelect.value;
            const selectedStation = stationSelect.value;
            const selectedStatus = statusFilter.value;

            filteredStations = allStations.filter(station => {
                // 區域篩選
                if (selectedArea && station.sarea !== selectedArea) return false;
                
                // 站點篩選
                if (selectedStation && station.sno !== selectedStation) return false;
                
                // 狀態篩選
                if (selectedStatus) {
                    const availableBikes = parseInt(station.sbi || 0);
                    switch (selectedStatus) {
                        case 'available':
                            if (availableBikes === 0) return false;
                            break;
                        case 'low':
                            if (availableBikes === 0 || availableBikes > 3) return false;
                            break;
                        case 'empty':
                            if (availableBikes > 0) return false;
                            break;
                    }
                }
                
                return true;
            });

            displayStations();
        }

        // 顯示站點
        function displayStations() {
            if (filteredStations.length === 0) {
                stationsContainer.classList.add('hidden');
                noResultsContainer.classList.remove('hidden');
                return;
            }

            noResultsContainer.classList.add('hidden');
            stationsContainer.classList.remove('hidden');
            
            stationsContainer.innerHTML = '';
            
            filteredStations.forEach(station => {
                const stationCard = createStationCard(station);
                stationsContainer.appendChild(stationCard);
            });
        }

        // 建立站點卡片
        function createStationCard(station) {
            const availableBikes = parseInt(station.sbi || 0);
            const emptySpaces = parseInt(station.bemp || 0);
            
            // 決定狀態顏色
            let statusColor, statusText, statusBg;
            if (availableBikes === 0) {
                statusColor = 'text-red-600';
                statusText = '無車可借';
                statusBg = 'bg-red-50 border-red-200';
            } else if (availableBikes <= 3) {
                statusColor = 'text-orange-600';
                statusText = '車輛不足';
                statusBg = 'bg-orange-50 border-orange-200';
            } else {
                statusColor = 'text-green-600';
                statusText = '有車可借';
                statusBg = 'bg-green-50 border-green-200';
            }

            const card = document.createElement('div');
            card.className = `bg-white rounded-lg shadow-md border-2 ${statusBg} card-hover fade-in`;
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex-1">${station.sna || '未知站點'}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor} bg-white border">
                            ${statusText}
                        </span>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4">${station.ar || '地址未提供'}</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold ${statusColor}">${availableBikes}</div>
                            <div class="text-xs text-gray-500">可借車輛</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${emptySpaces}</div>
                            <div class="text-xs text-gray-500">可停空位</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openGoogleMaps(${station.lat || 0}, ${station.lng || 0})" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200">
                            📍 地圖位置
                        </button>
                        <button onclick="showStationDetails('${station.sno}')" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200">
                            ℹ️ 詳細資訊
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // 開啟Google地圖
        function openGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // 顯示站點詳細資訊
        function showStationDetails(stationNo) {
            const station = allStations.find(s => s.sno === stationNo);
            if (!station) return;
            
            const availableBikes = parseInt(station.sbi || 0);
            const emptySpaces = parseInt(station.bemp || 0);
            const totalSpaces = availableBikes + emptySpaces;
            
            const details = `
站點名稱：${station.sna || '未知站點'}
站點編號：${station.sno || '未知'}
所在區域：${station.sarea || '未知區域'}
詳細地址：${station.ar || '地址未提供'}
可借車輛：${availableBikes} 輛
可停空位：${emptySpaces} 位
總停車位：${totalSpaces} 位
營運狀態：${station.act === '1' ? '營運中' : '暫停營運'}
更新時間：${station.mday ? new Date(station.mday).toLocaleString('zh-TW') : '未知'}
            `;
            
            alert(details);
        }
    </script>
</body>
</html>
